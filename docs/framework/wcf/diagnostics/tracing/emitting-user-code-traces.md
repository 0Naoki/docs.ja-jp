---
title: "ユーザー コード トレースの出力"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: fa54186a-8ffa-4332-b0e7-63867126fd49
caps.latest.revision: "9"
author: dotnet-bot
ms.author: dotnetcontent
manager: wpickett
ms.workload: dotnet
ms.openlocfilehash: a71ab8d8b4f96900e6d0f83541b6ae17f09ddeee
ms.sourcegitcommit: 16186c34a957fdd52e5db7294f291f7530ac9d24
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/22/2017
---
# <a name="emitting-user-code-traces"></a><span data-ttu-id="12f6d-102">ユーザー コード トレースの出力</span><span class="sxs-lookup"><span data-stu-id="12f6d-102">Emitting User-Code Traces</span></span>
<span data-ttu-id="12f6d-103">[!INCLUDE[indigo1](../../../../../includes/indigo1-md.md)] により生成されるインストルメンテーション データを収集するには、構成内でトレースを有効にする方法に加えて、ユーザー コードのプログラムによりトレースを出力することもできます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-103">In addition to enabling tracing in configuration to collect instrumentation data generated by [!INCLUDE[indigo1](../../../../../includes/indigo1-md.md)], you can also emit traces programmatically in user code.</span></span> <span data-ttu-id="12f6d-104">この方法では、インストルメンテーション データを能動的に作成でき、後でそのデータを診断目的で詳細に調べることができます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-104">In this way, you can proactively create instrumentation data that you can peruse later for diagnostic purpose.</span></span> <span data-ttu-id="12f6d-105">ここでは、この方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-105">This topic discusses how you can do this.</span></span>  
  
 <span data-ttu-id="12f6d-106">さらに、[トレースを拡張する](../../../../../docs/framework/wcf/samples/extending-tracing.md)サンプルには、次のセクションに示されているすべてのコードが含まれています。</span><span class="sxs-lookup"><span data-stu-id="12f6d-106">In addition, the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample includes all the code demonstrated in the following sections.</span></span>  
  
## <a name="creating-a-trace-source"></a><span data-ttu-id="12f6d-107">トレース ソースの作成</span><span class="sxs-lookup"><span data-stu-id="12f6d-107">Creating a Trace Source</span></span>  
 <span data-ttu-id="12f6d-108">ユーザー トレース ソースを作成するには、次のコードを使用できます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-108">You can use the following code to create a user trace source.</span></span>  
  
```  
TraceSource ts = new TraceSource("myUserTraceSource");  
```  
  
## <a name="creating-activities"></a><span data-ttu-id="12f6d-109">アクティビティの作成</span><span class="sxs-lookup"><span data-stu-id="12f6d-109">Creating Activities</span></span>  
 <span data-ttu-id="12f6d-110">アクティビティは論理的な処理単位です。</span><span class="sxs-lookup"><span data-stu-id="12f6d-110">Activities are logical unit of processing.</span></span> <span data-ttu-id="12f6d-111">トレースをグループ化する主要な処理単位ごとに 1 つのアクティビティを作成できます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-111">You can create one activity for each major processing unit in which you want traces to be grouped together.</span></span> <span data-ttu-id="12f6d-112">たとえば、サービスの要求ごとに 1 つのアクティビティを作成できます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-112">For example, you can create one activity for each request to the service.</span></span> <span data-ttu-id="12f6d-113">これを行うには、次の手順を実行します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-113">To do so, perform the following steps.</span></span>  
  
1.  <span data-ttu-id="12f6d-114">スコープでアクティブ ID を保存します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-114">Save the activity ID in scope.</span></span>  
  
2.  <span data-ttu-id="12f6d-115">新しいアクティビティ ID を作成します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-115">Create a new activity ID.</span></span>  
  
3.  <span data-ttu-id="12f6d-116">スコープ内のアクティビティから新しいアクティビティに移り、スコープ内に新しいアクティビティを設定し、そのアクティビティの Start トレースを出力します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-116">Transfer from the activity in scope to the new one, set the new activity in scope and emit a start trace for that activity.</span></span>  
  
 <span data-ttu-id="12f6d-117">次のコードでは、この設定方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-117">The following code demonstrates how to do this.</span></span>  
  
```  
Guid oldID = Trace.CorrelationManager.ActivityId;  
Guid traceID = Guid.NewGuid();  
ts.TraceTransfer(0, "transfer", traceID);  
Trace.CorrelationManager.ActivityId = traceID; // Trace is static  
ts.TraceEvent(TraceEventType.Start, 0, "Add request");  
```  
  
## <a name="emitting-traces-within-a-user-activity"></a><span data-ttu-id="12f6d-118">ユーザー アクティビティ内でのトレースの出力</span><span class="sxs-lookup"><span data-stu-id="12f6d-118">Emitting Traces within a User Activity</span></span>  
 <span data-ttu-id="12f6d-119">ユーザー アクティビティ内でトレースを出力するコードを次に示します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-119">The following code emits traces within a user activity.</span></span>  
  
```  
double value1 = 100.00D;  
double value2 = 15.99D;  
ts.TraceInformation("Client sends message to Add " + value1 + ", " + value2);  
double result = client.Add(value1, value2);  
ts.TraceInformation("Client receives Add response '" + result + "'");  
```  
  
## <a name="stopping-the-activities"></a><span data-ttu-id="12f6d-120">アクティビティの停止</span><span class="sxs-lookup"><span data-stu-id="12f6d-120">Stopping the Activities</span></span>  
 <span data-ttu-id="12f6d-121">アクティビティを停止するには、旧アクティビティに戻り、現在のアクティビティ ID を停止して、スコープで旧アクティビティをリセットします。</span><span class="sxs-lookup"><span data-stu-id="12f6d-121">To stop the activities, transfer back to the old activity, stop the current activity id, and reset the old activity id in scope.</span></span>  
  
 <span data-ttu-id="12f6d-122">次のコードでは、この設定方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-122">The following code demonstrates how to do this.</span></span>  
  
```  
ts.TraceTransfer(0, "transfer", oldID);  
ts.TraceEvent(TraceEventType.Stop, 0, "Add request");  
Trace.CorrelationManager.ActivityId = oldID;  
```  
  
## <a name="propagating-the-activity-id-to-a-service"></a><span data-ttu-id="12f6d-123">サービスへのアクティビティ ID の伝達</span><span class="sxs-lookup"><span data-stu-id="12f6d-123">Propagating the Activity ID to A Service</span></span>  
 <span data-ttu-id="12f6d-124">クライアントとサービスの両方の構成ファイルで、`propagateActivity` トレース ソースの `true` 属性を `System.ServiceModel` に設定した場合、Add 要求に対するサービス処理は、クライアントに定義されたものと同じアクティビティで発生します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-124">If you set the `propagateActivity` attribute to `true` for the `System.ServiceModel` trace source in both the client and service configuration files, the service processing for the Add request occurs in the same activity as the one defined in the client.</span></span> <span data-ttu-id="12f6d-125">サービスに独自のアクティビティと転送が定義されている場合、そのサービス トレースは、クライアントにより伝達されたアクティビティには表示されません。</span><span class="sxs-lookup"><span data-stu-id="12f6d-125">If the service defines its own activities and transfers, the service traces do not appear in the client-propagated activity.</span></span> <span data-ttu-id="12f6d-126">その代わり、クライアントから ID が伝達されたアクティビティに、転送トレースにより、関連付けられたアクティビティにサービス トレースが表示されます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-126">Instead, they appear in an activity correlated by transfer traces to the activity whose ID is propagated by the client.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="12f6d-127">`propagateActivity` 属性がクライアントとサービスの両方で `true` に設定されている場合、[!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] によりサービスの操作スコープ内のアンビエント アクティビティが設定されます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-127">If the `propagateActivity` attribute is set to `true` on both the client and service, the ambient activity in the operation scope of the service is set by [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)].</span></span>  
  
 <span data-ttu-id="12f6d-128">次のコードを使用して、アクティビティが [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] によってスコープ内に設定されたかどうかをチェックできます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-128">You can use the following code to check whether an activity was set in scope by [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)].</span></span>  
  
```  
// Check if an activity was set in scope by WCF, if it was   
// propagated from the client. If not, ( ambient activity is   
// equal to Guid.Empty), create a new one.  
if(Trace.CorrelationManager.ActivityId == Guid.Empty)  
{  
    Guid newGuid = Guid.NewGuid();  
    Trace.CorrelationManager.ActivityId = newGuid;  
}  
// Emit your Start trace.  
ts.TraceEvent(TraceEventType.Start, 0, "Add Activity");  
  
// Emit the processing traces for that request.  
serviceTs.TraceInformation("Service receives Add "   
                            + n1 + ", " + n2);  
// double result = n1 + n2;  
serviceTs.TraceInformation("Service sends Add result" + result);  
  
// Emit the Stop trace and exit the method scope.  
ts.TraceEvent(TraceEventType.Stop, 0, "Add Activity");  
// return result;  
```  
  
## <a name="tracing-exceptions-thrown-in-code"></a><span data-ttu-id="12f6d-129">コード内でスローされる例外のトレース</span><span class="sxs-lookup"><span data-stu-id="12f6d-129">Tracing Exceptions Thrown in Code</span></span>  
 <span data-ttu-id="12f6d-130">コード内で例外をスローする場合、次のコードを使用して警告以上のレベルでその例外をトレースすることもできます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-130">When you throw an exception in code, you can also trace the exception at Warning level or up using the following code.</span></span>  
  
```  
ts.TraceEvent(TraceEventType.Warning, 0, "Throwing exception " + "exceptionMessage");  
```  
  
## <a name="viewing-user-traces-in-the-service-trace-viewer-tool"></a><span data-ttu-id="12f6d-131">サービス トレース ビューアー ツールでのユーザー トレースの表示</span><span class="sxs-lookup"><span data-stu-id="12f6d-131">Viewing User Traces in the Service Trace Viewer Tool</span></span>  
 <span data-ttu-id="12f6d-132">このセクションを実行して生成されたトレースのスクリーン ショットが含まれています、[トレースを拡張する](../../../../../docs/framework/wcf/samples/extending-tracing.md)を使用して表示するときに、サンプリング、[サービス トレース ビューアー ツール (SvcTraceViewer.exe)](../../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md)です。</span><span class="sxs-lookup"><span data-stu-id="12f6d-132">This section contains screenshots of traces generated by running the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../../../../docs/framework/wcf/service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>  
  
 <span data-ttu-id="12f6d-133">次の図では、以前作成した「Add 要求」アクティビティが左側のパネルで選択されます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-133">In the following diagram, the "Add request" activity created previously is selected on the left panel.</span></span> <span data-ttu-id="12f6d-134">アプリケーション クライアント プログラムを構成する他の 3 つの算術演算アクティビティ (Divide、Subtract、Multiply) も表示されています。</span><span class="sxs-lookup"><span data-stu-id="12f6d-134">It is listed with three other Math operation activities (Divide, Subtract, Multiply) that constitute the application client program.</span></span> <span data-ttu-id="12f6d-135">どの要求でどのようなエラーが発生したかを明確にするため、ユーザー コードでは、操作ごとに新しいアクティビティが 1 つ定義されています。</span><span class="sxs-lookup"><span data-stu-id="12f6d-135">The user code has defined one new activity for each operation to isolate potential error occurrences in different requests.</span></span>  
  
 <span data-ttu-id="12f6d-136">転送の使用を示すために、[トレースを拡張する](../../../../../docs/framework/wcf/samples/extending-tracing.md)サンプルについては、次の 4 つの操作要求をカプセル化する Calculator アクティビティも作成します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-136">To demonstrate the use of transfers in the [Extending Tracing](../../../../../docs/framework/wcf/samples/extending-tracing.md) sample, a Calculator activity that encapsulates the four operation requests is also created.</span></span> <span data-ttu-id="12f6d-137">要求があるたびに、Calculator アクティビティから該当する要求のアクティビティへ、または該当する要求のアクティビティから Calculator アクティビティへ移転します (図の右上のパネルにトレースが表示されています)。</span><span class="sxs-lookup"><span data-stu-id="12f6d-137">For each request, there is a transfer back and forth from the Calculator activity to the request activity (trace is highlighted in the upper right panel in the figure).</span></span>  
  
 <span data-ttu-id="12f6d-138">左のパネルでアクティビティを選択すると、そのアクティビティによって追加されたトレースが右上のパネルに表示されます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-138">When you select an activity on the left panel, the traces included by this activity are shown on the upper right panel.</span></span> <span data-ttu-id="12f6d-139">場合`propagateActivity`は`true`要求に参加しているすべてのプロセスからトレースの要求アクティビティでは、要求パス内の各エンドポイントでします。</span><span class="sxs-lookup"><span data-stu-id="12f6d-139">If `propagateActivity` is `true` at every endpoint in the request path, traces in the request activity are from all processes that participate in the request.</span></span> <span data-ttu-id="12f6d-140">このサンプルでは、クライアントおよびサービスからのトレースをパネルの 4 番目の列で参照できます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-140">In this example, you can see traces from both the client and service in the 4th column in the panel.</span></span>  
  
 <span data-ttu-id="12f6d-141">このアクティビティは次の順序で処理を行います。</span><span class="sxs-lookup"><span data-stu-id="12f6d-141">This activity shows the following order of processing:</span></span>  
  
1.  <span data-ttu-id="12f6d-142">クライアントはメッセージを Add に送信します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-142">Client sends message to Add.</span></span>  
  
2.  <span data-ttu-id="12f6d-143">サービスは Add 要求メッセージを受信します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-143">Service receives Add request message.</span></span>  
  
3.  <span data-ttu-id="12f6d-144">サービスは Add 応答を送信します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-144">Service sends Add response.</span></span>  
  
4.  <span data-ttu-id="12f6d-145">クライアントは Add 応答を受信します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-145">Client receives Add response.</span></span>  
  
 <span data-ttu-id="12f6d-146">これらすべてのトレースは、Information レベルで出力されています。</span><span class="sxs-lookup"><span data-stu-id="12f6d-146">All these traces were emitted at Information level.</span></span> <span data-ttu-id="12f6d-147">右上のパネルでトレースをクリックすると、トレースの詳細が右下のパネルに表示されます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-147">Clicking a trace in the upper-right panel shows the details of that trace in the lower-right panel.</span></span>  
  
 <span data-ttu-id="12f6d-148">次の図には、Calculator アクティビティと要求アクティビティ間の転送トレースに加え、1 つの要求アクティビティについて Start トレースと Stop トレースが 2 組表示されています。1 組はクライアントのトレースで、もう 1 組はサーバーのトレースです (各トレース ソースにつき 1 組)。</span><span class="sxs-lookup"><span data-stu-id="12f6d-148">In the following diagram, we also see transfer traces from and to the Calculator activity, as well as two pairs of Start and Stop traces per request activity, one for the client and one for the service (one for each trace source).</span></span>  
  
 <span data-ttu-id="12f6d-149">![コードのトレースのトレース ビューアー: 出力ユーザー &#45;](../../../../../docs/framework/wcf/diagnostics/tracing/media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd")</span><span class="sxs-lookup"><span data-stu-id="12f6d-149">![Trace Viewer: Emitting User&#45;code traces](../../../../../docs/framework/wcf/diagnostics/tracing/media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd")</span></span>  
<span data-ttu-id="12f6d-150">作成時刻によるアクティビティのリスト (左のパネル)、および入れ子にされたアクティビティ (右上のパネル)</span><span class="sxs-lookup"><span data-stu-id="12f6d-150">List of activities by creation time (left panel) and their nested activities (upper-right panel)</span></span>  
  
 <span data-ttu-id="12f6d-151">クライアントがスローする原因となる例外を、サービス コードがスローする場合 (たとえば、クライアントが要求に対する応答を取得できなかった場合など)、直接的な相関関係を示すために、サービスとクライアントの両方の警告メッセージまたはエラー メッセージは、同じアクティビティ内に発生します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-151">If the service code throws an exception that causes the client to throw as well (for example, when the client did not get the response to its request), both the service and client warning or error messages occur in the same activity for direct correlation.</span></span> <span data-ttu-id="12f6d-152">次の図で、サービスは「サービスの退出をユーザー コードでは、この要求を処理します」という例外をスローします。</span><span class="sxs-lookup"><span data-stu-id="12f6d-152">In the following diagram, the service throws an exception that states "The service refuses to process this request in user code."</span></span> <span data-ttu-id="12f6d-153">クライアントは、「サーバーでした内部エラーのため要求を処理できません。」という例外もがスローされます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-153">The client also throws an exception that states "The server was unable to process the request due to an internal error."</span></span>  
  
 <span data-ttu-id="12f6d-154">![ユーザー &#45; を出力するトレース ビューアーを使用したコードをトレース](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace2.gif "e2eTrace2")</span><span class="sxs-lookup"><span data-stu-id="12f6d-154">![Using Trace Viewer to emit user&#45;code traces](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace2.gif "e2eTrace2")</span></span>  
<span data-ttu-id="12f6d-155">要求アクティビティ ID が伝達された場合、どのエンドポイントで発生したかにかかわらず、その要求に関するすべてのエラーが同じアクティビティに表示されます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-155">Errors across endpoints for a given request appear in the same activity if the request activity id was propagated</span></span>  
  
 <span data-ttu-id="12f6d-156">左パネルの Multiply アクティビティをダブルクリックすると、次のグラフが表示されます。関連するプロセスごとの Multiply アクティビティに対するトレースが示されます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-156">Double-clicking the Multiply activity on the left panel shows the following graph, with the traces for the Multiply activity for each process involved.</span></span> <span data-ttu-id="12f6d-157">まずサービスで発生した警告 (スローされた例外) が表示され、それに続いて、要求を処理できなかったために発生したクライアントの警告とエラーが表示されます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-157">We can see a warning first occurred at the service (exception thrown), which is followed by warnings and errors on the client because the request could not be processed.</span></span> <span data-ttu-id="12f6d-158">したがって、エンドポイント間のエラーの因果関係が示され、エラーの根本原因を導き出すことができます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-158">Therefore, we can imply the causal error relationship between endpoints and derive the root cause of the error.</span></span>  
  
 <span data-ttu-id="12f6d-159">![ユーザー &#45; を出力するトレース ビューアーを使用したコードをトレース](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace3.gif "e2eTrace3")</span><span class="sxs-lookup"><span data-stu-id="12f6d-159">![Using Trace Viewer to emit user&#45;code traces](../../../../../docs/framework/wcf/diagnostics/tracing/media/e2etrace3.gif "e2eTrace3")</span></span>  
<span data-ttu-id="12f6d-160">エラーの相関関係のグラフ表示</span><span class="sxs-lookup"><span data-stu-id="12f6d-160">Graph view of error correlation</span></span>  
  
 <span data-ttu-id="12f6d-161">以前のトレースを取得するには、ユーザー トレース ソースに対して `ActivityTracing` を設定し、`propagateActivity=true` トレース ソースに対して `System.ServiceModel` を設定します。</span><span class="sxs-lookup"><span data-stu-id="12f6d-161">To obtain the previous traces, we set `ActivityTracing` for the user trace sources and `propagateActivity=true` for the `System.ServiceModel` trace source.</span></span> <span data-ttu-id="12f6d-162">ユーザー コード間のアクティビティの伝達を有効にするため、`ActivityTracing` トレース ソースの `System.ServiceModel` は設定されていません </span><span class="sxs-lookup"><span data-stu-id="12f6d-162">We did not set `ActivityTracing` for the `System.ServiceModel` trace source to enable user code to user code activity propagation.</span></span> <span data-ttu-id="12f6d-163">(ServiceModel アクティビティがオンになっている場合、クライアントに定義されているアクティビティ ID がサービス ユーザー コードにまで伝達されることはありません。ただし、転送は、クライアントおよびサービスのユーザー コード アクティビティと、中間の [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] アクティビティを相互に関連付けます)。</span><span class="sxs-lookup"><span data-stu-id="12f6d-163">(When ServiceModel activity tracing is on, the activity ID defined in the client is not propagated all the way to the service user code; Transfers, however, correlate the client and service user code activities to the intermediate [!INCLUDE[indigo2](../../../../../includes/indigo2-md.md)] activities.)</span></span>  
  
 <span data-ttu-id="12f6d-164">アクティビティを定義してアクティビティ ID を伝達することにより、エンドポイント間でエラーの直接相関関係を実行できます。</span><span class="sxs-lookup"><span data-stu-id="12f6d-164">Defining activities and propagating the activity ID enables us to perform direct error correlation across endpoints.</span></span> <span data-ttu-id="12f6d-165">このようにして、エラーの根本原因をよりすばやく見つけることができるようになります。</span><span class="sxs-lookup"><span data-stu-id="12f6d-165">In this way, we can locate the root cause of an error more quickly.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="12f6d-166">参照</span><span class="sxs-lookup"><span data-stu-id="12f6d-166">See Also</span></span>  
 [<span data-ttu-id="12f6d-167">トレースの拡張</span><span class="sxs-lookup"><span data-stu-id="12f6d-167">Extending Tracing</span></span>](../../../../../docs/framework/wcf/samples/extending-tracing.md)
