---
title: '方法: カスタム セキュリティ トークン オーセンティケーターの作成'
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, authentication
ms.assetid: 10e245f7-d31e-42e7-82a2-d5780325d372
ms.openlocfilehash: 7cd1cd22a216458add2cef97e45ce2daef3f9f9e
ms.sourcegitcommit: 5b6d778ebb269ee6684fb57ad69a8c28b06235b9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/08/2019
ms.locfileid: "59177100"
---
# <a name="how-to-create-a-custom-security-token-authenticator"></a><span data-ttu-id="f6ae7-102">方法: カスタム セキュリティ トークン オーセンティケーターの作成</span><span class="sxs-lookup"><span data-stu-id="f6ae7-102">How to: create a custom security token authenticator</span></span>
<span data-ttu-id="f6ae7-103">ここでは、カスタム セキュリティ トークン認証システムの作成方法と、これをカスタム セキュリティ トークン マネージャーに統合する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-103">This topic shows how to create a custom security token authenticator and how to integrate it with a custom security token manager.</span></span> <span data-ttu-id="f6ae7-104">セキュリティ トークン認証システムは受信メッセージと共に提出されるセキュリティ トークンの内容を検証します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-104">A security token authenticator validates the content of a security token provided with an incoming message.</span></span> <span data-ttu-id="f6ae7-105">検証に成功すると、認証システムは <xref:System.IdentityModel.Policy.IAuthorizationPolicy> インスタンスのコレクションを返します。これが評価されるとクレーム セットが返されます。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-105">If the validation succeeds, the authenticator returns a collection of <xref:System.IdentityModel.Policy.IAuthorizationPolicy> instances that, when evaluated, returns a set of claims.</span></span>  
  
 <span data-ttu-id="f6ae7-106">Windows Communication Foundation (WCF) をカスタム セキュリティ トークン認証システムを使用するには、必要がありますまず作成するカスタム資格情報とセキュリティ トークン マネージャーの実装。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-106">To use a custom security token authenticator in Windows Communication Foundation (WCF), you must first create custom credentials and security token manager implementations.</span></span> <span data-ttu-id="f6ae7-107">カスタム資格情報とセキュリティ トークン マネージャーを作成する方法の詳細については、次を参照してください。[チュートリアル。カスタムのクライアントとサービスの資格情報を作成する](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-107">For more information about creating custom credentials and a security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md).</span></span>
  
## <a name="procedures"></a><span data-ttu-id="f6ae7-108">手順</span><span class="sxs-lookup"><span data-stu-id="f6ae7-108">Procedures</span></span>  
  
#### <a name="to-create-a-custom-security-token-authenticator"></a><span data-ttu-id="f6ae7-109">カスタム セキュリティ トークン認証システムを作成するには</span><span class="sxs-lookup"><span data-stu-id="f6ae7-109">To create a custom security token authenticator</span></span>  
  
1.  <span data-ttu-id="f6ae7-110"><xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> クラスから派生する新しいクラスを定義します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-110">Define a new class derived from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class.</span></span>  
  
2.  <span data-ttu-id="f6ae7-111"><xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateTokenCore%2A> メソッドをオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-111">Override the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateTokenCore%2A> method.</span></span> <span data-ttu-id="f6ae7-112">カスタム認証システムが受信トークンの種類を検証できるかどうかによって、メソッドから `true` または `false` が返されます。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-112">The method returns `true` or `false` depending on whether the custom authenticator can validate the incoming token type or not.</span></span>  
  
3.  <span data-ttu-id="f6ae7-113"><xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> メソッドをオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-113">Override the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method.</span></span> <span data-ttu-id="f6ae7-114">このメソッドでは、トークンの内容を適切に検証する必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-114">This method needs to validate the token contents appropriately.</span></span> <span data-ttu-id="f6ae7-115">トークンが検証手順をパスすると、<xref:System.IdentityModel.Policy.IAuthorizationPolicy> インスタンスのコレクションが返されます。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-115">If the token passes the validation step, it returns a collection of <xref:System.IdentityModel.Policy.IAuthorizationPolicy> instances.</span></span> <span data-ttu-id="f6ae7-116">下記の例では、次の手順で作成するカスタム承認ポリシーの実装を使用します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-116">The following example uses a custom authorization policy implementation that will be created in the next procedure.</span></span>  
  
     [!code-csharp[C_CustomTokenAuthenticator#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#1)]
     [!code-vb[C_CustomTokenAuthenticator#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#1)]  
  
 <span data-ttu-id="f6ae7-117">上記のコードでは、<xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateToken%28System.IdentityModel.Tokens.SecurityToken%29> メソッドに承認ポリシーのコレクションが返されます。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-117">The previous code returns a collection of authorization policies in the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.CanValidateToken%28System.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="f6ae7-118">WCF では、このインターフェイスのパブリックな実装は提供されません。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-118">WCF does not provide a public implementation of this interface.</span></span> <span data-ttu-id="f6ae7-119">以下の手順では、これを独自の要件について実行する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-119">The following procedure shows how to do so for your own requirements.</span></span>  
  
#### <a name="to-create-a-custom-authorization-policy"></a><span data-ttu-id="f6ae7-120">カスタム承認ポリシーを作成するには</span><span class="sxs-lookup"><span data-stu-id="f6ae7-120">To create a custom authorization policy</span></span>  
  
1.  <span data-ttu-id="f6ae7-121"><xref:System.IdentityModel.Policy.IAuthorizationPolicy> インターフェイスを実装する新しいクラスを定義します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-121">Define a new class implementing the <xref:System.IdentityModel.Policy.IAuthorizationPolicy> interface.</span></span>  
  
2.  <span data-ttu-id="f6ae7-122"><xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A> の読み取り専用プロパティを実装します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-122">Implement the <xref:System.IdentityModel.Policy.IAuthorizationComponent.Id%2A> read-only property.</span></span> <span data-ttu-id="f6ae7-123">このプロパティを実装する方法の 1 つは、クラスのコンストラクターでグローバル一意識別子 (GUID) を生成し、この値をプロパティの値が求められるたびに返すことです。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-123">One way to implement this property is to generate a globally unique identifier (GUID) in the class constructor and return it every time the value for this property is requested.</span></span>  
  
3.  <span data-ttu-id="f6ae7-124"><xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A> の読み取り専用プロパティを実装します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-124">Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Issuer%2A> read-only property.</span></span> <span data-ttu-id="f6ae7-125">このプロパティは、トークンから取得されるクレーム セットの発行者を返す必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-125">This property needs to return an issuer of the claim sets that are obtained from the token.</span></span> <span data-ttu-id="f6ae7-126">この発行者は、トークンの発行者、またはトークンの内容を検証する証明機関に対応している必要があります。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-126">This issuer should correspond to the issuer of the token or an authority that is responsible for validating the token contents.</span></span> <span data-ttu-id="f6ae7-127">次の例では、前の手順で作成したカスタム セキュリティ トークン認証システムから、このクラスに渡された発行者クレームを使用します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-127">The following example uses the issuer claim that passed to this class from the custom security token authenticator created in the previous procedure.</span></span> <span data-ttu-id="f6ae7-128">カスタム セキュリティ トークン認証システムでは、(<xref:System.IdentityModel.Claims.ClaimSet.System%2A> プロパティから返される) システム提供のクレーム セットを使用して、ユーザー名トークンの発行者を表します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-128">The custom security token authenticator uses the system-provided claim set (returned by the <xref:System.IdentityModel.Claims.ClaimSet.System%2A> property) to represent the issuer of the username token.</span></span>  
  
4.  <span data-ttu-id="f6ae7-129"><xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A> メソッドを実装します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-129">Implement the <xref:System.IdentityModel.Policy.IAuthorizationPolicy.Evaluate%2A> method.</span></span> <span data-ttu-id="f6ae7-130">このメソッドは (引数として渡される) <xref:System.IdentityModel.Policy.EvaluationContext> クラスのインスタンスに、受信セキュリティ トークンの内容に基づいたクレームを設定します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-130">This method populates an instance of the <xref:System.IdentityModel.Policy.EvaluationContext> class (passed in as an argument) with claims that are based on the incoming security token content.</span></span> <span data-ttu-id="f6ae7-131">評価が完了したら、メソッドは `true` を返します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-131">The method returns `true` when it is done with the evaluation.</span></span> <span data-ttu-id="f6ae7-132">実装が、評価コンテキストに追加情報を提供する他の承認ポリシーの存在に依存している場合、必要な情報が評価コンテキスト内に存在していないと、このメソッドは `false` を返します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-132">In cases when the implementation relies on the presence of other authorization policies that provide additional information to the evaluation context, this method can return `false` if the required information is not present yet in the evaluation context.</span></span> <span data-ttu-id="f6ae7-133">その場合は、WCF は少なくとも 1 つ、承認ポリシーの評価コンテキストが変更された場合は、着信メッセージの生成された他のすべての承認ポリシーを評価した後にもう一度メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-133">In that case, WCF will call the method again after evaluating all other authorization policies generated for the incoming message if at least one of those authorization policies modified the evaluation context.</span></span>  
  
     [!code-csharp[c_CustomTokenAuthenticator#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#3)]
     [!code-vb[c_CustomTokenAuthenticator#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#3)]  

 <span data-ttu-id="f6ae7-134">[チュートリアル: カスタムのクライアントとサービスの資格情報を作成する](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)カスタム資格情報とカスタム セキュリティ トークン マネージャーを作成する方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-134">[Walkthrough: Creating Custom Client and Service Credentials](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md) describes how to create custom credentials and a custom security token manager.</span></span> <span data-ttu-id="f6ae7-135">ここで作成したカスタム セキュリティ トークン認証システムを使用するには、<xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> メソッドからカスタム認証システムを返すようにセキュリティ トークン マネージャーの実装を変更します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-135">To use the custom security token authenticator created here, an implementation of the security token manager is modified to return the custom authenticator from the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> method.</span></span> <span data-ttu-id="f6ae7-136">適切なセキュリティ トークン要件が渡されると、このメソッドは認証システムを返します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-136">The method returns an authenticator when an appropriate security token requirement is passed in.</span></span>  
  
#### <a name="to-integrate-a-custom-security-token-authenticator-with-a-custom-security-token-manager"></a><span data-ttu-id="f6ae7-137">カスタム セキュリティ トークン マネージャーにカスタム セキュリティ トークン認証システムを統合するには</span><span class="sxs-lookup"><span data-stu-id="f6ae7-137">To integrate a custom security token authenticator with a custom security token manager</span></span>  
  
1.  <span data-ttu-id="f6ae7-138">カスタム セキュリティ トークン マネージャーの実装の <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> メソッドをオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-138">Override the <xref:System.IdentityModel.Selectors.SecurityTokenManager.CreateSecurityTokenAuthenticator%2A> method in your custom security token manager implementation.</span></span>  
  
2.  <span data-ttu-id="f6ae7-139"><xref:System.IdentityModel.Selectors.SecurityTokenRequirement> パラメーターに基づいてカスタム セキュリティ トークン認証システムを返すロジックをメソッドに追加します。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-139">Add logic to the method to enable it to return your custom security token authenticator based on the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> parameter.</span></span> <span data-ttu-id="f6ae7-140">次の例では、トークン要件のトークンの種類が (<xref:System.IdentityModel.Tokens.SecurityTokenTypes.UserName%2A> プロパティで表される) ユーザー名で、セキュリティ トークン認証システムで要求されているメッセージの方向 (<xref:System.ServiceModel.Description.MessageDirection.Input> フィールドで表される) が入力である場合、カスタム セキュリティ トークン認証システムが返されます。</span><span class="sxs-lookup"><span data-stu-id="f6ae7-140">The following example returns a custom security token authenticator if the token requirements token type is a user name (represented by the <xref:System.IdentityModel.Tokens.SecurityTokenTypes.UserName%2A> property) and the message direction for which the security token authenticator is being requested is input (represented by the <xref:System.ServiceModel.Description.MessageDirection.Input> field).</span></span>  
  
     [!code-csharp[c_CustomTokenAuthenticator#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtokenauthenticator/cs/source.cs#2)]
     [!code-vb[c_CustomTokenAuthenticator#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtokenauthenticator/vb/source.vb#2)]  
 
## <a name="see-also"></a><span data-ttu-id="f6ae7-141">関連項目</span><span class="sxs-lookup"><span data-stu-id="f6ae7-141">See also</span></span>

- <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>
- <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>
- <xref:System.IdentityModel.Selectors.SecurityTokenManager>
- <xref:System.IdentityModel.Tokens.UserNameSecurityToken>
- [<span data-ttu-id="f6ae7-142">チュートリアル: カスタム クライアントおよびサービスの資格情報を作成する</span><span class="sxs-lookup"><span data-stu-id="f6ae7-142">Walkthrough: Creating Custom Client and Service Credentials</span></span>](../../../../docs/framework/wcf/extending/walkthrough-creating-custom-client-and-service-credentials.md)
- [<span data-ttu-id="f6ae7-143">方法: カスタム セキュリティ トークン プロバイダーを作成する</span><span class="sxs-lookup"><span data-stu-id="f6ae7-143">How to: Create a Custom Security Token Provider</span></span>](../../../../docs/framework/wcf/extending/how-to-create-a-custom-security-token-provider.md)
