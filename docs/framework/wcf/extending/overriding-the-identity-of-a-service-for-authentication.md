---
title: "認証のためのサービスの ID のオーバーライド"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
ms.assetid: d613a22b-07d7-41a4-bada-1adc653b9b5d
caps.latest.revision: "9"
author: dotnet-bot
ms.author: dotnetcontent
manager: wpickett
ms.workload: dotnet
ms.openlocfilehash: e1f8f6bd4d8661393bc849405a8668341f65f8d5
ms.sourcegitcommit: 16186c34a957fdd52e5db7294f291f7530ac9d24
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/22/2017
---
# <a name="overriding-the-identity-of-a-service-for-authentication"></a><span data-ttu-id="86f72-102">認証のためのサービスの ID のオーバーライド</span><span class="sxs-lookup"><span data-stu-id="86f72-102">Overriding the Identity of a Service for Authentication</span></span>
<span data-ttu-id="86f72-103">クライアント資格情報の種類を選択すると、サービス メタデータで公開される ID の種類が指定されるため、通常、サービスで ID を設定する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="86f72-103">Typically, you do not have to set the identity on a service because the selection of a client credential type dictates the type of identity exposed in the service metadata.</span></span> <span data-ttu-id="86f72-104">たとえば、次の構成コードを使用して、 [ \<wsHttpBinding >](../../../../docs/framework/configure-apps/file-schema/wcf/wshttpbinding.md)要素とセット、`clientCredentialType`属性を Windows です。</span><span class="sxs-lookup"><span data-stu-id="86f72-104">For example, the following configuration code uses the [\<wsHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wshttpbinding.md) element and sets the `clientCredentialType` attribute to Windows.</span></span>  
  
  
  
 <span data-ttu-id="86f72-105">次の Web サービス記述言語 (WSDL) コードは、定義済みのエンドポイントの ID を示しています。</span><span class="sxs-lookup"><span data-stu-id="86f72-105">The following Web Services Description Language (WSDL) fragment shows the identity for the endpoint previously defined.</span></span> <span data-ttu-id="86f72-106">この例では、サービスを実行している特定のユーザー アカウントで自己ホスト型サービス (username@contoso.com) でユーザー プリンシパル名 (UPN) id を含んでいる、アカウント名。</span><span class="sxs-lookup"><span data-stu-id="86f72-106">In this example, the service is running as a self-hosted service under a particular user account (username@contoso.com) and therefore the user principal name (UPN) identity contains the account name.</span></span> <span data-ttu-id="86f72-107">UPN は、Windows ドメインではユーザー ログオン名とも呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="86f72-107">The UPN is also known as the user logon name in a Windows domain.</span></span>  
  
  
  
 <span data-ttu-id="86f72-108">Id 設定を示すサンプル アプリケーションを参照してください。[サービス Id サンプル](../../../../docs/framework/wcf/samples/service-identity-sample.md)です。</span><span class="sxs-lookup"><span data-stu-id="86f72-108">For a sample application that demonstrates identity setting, see [Service Identity Sample](../../../../docs/framework/wcf/samples/service-identity-sample.md).</span></span> [!INCLUDE[crabout](../../../../includes/crabout-md.md)]<span data-ttu-id="86f72-109">サービス id を参照してください[サービス Id と認証](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)です。</span><span class="sxs-lookup"><span data-stu-id="86f72-109"> service identity, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).</span></span>  
  
## <a name="kerberos-authentication-and-identity"></a><span data-ttu-id="86f72-110">Kerberos 認証と ID</span><span class="sxs-lookup"><span data-stu-id="86f72-110">Kerberos Authentication and Identity</span></span>  
 <span data-ttu-id="86f72-111">既定では、Windows 資格情報を使用するサービスが構成されている場合、 [ \<identity >](../../../../docs/framework/configure-apps/file-schema/wcf/identity.md)要素を含む、 [ \<userPrincipalName >](../../../../docs/framework/configure-apps/file-schema/wcf/userprincipalname.md)または[ \<servicePrincipalName >](../../../../docs/framework/configure-apps/file-schema/wcf/serviceprincipalname.md)要素は、WSDL で生成します。</span><span class="sxs-lookup"><span data-stu-id="86f72-111">By default, when a service is configured to use a Windows credential, an [\<identity>](../../../../docs/framework/configure-apps/file-schema/wcf/identity.md) element that contains a [\<userPrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/userprincipalname.md) or [\<servicePrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/serviceprincipalname.md) element is generated in the WSDL.</span></span> <span data-ttu-id="86f72-112">サービスが実行されている場合、 `LocalSystem`、 `LocalService`、または`NetworkService`アカウント、サービス プリンシパル名 (SPN) が既定の形式で生成された`host/` \< *hostname*> ためこれらのアカウントでは、コンピューターの SPN のデータにアクセスします。</span><span class="sxs-lookup"><span data-stu-id="86f72-112">If the service is running under the `LocalSystem`, `LocalService`, or `NetworkService` account, a service principal name (SPN) is generated by default in the form of `host/`\<*hostname*> because those accounts have access to the computer's SPN data.</span></span> <span data-ttu-id="86f72-113">サービスが別のアカウントで実行されている場合[!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]形式の UPN を生成\< *username*>@<*domainName*`>`です。</span><span class="sxs-lookup"><span data-stu-id="86f72-113">If the service is running under a different account, [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] generates a UPN in the form of \<*username*>@<*domainName*`>`.</span></span> <span data-ttu-id="86f72-114">これらが生成されるのは、Kerberos 認証では、サービスを認証するために UPN または SPN をクライアントに提供する必要があるからです。</span><span class="sxs-lookup"><span data-stu-id="86f72-114">This occurs because Kerberos authentication requires that a UPN or SPN be supplied to the client to authenticate the service.</span></span>  
  
 <span data-ttu-id="86f72-115">Setspn.exe ツールを使用して、他の SPN をドメイン内のサービスのアカウントに登録することもできます。</span><span class="sxs-lookup"><span data-stu-id="86f72-115">You can also use the Setspn.exe tool to register an additional SPN with a service's account in a domain.</span></span> <span data-ttu-id="86f72-116">登録した SPN は、そのサービスの ID として使用できます。</span><span class="sxs-lookup"><span data-stu-id="86f72-116">You can then use the SPN as the identity of the service.</span></span> <span data-ttu-id="86f72-117">このツールをダウンロードするを参照してください。 [Windows 2000 リソース キット ツール: Setspn.exe](http://go.microsoft.com/fwlink/?LinkId=91752)です。</span><span class="sxs-lookup"><span data-stu-id="86f72-117">To download the tool, see [Windows 2000 Resource Kit Tool : Setspn.exe](http://go.microsoft.com/fwlink/?LinkId=91752).</span></span> [!INCLUDE[crabout](../../../../includes/crabout-md.md)]<span data-ttu-id="86f72-118">このツールを参照してください[Setspn の概要](http://go.microsoft.com/fwlink/?LinkId=61374)です。</span><span class="sxs-lookup"><span data-stu-id="86f72-118"> the tool, see [Setspn Overview](http://go.microsoft.com/fwlink/?LinkId=61374).</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="86f72-119">ネゴシエーションを行わずに Windows 資格情報を使用するには、サービスのユーザー アカウントが Active Directory ドメインに登録された SPN にアクセスできる必要があります。</span><span class="sxs-lookup"><span data-stu-id="86f72-119">To use the Windows credential type without negotiation, the service's user account must have access to the SPN that is registered with the Active Directory domain.</span></span> <span data-ttu-id="86f72-120">これは、次の方法で行うことができます。</span><span class="sxs-lookup"><span data-stu-id="86f72-120">You can do this in the following ways:</span></span>  
  
-   <span data-ttu-id="86f72-121">サービスを実行するには、NetworkService アカウントまたは LocalSystem アカウントを使用します。</span><span class="sxs-lookup"><span data-stu-id="86f72-121">Use the NetworkService or LocalSystem account to run your service.</span></span> <span data-ttu-id="86f72-122">これらのアカウントは、コンピューターが Active Directory ドメインに参加したときに確立されたコンピューターの SPN にアクセスできるため、[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] は、適切な SPN 要素を、サービスのメタデータ (WSDL) にあるサービスのエンドポイント内部に自動的に生成します。</span><span class="sxs-lookup"><span data-stu-id="86f72-122">Because those accounts have access to the machine SPN that is established when the machine joins the Active Directory domain, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] automatically generates the proper SPN element inside the service's endpoint in the service's metadata (WSDL).</span></span>  
  
-   <span data-ttu-id="86f72-123">任意の Active Directory ドメイン アカウントを使用してサービスを実行します。</span><span class="sxs-lookup"><span data-stu-id="86f72-123">Use an arbitrary Active Directory domain account to run your service.</span></span> <span data-ttu-id="86f72-124">この場合、そのドメイン アカウント用の SPN を確立します。これには、Setspn.exe ユーティリティ ツールを使用できます。</span><span class="sxs-lookup"><span data-stu-id="86f72-124">In this case, establish an SPN for that domain account, which you can do by using the Setspn.exe utility tool.</span></span> <span data-ttu-id="86f72-125">サービスのアカウント用の SPN を作成したら、SPN をそのメタデータ (WSDL) を通じてサービスのクライアントに公開するように [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] を構成します。</span><span class="sxs-lookup"><span data-stu-id="86f72-125">Once you create the SPN for the service's account, configure [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] to publish that SPN to the service's clients through its metadata (WSDL).</span></span> <span data-ttu-id="86f72-126">これを行うには、アプリケーション構成ファイルまたはコードを使用して、公開されるエンドポイントのエンドポイント ID を設定します。</span><span class="sxs-lookup"><span data-stu-id="86f72-126">This is done by setting the endpoint identity for the exposed endpoint, either through an application configuration file or code.</span></span>  
  
 [!INCLUDE[crabout](../../../../includes/crabout-md.md)]<span data-ttu-id="86f72-127">Spn、Kerberos プロトコル、および Active Directory を参照してください。 [Kerberos テクニカル Supplement for Windows](http://go.microsoft.com/fwlink/?LinkId=88330)です。</span><span class="sxs-lookup"><span data-stu-id="86f72-127"> SPNs, the Kerberos protocol, and Active Directory, see [Kerberos Technical Supplement for Windows](http://go.microsoft.com/fwlink/?LinkId=88330).</span></span>  
  
### <a name="when-spn-or-upn-equals-the-empty-string"></a><span data-ttu-id="86f72-128">SPN または UPN が空の文字列の場合</span><span class="sxs-lookup"><span data-stu-id="86f72-128">When SPN or UPN Equals the Empty String</span></span>  
 <span data-ttu-id="86f72-129">空の文字列の SPN または UPN を設定した場合は、使用しているセキュリティ レベルと認証モードに応じて、次のようになります。</span><span class="sxs-lookup"><span data-stu-id="86f72-129">If you set the SPN or UPN equal to an empty string, a number of different things happen, depending on the security level and authentication mode being used:</span></span>  
  
-   <span data-ttu-id="86f72-130">トランスポート レベルのセキュリティを使用している場合は、NTLM (NT LanMan) 認証が選択されます。</span><span class="sxs-lookup"><span data-stu-id="86f72-130">If you are using transport level security, NT LanMan (NTLM) authentication is chosen.</span></span>  
  
-   <span data-ttu-id="86f72-131">メッセージ レベルのセキュリティを使用している場合は、認証モードによっては認証に失敗する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="86f72-131">If you are using message level security, authentication may fail, depending on the authentication mode:</span></span>  
  
-   <span data-ttu-id="86f72-132">`spnego` モードを使用し、`AllowNtlm` 属性を `false` に設定している場合は、認証に失敗します。</span><span class="sxs-lookup"><span data-stu-id="86f72-132">If you are using `spnego` mode and the `AllowNtlm` attribute is set to `false`, authentication fail.</span></span>  
  
-   <span data-ttu-id="86f72-133">`spnego` モードを使用し、`AllowNtlm` 属性を `true` に設定している場合、UPN が空の場合は認証に失敗しますが、SPN が空の場合は認証に成功します。</span><span class="sxs-lookup"><span data-stu-id="86f72-133">If you are using `spnego` mode and the `AllowNtlm` attribute is set to `true`, authentication fails if the UPN is empty, but succeeds if the SPN is empty.</span></span>  
  
-   <span data-ttu-id="86f72-134">Kerberos ダイレクト ("ワンショット" とも呼ばれます) を使用している場合は、認証に失敗します。</span><span class="sxs-lookup"><span data-stu-id="86f72-134">If you are using Kerberos direct (also known as "one-shot"), authentication fails.</span></span>  
  
### <a name="using-the-identity-element-in-configuration"></a><span data-ttu-id="86f72-135">使用して、 \<identity > 構成内の要素</span><span class="sxs-lookup"><span data-stu-id="86f72-135">Using the \<identity> Element in Configuration</span></span>  
 <span data-ttu-id="86f72-136">前の例で示したバインディングのクライアント資格情報の種類を Certificate に変更すると、生成される WSDL には、Base64 でシリアル化された ID 値用の X.509 証明書が含まれます。コードを次に示します`,`。</span><span class="sxs-lookup"><span data-stu-id="86f72-136">If you change the client credential type in the binding previously shown to Certificate`,` then the generated WSDL contains a Base64 serialized X.509 certificate for the identity value as shown in the following code.</span></span> <span data-ttu-id="86f72-137">これは、Windows 以外のすべてのクライアント資格情報の種類の既定値です。</span><span class="sxs-lookup"><span data-stu-id="86f72-137">This is the default for all client credential types other than Windows.</span></span>  
  
  
  
 <span data-ttu-id="86f72-138">構成で <`identity`> 要素を使用したり、コードで ID を設定したりすることにより、既定のサービス ID の値を変更したり、ID の種類を変更したりすることが可能です。</span><span class="sxs-lookup"><span data-stu-id="86f72-138">You can change the value of the default service identity or change the type of the identity by using the <`identity`> element in configuration or by setting the identity in code.</span></span> <span data-ttu-id="86f72-139">値 `contoso.com` を使用してドメイン ネーム システム (DNS) ID を設定する構成コードを次に示します。</span><span class="sxs-lookup"><span data-stu-id="86f72-139">The following configuration code sets a domain name system (DNS) identity with the value `contoso.com`.</span></span>  
  
  
  
### <a name="setting-identity-programmatically"></a><span data-ttu-id="86f72-140">プログラムによる ID の設定</span><span class="sxs-lookup"><span data-stu-id="86f72-140">Setting Identity Programmatically</span></span>  
 <span data-ttu-id="86f72-141">ID は、[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] によって自動的に決定されるため、サービスで ID を明示的に指定する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="86f72-141">Your service does not have to explicitly specify an identity, because [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] automatically determines it.</span></span> <span data-ttu-id="86f72-142">ただし、[!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] では、必要に応じてエンドポイントの ID を指定できます。</span><span class="sxs-lookup"><span data-stu-id="86f72-142">However, [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)] allows you to specify an identity on an endpoint, if required.</span></span> <span data-ttu-id="86f72-143">特定の DNS ID を持つ新しいサービス エンドポイントを追加するコードを次に示します。</span><span class="sxs-lookup"><span data-stu-id="86f72-143">The following code adds a new service endpoint with a specific DNS identity.</span></span>  
  
 [!code-csharp[C_Identity#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_identity/cs/source.cs#5)]
 [!code-vb[C_Identity#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_identity/vb/source.vb#5)]  
  
## <a name="see-also"></a><span data-ttu-id="86f72-144">参照</span><span class="sxs-lookup"><span data-stu-id="86f72-144">See Also</span></span>  
 [<span data-ttu-id="86f72-145">方法 : カスタム クライアント ID 検証機能を作成する</span><span class="sxs-lookup"><span data-stu-id="86f72-145">How to: Create a Custom Client Identity Verifier</span></span>](../../../../docs/framework/wcf/extending/how-to-create-a-custom-client-identity-verifier.md)  
 [<span data-ttu-id="86f72-146">サービス ID と認証</span><span class="sxs-lookup"><span data-stu-id="86f72-146">Service Identity and Authentication</span></span>](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)
