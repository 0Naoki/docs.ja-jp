---
title: 認証のためのサービスの ID のオーバーライド
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: d613a22b-07d7-41a4-bada-1adc653b9b5d
ms.openlocfilehash: a5a32220ad1f638bf2e93051e9b436d8270aec2f
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/23/2019
ms.locfileid: "62039615"
---
# <a name="overriding-the-identity-of-a-service-for-authentication"></a><span data-ttu-id="f83e3-102">認証のためのサービスの ID のオーバーライド</span><span class="sxs-lookup"><span data-stu-id="f83e3-102">Overriding the Identity of a Service for Authentication</span></span>
<span data-ttu-id="f83e3-103">クライアント資格情報の種類を選択すると、サービス メタデータで公開される ID の種類が指定されるため、通常、サービスで ID を設定する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="f83e3-103">Typically, you do not have to set the identity on a service because the selection of a client credential type dictates the type of identity exposed in the service metadata.</span></span> <span data-ttu-id="f83e3-104">たとえば、次の構成コードを使用して、 [ \<wsHttpBinding >](../../../../docs/framework/configure-apps/file-schema/wcf/wshttpbinding.md)要素とセット、`clientCredentialType`属性を Windows にします。</span><span class="sxs-lookup"><span data-stu-id="f83e3-104">For example, the following configuration code uses the [\<wsHttpBinding>](../../../../docs/framework/configure-apps/file-schema/wcf/wshttpbinding.md) element and sets the `clientCredentialType` attribute to Windows.</span></span>  

 <span data-ttu-id="f83e3-105">次の Web サービス記述言語 (WSDL) コードは、定義済みのエンドポイントの ID を示しています。</span><span class="sxs-lookup"><span data-stu-id="f83e3-105">The following Web Services Description Language (WSDL) fragment shows the identity for the endpoint previously defined.</span></span> <span data-ttu-id="f83e3-106">特定のユーザー アカウントで自己ホスト型サービスとして、この例では、サービスが実行されている (username@contoso.com) でユーザー プリンシパル名 (UPN) id を含んでいる、アカウント名。</span><span class="sxs-lookup"><span data-stu-id="f83e3-106">In this example, the service is running as a self-hosted service under a particular user account (username@contoso.com) and therefore the user principal name (UPN) identity contains the account name.</span></span> <span data-ttu-id="f83e3-107">UPN は、Windows ドメインではユーザー ログオン名とも呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="f83e3-107">The UPN is also known as the user logon name in a Windows domain.</span></span>  

 <span data-ttu-id="f83e3-108">Id の設定を示すサンプル アプリケーションを参照してください。[サービス Id サンプル](../../../../docs/framework/wcf/samples/service-identity-sample.md)します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-108">For a sample application that demonstrates identity setting, see [Service Identity Sample](../../../../docs/framework/wcf/samples/service-identity-sample.md).</span></span> <span data-ttu-id="f83e3-109">サービス id の詳細については、次を参照してください。[サービス Id と認証](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-109">For more information about service identity, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).</span></span>  
  
## <a name="kerberos-authentication-and-identity"></a><span data-ttu-id="f83e3-110">Kerberos 認証と ID</span><span class="sxs-lookup"><span data-stu-id="f83e3-110">Kerberos Authentication and Identity</span></span>  
 <span data-ttu-id="f83e3-111">既定では、Windows 資格情報を使用するサービスが構成されている場合、 [ \<identity >](../../../../docs/framework/configure-apps/file-schema/wcf/identity.md)要素を含む、 [ \<userPrincipalName >](../../../../docs/framework/configure-apps/file-schema/wcf/userprincipalname.md)または[ \<servicePrincipalName >](../../../../docs/framework/configure-apps/file-schema/wcf/serviceprincipalname.md)要素が WSDL で生成されます。</span><span class="sxs-lookup"><span data-stu-id="f83e3-111">By default, when a service is configured to use a Windows credential, an [\<identity>](../../../../docs/framework/configure-apps/file-schema/wcf/identity.md) element that contains a [\<userPrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/userprincipalname.md) or [\<servicePrincipalName>](../../../../docs/framework/configure-apps/file-schema/wcf/serviceprincipalname.md) element is generated in the WSDL.</span></span> <span data-ttu-id="f83e3-112">サービスが実行されている場合、 `LocalSystem`、 `LocalService`、または`NetworkService`アカウント、サービス プリンシパル名 (SPN) が既定の形式で生成`host/` \< *hostname*> ためこれらのアカウントでは、コンピューターの SPN のデータにアクセスします。</span><span class="sxs-lookup"><span data-stu-id="f83e3-112">If the service is running under the `LocalSystem`, `LocalService`, or `NetworkService` account, a service principal name (SPN) is generated by default in the form of `host/`\<*hostname*> because those accounts have access to the computer's SPN data.</span></span> <span data-ttu-id="f83e3-113">Windows Communication Foundation (WCF) の形式で UPN が生成されます、サービスが別のアカウントで実行している場合\< *username*>@<*domainName* `>`.</span><span class="sxs-lookup"><span data-stu-id="f83e3-113">If the service is running under a different account, Windows Communication Foundation (WCF) generates a UPN in the form of \<*username*>@<*domainName*`>`.</span></span> <span data-ttu-id="f83e3-114">これらが生成されるのは、Kerberos 認証では、サービスを認証するために UPN または SPN をクライアントに提供する必要があるからです。</span><span class="sxs-lookup"><span data-stu-id="f83e3-114">This occurs because Kerberos authentication requires that a UPN or SPN be supplied to the client to authenticate the service.</span></span>  
  
 <span data-ttu-id="f83e3-115">Setspn.exe ツールを使用して、他の SPN をドメイン内のサービスのアカウントに登録することもできます。</span><span class="sxs-lookup"><span data-stu-id="f83e3-115">You can also use the Setspn.exe tool to register an additional SPN with a service's account in a domain.</span></span> <span data-ttu-id="f83e3-116">登録した SPN は、そのサービスの ID として使用できます。</span><span class="sxs-lookup"><span data-stu-id="f83e3-116">You can then use the SPN as the identity of the service.</span></span> <span data-ttu-id="f83e3-117">このツールをダウンロードするには、次を参照してください。 [Windows 2000 リソース キット ツール。Setspn.exe](https://go.microsoft.com/fwlink/?LinkId=91752)します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-117">To download the tool, see [Windows 2000 Resource Kit Tool : Setspn.exe](https://go.microsoft.com/fwlink/?LinkId=91752).</span></span> <span data-ttu-id="f83e3-118">ツールの詳細については、次を参照してください。 [Setspn の概要](https://go.microsoft.com/fwlink/?LinkId=61374)します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-118">For more information about the tool, see [Setspn Overview](https://go.microsoft.com/fwlink/?LinkId=61374).</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="f83e3-119">ネゴシエーションを行わずに Windows 資格情報を使用するには、サービスのユーザー アカウントが Active Directory ドメインに登録された SPN にアクセスできる必要があります。</span><span class="sxs-lookup"><span data-stu-id="f83e3-119">To use the Windows credential type without negotiation, the service's user account must have access to the SPN that is registered with the Active Directory domain.</span></span> <span data-ttu-id="f83e3-120">これは、次の方法で行うことができます。</span><span class="sxs-lookup"><span data-stu-id="f83e3-120">You can do this in the following ways:</span></span>  
  
- <span data-ttu-id="f83e3-121">サービスを実行するには、NetworkService アカウントまたは LocalSystem アカウントを使用します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-121">Use the NetworkService or LocalSystem account to run your service.</span></span> <span data-ttu-id="f83e3-122">これらのアカウントは、コンピューターのコンピューター、Active Directory ドメインに参加したときに確立された SPN にアクセスのため、WCF は、サービスのメタデータ (WSDL) でサービスのエンドポイント内で適切な SPN 要素を自動的に生成します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-122">Because those accounts have access to the machine SPN that is established when the machine joins the Active Directory domain, WCF automatically generates the proper SPN element inside the service's endpoint in the service's metadata (WSDL).</span></span>  
  
- <span data-ttu-id="f83e3-123">任意の Active Directory ドメイン アカウントを使用してサービスを実行します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-123">Use an arbitrary Active Directory domain account to run your service.</span></span> <span data-ttu-id="f83e3-124">この場合、そのドメイン アカウント用の SPN を確立します。これには、Setspn.exe ユーティリティ ツールを使用できます。</span><span class="sxs-lookup"><span data-stu-id="f83e3-124">In this case, establish an SPN for that domain account, which you can do by using the Setspn.exe utility tool.</span></span> <span data-ttu-id="f83e3-125">サービスのアカウントの SPN を作成した後にそのメタデータ (WSDL) を通じてサービスのクライアントに公開する WCF を構成します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-125">Once you create the SPN for the service's account, configure WCF to publish that SPN to the service's clients through its metadata (WSDL).</span></span> <span data-ttu-id="f83e3-126">これを行うには、アプリケーション構成ファイルまたはコードを使用して、公開されるエンドポイントのエンドポイント ID を設定します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-126">This is done by setting the endpoint identity for the exposed endpoint, either through an application configuration file or code.</span></span>  
  
 <span data-ttu-id="f83e3-127">Spn の詳細について、Kerberos プロトコル、および Active Directory を参照してください。 [Kerberos Technical Supplement for Windows](https://go.microsoft.com/fwlink/?LinkId=88330)します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-127">For more information about SPNs, the Kerberos protocol, and Active Directory, see [Kerberos Technical Supplement for Windows](https://go.microsoft.com/fwlink/?LinkId=88330).</span></span>  
  
### <a name="when-spn-or-upn-equals-the-empty-string"></a><span data-ttu-id="f83e3-128">SPN または UPN が空の文字列の場合</span><span class="sxs-lookup"><span data-stu-id="f83e3-128">When SPN or UPN Equals the Empty String</span></span>  
 <span data-ttu-id="f83e3-129">空の文字列の SPN または UPN を設定した場合は、使用しているセキュリティ レベルと認証モードに応じて、次のようになります。</span><span class="sxs-lookup"><span data-stu-id="f83e3-129">If you set the SPN or UPN equal to an empty string, a number of different things happen, depending on the security level and authentication mode being used:</span></span>  
  
- <span data-ttu-id="f83e3-130">トランスポート レベルのセキュリティを使用している場合は、NTLM (NT LanMan) 認証が選択されます。</span><span class="sxs-lookup"><span data-stu-id="f83e3-130">If you are using transport level security, NT LanMan (NTLM) authentication is chosen.</span></span>  
  
- <span data-ttu-id="f83e3-131">メッセージ レベルのセキュリティを使用している場合は、認証モードによっては認証に失敗する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="f83e3-131">If you are using message level security, authentication may fail, depending on the authentication mode:</span></span>  
  
- <span data-ttu-id="f83e3-132">`spnego` モードを使用し、`AllowNtlm` 属性を `false` に設定している場合は、認証に失敗します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-132">If you are using `spnego` mode and the `AllowNtlm` attribute is set to `false`, authentication fail.</span></span>  
  
- <span data-ttu-id="f83e3-133">`spnego` モードを使用し、`AllowNtlm` 属性を `true` に設定している場合、UPN が空の場合は認証に失敗しますが、SPN が空の場合は認証に成功します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-133">If you are using `spnego` mode and the `AllowNtlm` attribute is set to `true`, authentication fails if the UPN is empty, but succeeds if the SPN is empty.</span></span>  
  
- <span data-ttu-id="f83e3-134">Kerberos ダイレクト ("ワンショット" とも呼ばれます) を使用している場合は、認証に失敗します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-134">If you are using Kerberos direct (also known as "one-shot"), authentication fails.</span></span>  
  
### <a name="using-the-identity-element-in-configuration"></a><span data-ttu-id="f83e3-135">使用して、 \<identity > 構成要素</span><span class="sxs-lookup"><span data-stu-id="f83e3-135">Using the \<identity> Element in Configuration</span></span>  
 <span data-ttu-id="f83e3-136">前の例で示したバインディングのクライアント資格情報の種類を Certificate に変更すると、生成される WSDL には、Base64 でシリアル化された ID 値用の X.509 証明書が含まれます。コードを次に示します`,`。</span><span class="sxs-lookup"><span data-stu-id="f83e3-136">If you change the client credential type in the binding previously shown to Certificate`,` then the generated WSDL contains a Base64 serialized X.509 certificate for the identity value as shown in the following code.</span></span> <span data-ttu-id="f83e3-137">これは、Windows 以外のすべてのクライアント資格情報の種類の既定値です。</span><span class="sxs-lookup"><span data-stu-id="f83e3-137">This is the default for all client credential types other than Windows.</span></span>  

 <span data-ttu-id="f83e3-138">構成で <`identity`> 要素を使用したり、コードで ID を設定したりすることにより、既定のサービス ID の値を変更したり、ID の種類を変更したりすることが可能です。</span><span class="sxs-lookup"><span data-stu-id="f83e3-138">You can change the value of the default service identity or change the type of the identity by using the <`identity`> element in configuration or by setting the identity in code.</span></span> <span data-ttu-id="f83e3-139">値 `contoso.com` を使用してドメイン ネーム システム (DNS) ID を設定する構成コードを次に示します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-139">The following configuration code sets a domain name system (DNS) identity with the value `contoso.com`.</span></span>  

### <a name="setting-identity-programmatically"></a><span data-ttu-id="f83e3-140">プログラムによる ID の設定</span><span class="sxs-lookup"><span data-stu-id="f83e3-140">Setting Identity Programmatically</span></span>  
 <span data-ttu-id="f83e3-141">WCF が自動的に決定されるため、サービスは、id を明示的に指定がありません。</span><span class="sxs-lookup"><span data-stu-id="f83e3-141">Your service does not have to explicitly specify an identity, because WCF automatically determines it.</span></span> <span data-ttu-id="f83e3-142">ただし、WCF は、必要な場合、エンドポイントで id を指定することです。</span><span class="sxs-lookup"><span data-stu-id="f83e3-142">However, WCF allows you to specify an identity on an endpoint, if required.</span></span> <span data-ttu-id="f83e3-143">特定の DNS ID を持つ新しいサービス エンドポイントを追加するコードを次に示します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-143">The following code adds a new service endpoint with a specific DNS identity.</span></span>  
  
 [!code-csharp[C_Identity#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_identity/cs/source.cs#5)]
 [!code-vb[C_Identity#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_identity/vb/source.vb#5)]  
  
## <a name="see-also"></a><span data-ttu-id="f83e3-144">関連項目</span><span class="sxs-lookup"><span data-stu-id="f83e3-144">See also</span></span>

- [<span data-ttu-id="f83e3-145">方法: カスタムのクライアント Id 検証機能を作成します。</span><span class="sxs-lookup"><span data-stu-id="f83e3-145">How to: Create a Custom Client Identity Verifier</span></span>](../../../../docs/framework/wcf/extending/how-to-create-a-custom-client-identity-verifier.md)
- [<span data-ttu-id="f83e3-146">サービス ID と認証</span><span class="sxs-lookup"><span data-stu-id="f83e3-146">Service Identity and Authentication</span></span>](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)
