---
title: "Error handling | Microsoft Docs"
ms.custom: ""
ms.date: "03/30/2017"
ms.prod: ".net-framework-4.6"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dotnet-clr"
ms.tgt_pltfrm: ""
ms.topic: "article"
ms.assetid: c948841a-7db9-40ae-9b78-587d216cbcaf
caps.latest.revision: 3
author: "Erikre"
ms.author: "erikre"
manager: "erikre"
caps.handback.revision: 3
---
# Error handling
## Windows Communication Foundation でのエラー処理  
 サービスで予期しない例外やエラーが発生した場合、例外処理ソリューションを設計する方法は複数あります。  "正しい" または "最善" のエラー処理ソリューションが 1 つもない場合でも、検討する必要のある有効な手段が複数あります。  通常は、WCF 実装の複雑さ、例外の種類と頻度、例外の性質上処理対象かどうか、および関連付けられたトレース、ログ、またはポリシー要件に応じて、  以下に記載されている手法を複数組み合わせたハイブリッド ソリューションを実装することをお勧めします。  
  
 これらのソリューションについては、このセクションの残りの部分で詳しく説明します。  
  
### Microsoft Enterprise Library  
 Microsoft Enterprise Library Exception Handling Application Block は、共通の設計パターンを実装し、エンタープライズ アプリケーションのすべてのアーキテクチャ レイヤーで発生する例外を処理するための一貫した戦略を策定するのに役立ちます。  これは、アプリケーション コンポーネントの catch ステートメントに含まれる一般的なコードをサポートするように設計されています。  開発者は、アプリケーション全体で同一の catch ブロックにこのコード \(例外情報をログに記録するコードなど\) を繰り返し使用する代わりに、Exception Handling Application Block を使用すると、このロジックを再利用可能な例外ハンドラーとしてカプセル化できます。  
  
 このライブラリには、すぐに使用できる Fault Contract Exception Handler が含まれています。  この例外ハンドラーは、Windows® Communication Foundation \(WCF\) のサービス境界で使用することを目的に設計されており、例外から新しいエラー コントラクトを生成します。  
  
 アプリケーション ブロックは、よく使用されるベスト プラクティスを組み込み、アプリケーション全体の例外処理に共通の方法を提供することを目的としています。  その一方で、独自に開発されたカスタム エラー ハンドラーやエラー コントラクトが非常に便利な場合もあります。  たとえば、カスタム エラー ハンドラーを使用すると、すべての例外を自動的に FaultExceptions に昇格し、さらにアプリケーションにログ機能を追加できるようになります。  
  
 詳細については、「[Microsoft Enterprise Library](http://msdn.microsoft.com/library/ff632023.aspx)」を参照してください。  
  
### 予期される例外の処理  
 適切な行動方針として、各操作または関連する機能拡張ポイントにおいて予期される例外をキャッチし、キャッチした例外を回復できるかどうかを判断して、FaultException\<T\> で適切なカスタム エラーを返します。  
  
### IErrorHandler を使用した予期しない例外の処理  
 予期しない例外を処理するには、行動方針として IErrorHandler を "フックする" ことをお勧めします。  エラー ハンドラーは、チャネル層ではなく WCF ランタイム レベル \("サービス モデル" 層\) でのみ例外をキャッチします。  チャネル レベルで IErrorHandler をフックする唯一の方法は、カスタム チャネルを作成することです。ただし、これはほとんどのシナリオで推奨されていません。  
  
 一般的に、"予期しない例外" とは、回復不可能な例外でも処理例外でもなく、予期しないユーザー例外のことです。  回復不可能な例外 \(メモリ不足の例外など\) は、一般的に[ExceptionHandler クラス](http://msdn.microsoft.com/library/system.servicemodel.dispatcher.exceptionhandler.aspx)によって自動的に処理される例外で、通常は正常に処理できません。このような例外の処理は、単に追加のログ記録を行うため、または標準の例外をクライアントに返すためにのみ行われます。  処理例外は、シリアル化、エンコーダー、フォーマッタ レベルなどのメッセージの処理中に発生します。通常、この例外は IErrorHandler では処理できません。これは、一般的に、このような例外が発生するまでにエラー ハンドラーの介入が早すぎるか、遅すぎることが原因です。  同様に、トランスポート例外も IErrorHandler では処理できません。  
  
 IErrorHandler を使用すると、例外がスローされたときのアプリケーションの動作を明示的に制御できます。  次のような操作が可能です。  
  
1.  クライアントにエラーを送信するかどうかを決定する  
  
2.  例外をエラーに置き換える  
  
3.  エラーを別のエラーに置き換える  
  
4.  ログまたはトレースを実行する  
  
5.  他のカスタム アクティビティを実行する  
  
 カスタム エラー ハンドラーは、サービスのチャネル ディスパッチャーの ErrorHandlers プロパティに追加することでインストールできます。  複数のエラー ハンドラーを設定することができ、これらはこのコレクションに追加された順序で呼び出されます。  
  
 IErrorHandler.ProvideFault は、クライアントに送信されるエラー メッセージを制御します。  このメソッドは、サービスの操作によってスローされた例外の種類に関係なく呼び出されます。  ここで操作が実行されない場合、WCF は、その既定の動作を想定し、カスタム エラー ハンドラーが存在しないかのように続行します。  
  
 この方法を使用する可能性がある場合として、クライアントに送信される前の例外をエラーに変換するための一元的な場所を作成する場合があります \(インスタンスが破棄されておらず、チャネルが Faulted 状態に移行していないことを確認します\)。  
  
 通常、IErrorHandler.HandleError メソッドは、エラー ログ記録、システム通知、アプリケーションのシャットダウンなど、エラー関連の動作を実装するために使用されます。  IErrorHandler.HandleError は、サービス内の複数の場所で呼び出すことができます。エラーがスローされた場所に応じて、HandleError メソッドは操作と同じスレッドから呼び出される場合と呼び出されない場合があります \(この点について保証はありません\)。  
  
### WCF 外部での例外の処理  
 多くの場合、構成の例外、データベース接続文字列の例外、およびその他の同様の例外は、WCF アプリケーションのコンテキスト内で発生する可能性がありますが、これらの例外自体は、サービス モデルまたは Web サービス自体が原因で発生する例外ではありません。  これらの例外は、Web サービス外部の "標準" の例外で、環境の中で他の外部例外が処理されるのと同様に処理される必要があります。  
  
### 例外のトレース  
 トレースとは、すべての例外を確認できる可能性のある唯一の "汎用的な" 場所です。  例外のトレースとログの詳細については、「トレースとログ」を参照してください。  
  
### WebGetAttribute と WebInvokeAttribute を使用した場合の URI テンプレート エラー  
 WebGet 属性と WebInvoke 属性を使用すると、要求アドレスのコンポーネントを操作パラメーターにマップする URI テンプレートを指定できます。  たとえば、URI テンプレートが "weather\/{state}\/{city}" の場合は、要求アドレスがリテラル トークン、state という名前のパラメーター、および city という名前にマップされます。  その後、これらのパラメーターは、名前によって、操作の仮パラメーターの一部にバインドされる場合があります。  
  
 テンプレート パラメーターが URI 内の文字列の形式で表されるのに対し、型指定されたコントラクトの仮パラメーターは文字列以外の型である可能性があります。  そのため、操作が呼び出される前に変換を行う必要があります。  [変換形式の表](http://msdn.microsoft.com/library/bb412172.aspx)をご利用いただけます。  
  
 ただし、変換に失敗した場合は、失敗したことを操作に認識させる方法はありません。  代わりに、型変換は、ディスパッチ エラーの形式で表示されます。  
  
 型変換のディスパッチ エラーは、エラー ハンドラーをインストールすることで、その他多くの種類のディスパッチ エラーと同様に調査できます。  IErrorHandler 機能拡張ポイントは、サービス レベルの例外を処理するために呼び出されます。  そこから、呼び出し元に返される応答を選択できます \(カスタム タスクとレポートを実行することもできます\)。  
  
## 参照  
 [WCF エラー処理](http://msdn.microsoft.com/library/gg281715.aspx)