---
title: WCF の委任と偽装
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- impersonation [WCF]
- delegation [WCF]
ms.assetid: 110e60f7-5b03-4b69-b667-31721b8e3152
ms.openlocfilehash: 86f7f485c289d1641605ab538f8500418b77cfd8
ms.sourcegitcommit: 6b308cf6d627d78ee36dbbae8972a310ac7fd6c8
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/23/2019
ms.locfileid: "54663311"
---
# <a name="delegation-and-impersonation-with-wcf"></a><span data-ttu-id="e8970-102">WCF の委任と偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-102">Delegation and Impersonation with WCF</span></span>
<span data-ttu-id="e8970-103">*偽装* は、サービス ドメインのリソースへのクライアント アクセスを制限するためにサービスが使用する一般的な手法です。</span><span class="sxs-lookup"><span data-stu-id="e8970-103">*Impersonation* is a common technique that services use to restrict client access to a service domain's resources.</span></span> <span data-ttu-id="e8970-104">サービス ドメインのリソースは、ローカル ファイルなどのコンピューター リソースの場合もあれば (偽装)、ファイル共有などの別のコンピューター上のリソースの場合もあります (委任)。</span><span class="sxs-lookup"><span data-stu-id="e8970-104">Service domain resources can either be machine resources, such as local files (impersonation), or a resource on another machine, such as a file share (delegation).</span></span> <span data-ttu-id="e8970-105">サンプル アプリケーションについては、「 [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="e8970-105">For a sample application, see [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span></span> <span data-ttu-id="e8970-106">権限借用の使用方法の例は、次を参照してください。[方法。サービスのクライアントを偽装](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)します。</span><span class="sxs-lookup"><span data-stu-id="e8970-106">For an example of how to use impersonation, see [How to: Impersonate a Client on a Service](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md).</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="e8970-107">サービスでクライアントを偽装すると、サービスはそのクライアントの資格情報を使用して実行されます。この資格情報の特権がサーバー プロセスより高い場合があることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="e8970-107">Be aware that when impersonating a client on a service, the service runs with the client's credentials, which may have higher privileges than the server process.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="e8970-108">概要</span><span class="sxs-lookup"><span data-stu-id="e8970-108">Overview</span></span>  
 <span data-ttu-id="e8970-109">通常、クライアントは、クライアントに代わって何らかのアクションを実行してもらうためにサービスを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="e8970-109">Typically, clients call a service to have the service perform some action on the client’s behalf.</span></span> <span data-ttu-id="e8970-110">偽装により、サービスはアクションの実行時にクライアントとして機能できます。</span><span class="sxs-lookup"><span data-stu-id="e8970-110">Impersonation allows the service to act as the client while performing the action.</span></span> <span data-ttu-id="e8970-111">委任を使用すると、フロントエンド サービスは、バックエンド サービスもクライアントを偽装できるような方法で、バックエンド サービスにクライアントの要求を転送できます。</span><span class="sxs-lookup"><span data-stu-id="e8970-111">Delegation allows a front-end service to forward the client’s request to a back-end service in such a way that the back-end service can also impersonate the client.</span></span> <span data-ttu-id="e8970-112">偽装は、クライアントが特定のアクションを実行するために承認されているかどうかを確認する方法として、最も一般的に使用されます。委任は、偽装機能をクライアントの ID と共にバックエンド サービスにフローする方法です。</span><span class="sxs-lookup"><span data-stu-id="e8970-112">Impersonation is most commonly used as a way of checking whether a client is authorized to perform a particular action, while delegation is a way of flowing impersonation capabilities, along with the client’s identity, to a back-end service.</span></span> <span data-ttu-id="e8970-113">委任は、Kerberos ベースの認証を実行するときに使用できる Windows ドメインの機能です。</span><span class="sxs-lookup"><span data-stu-id="e8970-113">Delegation is a Windows domain feature that can be used when Kerberos-based authentication is performed.</span></span> <span data-ttu-id="e8970-114">委任は ID フローとは異なります。委任では、クライアントのパスワードを保持せずにクライアントを偽装する機能を転送するため、ID フローよりもかなり高い特権が与えられた操作です。</span><span class="sxs-lookup"><span data-stu-id="e8970-114">Delegation is distinct from identity flow and, because delegation transfers the ability to impersonate the client without possession of the client’s password, it is a much higher privileged operation than identity flow.</span></span>  
  
 <span data-ttu-id="e8970-115">偽装と委任はいずれも、クライアントが Windows ID を保持していることが必要となります。</span><span class="sxs-lookup"><span data-stu-id="e8970-115">Both impersonation and delegation require that the client have a Windows identity.</span></span> <span data-ttu-id="e8970-116">クライアントが Windows ID を保持していない場合、クライアントの ID を 2 番目のサービスにフローする以外に選択肢はありません。</span><span class="sxs-lookup"><span data-stu-id="e8970-116">If a client does not possess a Windows identity, then the only option available is to flow the client’s identity to the second service.</span></span>  
  
## <a name="impersonation-basics"></a><span data-ttu-id="e8970-117">偽装の基本</span><span class="sxs-lookup"><span data-stu-id="e8970-117">Impersonation Basics</span></span>  
 <span data-ttu-id="e8970-118">Windows Communication Foundation (WCF) は、さまざまなクライアント資格情報の偽装をサポートします。</span><span class="sxs-lookup"><span data-stu-id="e8970-118">Windows Communication Foundation (WCF) supports impersonation for a variety of client credentials.</span></span> <span data-ttu-id="e8970-119">このトピックでは、サービス メソッドの実装時に呼び出し元を偽装するためのサービス モデルのサポートについて説明します。</span><span class="sxs-lookup"><span data-stu-id="e8970-119">This topic describes service model support for impersonating the caller during the implementation of a service method.</span></span> <span data-ttu-id="e8970-120">偽装と SOAP セキュリティ、およびこれらのシナリオでの WCF オプションに関連する一般的な配置のシナリオではについても説明します。</span><span class="sxs-lookup"><span data-stu-id="e8970-120">Also discussed are common deployment scenarios involving impersonation and SOAP security and WCF options in these scenarios.</span></span>  
  
 <span data-ttu-id="e8970-121">このトピックでは、SOAP セキュリティを使用する場合に、偽装と WCF の委任について説明します。</span><span class="sxs-lookup"><span data-stu-id="e8970-121">This topic focuses on impersonation and delegation in WCF when using SOAP security.</span></span> <span data-ttu-id="e8970-122">使用することできますも権限借用と委任 wcf トランスポート セキュリティを使用する場合」の説明に従って[トランスポート セキュリティを使用して偽装](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md)します。</span><span class="sxs-lookup"><span data-stu-id="e8970-122">You can also use impersonation and delegation with WCF when using transport security, as described in [Using Impersonation with Transport Security](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span></span>  
  
## <a name="two-methods"></a><span data-ttu-id="e8970-123">2 つの方法</span><span class="sxs-lookup"><span data-stu-id="e8970-123">Two Methods</span></span>  
 <span data-ttu-id="e8970-124">WCF SOAP セキュリティは、偽装を実行するための 2 つの異なるメソッドです。</span><span class="sxs-lookup"><span data-stu-id="e8970-124">WCF SOAP security has two distinct methods for performing impersonation.</span></span> <span data-ttu-id="e8970-125">使用する方法は、バインディングによって異なります。</span><span class="sxs-lookup"><span data-stu-id="e8970-125">The method used depends on the binding.</span></span> <span data-ttu-id="e8970-126">1 つは、セキュリティ サポート プロバイダー インターフェイス (SSPI) または Kerberos 認証から取得し、サーバーにキャッシュされた Windows トークンの偽装です。</span><span class="sxs-lookup"><span data-stu-id="e8970-126">One is impersonation from a Windows token obtained from the Security Support Provider Interface (SSPI) or Kerberos authentication, which is then cached on the service.</span></span> <span data-ttu-id="e8970-127">もう 1 つは、 *Service-for-User (S4U)* と総称される Kerberos 拡張から取得した Windows トークンの偽装です。</span><span class="sxs-lookup"><span data-stu-id="e8970-127">The second is impersonation from a Windows token obtained from the Kerberos extensions, collectively called *Service-for-User* (S4U).</span></span>  
  
### <a name="cached-token-impersonation"></a><span data-ttu-id="e8970-128">キャッシュされたトークンの偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-128">Cached Token Impersonation</span></span>  
 <span data-ttu-id="e8970-129">キャッシュされたトークンの偽装は、以下で実行できます。</span><span class="sxs-lookup"><span data-stu-id="e8970-129">You can perform cached-token impersonation with the following:</span></span>  
  
-   <span data-ttu-id="e8970-130">Windows クライアント資格情報を使用する<xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>、および <xref:System.ServiceModel.NetTcpBinding> 。</span><span class="sxs-lookup"><span data-stu-id="e8970-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a Windows client credential.</span></span>  
  
-   <span data-ttu-id="e8970-131"><xref:System.ServiceModel.BasicHttpBinding> が <xref:System.ServiceModel.BasicHttpSecurityMode> 資格情報に設定された <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> 。または、サービスが有効な Windows アカウントにマップできるユーザー名資格情報をクライアントが提示する、その他の標準バインディング。</span><span class="sxs-lookup"><span data-stu-id="e8970-131"><xref:System.ServiceModel.BasicHttpBinding> with a <xref:System.ServiceModel.BasicHttpSecurityMode> set to the <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> credential, or any other standard binding where the client presents a user name credential that the service can map to a valid Windows account.</span></span>  
  
-   <span data-ttu-id="e8970-132"><xref:System.ServiceModel.Channels.CustomBinding> が `requireCancellation` に設定された Windows クライアント資格情報を使用する `true` </span><span class="sxs-lookup"><span data-stu-id="e8970-132">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` set to `true`.</span></span> <span data-ttu-id="e8970-133">(このプロパティは、<xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>、<xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>、および <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters> の各クラスで使用できます)。セキュリティで保護されたメッセージ交換をバインディングで使用する場合は、`requireCancellation` プロパティを `true` に設定することも必要です。</span><span class="sxs-lookup"><span data-stu-id="e8970-133">(The property is available on the following classes: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>, and <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) If a secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
-   <span data-ttu-id="e8970-134">クライアントがユーザー名資格情報を提示する <xref:System.ServiceModel.Channels.CustomBinding> 。</span><span class="sxs-lookup"><span data-stu-id="e8970-134">Any <xref:System.ServiceModel.Channels.CustomBinding> where the client presents a user name credential.</span></span> <span data-ttu-id="e8970-135">セキュリティで保護されたメッセージ交換をバインディングで使用する場合は、 `requireCancellation` プロパティを `true`に設定することも必要です。</span><span class="sxs-lookup"><span data-stu-id="e8970-135">If secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
### <a name="s4u-based-impersonation"></a><span data-ttu-id="e8970-136">S4U ベースの偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-136">S4U-Based Impersonation</span></span>  
 <span data-ttu-id="e8970-137">S4U ベースの偽装は、以下で実行できます。</span><span class="sxs-lookup"><span data-stu-id="e8970-137">You can perform S4U-based impersonation with the following:</span></span>  
  
-   <span data-ttu-id="e8970-138">サービスが有効な Windows アカウントにマップできる証明書クライアント資格情報を使用する<xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>、および <xref:System.ServiceModel.NetTcpBinding> 。</span><span class="sxs-lookup"><span data-stu-id="e8970-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a certificate client credential that the service can map to a valid Windows account.</span></span>  
  
-   <span data-ttu-id="e8970-139"><xref:System.ServiceModel.Channels.CustomBinding> プロパティが `requireCancellation` に設定された Windows クライアント資格情報を使用する `false`。</span><span class="sxs-lookup"><span data-stu-id="e8970-139">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` property set to `false`.</span></span>  
  
-   <span data-ttu-id="e8970-140"><xref:System.ServiceModel.Channels.CustomBinding> プロパティが `requireCancellation` に設定されたユーザー名資格情報または Windows クライアント資格情報とセキュリティで保護されたメッセージ交換を使用する `false`。</span><span class="sxs-lookup"><span data-stu-id="e8970-140">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a user name or Windows client credential and secure conversation with the `requireCancellation` property set to `false`.</span></span>  
  
 <span data-ttu-id="e8970-141">サービスがクライアントを偽装できるエクステントは、偽装を試みるときにサービス アカウントが保持している特権、使用する偽装の種類、およびクライアントが許可すると考えられる偽装のエクステントによって異なります。</span><span class="sxs-lookup"><span data-stu-id="e8970-141">The extent to which the service can impersonate the client depends on the privileges the service account holds when it attempts impersonation, the type of impersonation used, and possibly the extent of impersonation the client permits.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e8970-142">クライアントとサービスが同じコンピューター上で実行されており、クライアントがシステム アカウント ( `Local System` や `Network Service`など) で実行されているときに、ステートレスなセキュリティ コンテキスト トークンを使用してセキュリティで保護されたセッションを確立した場合は、クライアントを偽装できません。</span><span class="sxs-lookup"><span data-stu-id="e8970-142">When the client and service are running on the same computer and the client is running under a system account (for example, `Local System` or `Network Service`), the client cannot be impersonated when a secure session is established with stateful Security Context tokens.</span></span> <span data-ttu-id="e8970-143">通常、Windows フォームまたはコンソール アプリケーションは、現在ログインしているアカウントで実行されるため、既定でそのアカウントを偽装できます。</span><span class="sxs-lookup"><span data-stu-id="e8970-143">A Windows Form or console application typically runs under the currently logged-in account, so that account can be impersonated by default.</span></span> <span data-ttu-id="e8970-144">ただし、クライアントが [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] ページであり、そのページが [!INCLUDE[iis601](../../../../includes/iis601-md.md)] または [!INCLUDE[iisver](../../../../includes/iisver-md.md)]でホストされている場合、既定では、クライアントは `Network Service` アカウントで実行されます。</span><span class="sxs-lookup"><span data-stu-id="e8970-144">However, when the client is an [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] page and that page is hosted in [!INCLUDE[iis601](../../../../includes/iis601-md.md)] or [!INCLUDE[iisver](../../../../includes/iisver-md.md)], then the client does run under the `Network Service` account by default.</span></span> <span data-ttu-id="e8970-145">セキュリティで保護されたセッションをサポートするシステム提供のすべてのバインディングは、ステートフルなセキュリティ コンテキスト トークン (SCT: Security Context Token) を既定で使用します。</span><span class="sxs-lookup"><span data-stu-id="e8970-145">All of the system-provided bindings that support secure sessions use a stateless security context token (SCT) by default.</span></span> <span data-ttu-id="e8970-146">ただし、クライアントが [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] ページであり、ステートフルな SCT を使用する、セキュリティで保護されたセッションを使用している場合は、クライアントを偽装できません。</span><span class="sxs-lookup"><span data-stu-id="e8970-146">However, if the client is an [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] page, and secure sessions with stateful SCTs are used, the client cannot be impersonated.</span></span> <span data-ttu-id="e8970-147">詳細については、セキュリティで保護されたセッションでステートフルな Sct を使用して、次を参照してください。[方法。セキュリティ コンテキストを作成、セキュリティで保護されたセッションのトークン](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md)します。</span><span class="sxs-lookup"><span data-stu-id="e8970-147">For more information about using stateful SCTs in a secure session, see [How to: Create a Security Context Token for a Secure Session](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-declarative-model"></a><span data-ttu-id="e8970-148">サービス メソッドでの偽装:宣言型モデル</span><span class="sxs-lookup"><span data-stu-id="e8970-148">Impersonation in a Service Method: Declarative Model</span></span>  
 <span data-ttu-id="e8970-149">ほとんどの偽装シナリオでは、呼び出し元のコンテキストでサービス メソッドを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e8970-149">Most impersonation scenarios involve executing the service method in the caller context.</span></span> <span data-ttu-id="e8970-150">WCF で偽装要件を指定するユーザーを許可することで行うは簡単にこれを偽装機能を提供する、<xref:System.ServiceModel.OperationBehaviorAttribute>属性。</span><span class="sxs-lookup"><span data-stu-id="e8970-150">WCF provides an impersonation feature that makes this easy to do by allowing the user to specify the impersonation requirement in the <xref:System.ServiceModel.OperationBehaviorAttribute> attribute.</span></span> <span data-ttu-id="e8970-151">たとえば、次のコードで、WCF インフラストラクチャ呼び出し元を偽装を実行する前に、`Hello`メソッド。</span><span class="sxs-lookup"><span data-stu-id="e8970-151">For example, in the following code, the WCF infrastructure impersonates the caller before executing the `Hello` method.</span></span> <span data-ttu-id="e8970-152">`Hello` メソッド内でネイティブ リソースへのアクセス試行が成功するのは、そのリソースのアクセス制御リスト (ACL) で呼び出し元のアクセス特権が許可されている場合だけです。</span><span class="sxs-lookup"><span data-stu-id="e8970-152">Any attempt to access native resources inside the `Hello` method succeed only if the access control list (ACL) of the resource allows the caller access privileges.</span></span> <span data-ttu-id="e8970-153">偽装を有効にするには、次の例に示すように、 <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> プロパティを <xref:System.ServiceModel.ImpersonationOption> 列挙値のいずれか ( <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> または <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>) に設定します。</span><span class="sxs-lookup"><span data-stu-id="e8970-153">To enable impersonation, set the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property to one of the <xref:System.ServiceModel.ImpersonationOption> enumeration values, either <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> or <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, as shown in the following example.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e8970-154">サービスの資格情報がリモート クライアントよりも高い場合は、 <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> プロパティが <xref:System.ServiceModel.ImpersonationOption.Allowed>に設定されていても、サービスの資格情報が使用されます。</span><span class="sxs-lookup"><span data-stu-id="e8970-154">When a service has higher credentials than the remote client, the credentials of the service are used if the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property is set to <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span></span> <span data-ttu-id="e8970-155">つまり、低い特権を持つユーザーがその資格情報を提示した場合、そのユーザーよりも高い特権を持つサービスは、サービスの資格情報を使用してメソッドを実行し、特権の低いユーザーが本来は使用できないリソースを使用できることになります。</span><span class="sxs-lookup"><span data-stu-id="e8970-155">That is, if a low-privileged user provides its credentials, a higher-privileged service executes the method with the credentials of the service, and can use resources that the low-privileged user would otherwise not be able to use.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#1)]
 [!code-vb[c_ImpersonationAndDelegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#1)]  
  
 <span data-ttu-id="e8970-156">呼び出し元が Windows ユーザー アカウントにマップできる資格情報で認証される場合にのみ、WCF インフラストラクチャでは、呼び出し元を偽装できます。</span><span class="sxs-lookup"><span data-stu-id="e8970-156">The WCF infrastructure can impersonate the caller only if the caller is authenticated with credentials that can be mapped to a Windows user account.</span></span> <span data-ttu-id="e8970-157">サービスが Windows アカウントにマップできない資格情報を使用して認証を行うように構成されている場合には、サービス メソッドは実行されません。</span><span class="sxs-lookup"><span data-stu-id="e8970-157">If the service is configured to authenticate using a credential that cannot be mapped to a Windows account, the service method is not executed.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e8970-158">[!INCLUDE[wxp](../../../../includes/wxp-md.md)]では、ステートフルな SCT が作成されると偽装が失敗し、 <xref:System.InvalidOperationException>になります。</span><span class="sxs-lookup"><span data-stu-id="e8970-158">On [!INCLUDE[wxp](../../../../includes/wxp-md.md)], impersonation fails if a stateful SCT is created, resulting in an <xref:System.InvalidOperationException>.</span></span> <span data-ttu-id="e8970-159">詳細については、[サポートされていないシナリオ](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="e8970-159">For more information, see [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-imperative-model"></a><span data-ttu-id="e8970-160">サービス メソッドでの偽装:命令型のモデル</span><span class="sxs-lookup"><span data-stu-id="e8970-160">Impersonation in a Service Method: Imperative Model</span></span>  
 <span data-ttu-id="e8970-161">呼び出し元がサービス メソッドの全体ではなく、一部を偽装するだけで、その機能が実行される場合があります。</span><span class="sxs-lookup"><span data-stu-id="e8970-161">Sometimes a caller does not need to impersonate the entire service method to function, but for only a portion of it.</span></span> <span data-ttu-id="e8970-162">この場合、サービス メソッド内で呼び出し元の Windows ID を取得し、偽装を強制的に実行します。</span><span class="sxs-lookup"><span data-stu-id="e8970-162">In this case, obtain the Windows identity of the caller inside the service method and imperatively perform the impersonation.</span></span> <span data-ttu-id="e8970-163">これを行うには、 <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> の <xref:System.ServiceModel.ServiceSecurityContext> プロパティを使用して <xref:System.Security.Principal.WindowsIdentity> クラスのインスタンスを返し、このインスタンスを使用する前に <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="e8970-163">Do this by using the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property of the <xref:System.ServiceModel.ServiceSecurityContext> to return an instance of the <xref:System.Security.Principal.WindowsIdentity> class and calling the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method before using the instance.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e8970-164">Visual Basic を使用して、必ず`Using`ステートメント、または c#`using`ステートメントを自動的に、偽装操作を元に戻します。</span><span class="sxs-lookup"><span data-stu-id="e8970-164">Be sure to use the Visual Basic`Using` statement or the C# `using` statement to automatically revert the impersonation action.</span></span> <span data-ttu-id="e8970-165">ステートメントを使用しない場合、または Visual Basic または c# 以外のプログラミング言語を使用する場合は、偽装レベルを元に戻すことを確認します。</span><span class="sxs-lookup"><span data-stu-id="e8970-165">If you do not use the statement, or if you use a programming language other than Visual Basic or C#, be sure to revert the impersonation level.</span></span> <span data-ttu-id="e8970-166">この作業を怠ると、サービス拒否攻撃や権限の昇格攻撃のもとになるおそれがあります。</span><span class="sxs-lookup"><span data-stu-id="e8970-166">Failure to do this can form the basis for denial of service and elevation of privilege attacks.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#2)]
 [!code-vb[c_ImpersonationAndDelegation#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#2)]  
  
## <a name="impersonation-for-all-service-methods"></a><span data-ttu-id="e8970-167">すべてのサービス メソッドの偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-167">Impersonation for All Service Methods</span></span>  
 <span data-ttu-id="e8970-168">サービスのすべてのメソッドを呼び出し元のコンテキストで実行することが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="e8970-168">In some cases, you must perform all the methods of a service in the caller’s context.</span></span> <span data-ttu-id="e8970-169">メソッドごとにこの機能を明示的に有効にするのではなく、 <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>を使用します。</span><span class="sxs-lookup"><span data-stu-id="e8970-169">Instead of explicitly enabling this feature on a per-method basis, use the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span></span> <span data-ttu-id="e8970-170">次のコードに示すように、 <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> プロパティを `true`に設定します。</span><span class="sxs-lookup"><span data-stu-id="e8970-170">As shown in the following code, set the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> property to `true`.</span></span> <span data-ttu-id="e8970-171"><xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> は、 <xref:System.ServiceModel.ServiceHost> クラスの動作コレクションから取得されます。</span><span class="sxs-lookup"><span data-stu-id="e8970-171">The <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> is retrieved from the collections of behaviors of the <xref:System.ServiceModel.ServiceHost> class.</span></span> <span data-ttu-id="e8970-172">また、各メソッドに適用する `Impersonation` の <xref:System.ServiceModel.OperationBehaviorAttribute> プロパティを <xref:System.ServiceModel.ImpersonationOption.Allowed> または <xref:System.ServiceModel.ImpersonationOption.Required>に設定することも必要です。</span><span class="sxs-lookup"><span data-stu-id="e8970-172">Also note that the `Impersonation` property of the <xref:System.ServiceModel.OperationBehaviorAttribute> applied to each method must also be set to either <xref:System.ServiceModel.ImpersonationOption.Allowed> or <xref:System.ServiceModel.ImpersonationOption.Required>.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#3)]
 [!code-vb[c_ImpersonationAndDelegation#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#3)]  
  
 <span data-ttu-id="e8970-173">次の表に、WCF の動作のすべての可能な組み合わせに対する`ImpersonationOption`と`ImpersonateCallerForAllServiceOperations`します。</span><span class="sxs-lookup"><span data-stu-id="e8970-173">The following table describes WCF behavior for all possible combinations of `ImpersonationOption` and `ImpersonateCallerForAllServiceOperations`.</span></span>  
  
|`ImpersonationOption`|`ImpersonateCallerForAllServiceOperations`|<span data-ttu-id="e8970-174">動作</span><span class="sxs-lookup"><span data-stu-id="e8970-174">Behavior</span></span>|  
|---------------------------|------------------------------------------------|--------------|  
|<span data-ttu-id="e8970-175">必須</span><span class="sxs-lookup"><span data-stu-id="e8970-175">Required</span></span>|<span data-ttu-id="e8970-176">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-176">n/a</span></span>|<span data-ttu-id="e8970-177">WCF は、呼び出し元を偽装します。</span><span class="sxs-lookup"><span data-stu-id="e8970-177">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="e8970-178">Allowed</span><span class="sxs-lookup"><span data-stu-id="e8970-178">Allowed</span></span>|<span data-ttu-id="e8970-179">False</span><span class="sxs-lookup"><span data-stu-id="e8970-179">false</span></span>|<span data-ttu-id="e8970-180">WCF は、呼び出し元を偽装していません</span><span class="sxs-lookup"><span data-stu-id="e8970-180">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="e8970-181">Allowed</span><span class="sxs-lookup"><span data-stu-id="e8970-181">Allowed</span></span>|<span data-ttu-id="e8970-182">true</span><span class="sxs-lookup"><span data-stu-id="e8970-182">true</span></span>|<span data-ttu-id="e8970-183">WCF は、呼び出し元を偽装します。</span><span class="sxs-lookup"><span data-stu-id="e8970-183">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="e8970-184">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="e8970-184">NotAllowed</span></span>|<span data-ttu-id="e8970-185">False</span><span class="sxs-lookup"><span data-stu-id="e8970-185">false</span></span>|<span data-ttu-id="e8970-186">WCF は、呼び出し元を偽装していません</span><span class="sxs-lookup"><span data-stu-id="e8970-186">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="e8970-187">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="e8970-187">NotAllowed</span></span>|<span data-ttu-id="e8970-188">true</span><span class="sxs-lookup"><span data-stu-id="e8970-188">true</span></span>|<span data-ttu-id="e8970-189">使用できません</span><span class="sxs-lookup"><span data-stu-id="e8970-189">Disallowed.</span></span> <span data-ttu-id="e8970-190">( <xref:System.InvalidOperationException> がスローされます)。</span><span class="sxs-lookup"><span data-stu-id="e8970-190">(An <xref:System.InvalidOperationException> is thrown.)</span></span>|  
  
## <a name="impersonation-level-obtained-from-windows-credentials-and-cached-token-impersonation"></a><span data-ttu-id="e8970-191">Windows 資格情報とキャッシュされたトークンの偽装から取得する偽装レベル</span><span class="sxs-lookup"><span data-stu-id="e8970-191">Impersonation Level Obtained from Windows Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="e8970-192">Windows クライアント資格情報の使用時にサービスが実行する偽装のレベルを、クライアントが部分的に制御するシナリオがあります。</span><span class="sxs-lookup"><span data-stu-id="e8970-192">In some scenarios the client has partial control over the level of impersonation the service performs when a Windows client credential is used.</span></span> <span data-ttu-id="e8970-193">クライアントが匿名偽装レベルを指定した場合に発生するシナリオもあれば、</span><span class="sxs-lookup"><span data-stu-id="e8970-193">One scenario occurs when the client specifies an Anonymous impersonation level.</span></span> <span data-ttu-id="e8970-194">キャッシュされたトークンを使用して偽装を実行した場合に発生するシナリオもあります。</span><span class="sxs-lookup"><span data-stu-id="e8970-194">The other occurs when performing impersonation with a cached token.</span></span> <span data-ttu-id="e8970-195">これを行うには、 <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> クラスの <xref:System.ServiceModel.Security.WindowsClientCredential> プロパティを設定します。このクラスには、ジェネリック クラス <xref:System.ServiceModel.ChannelFactory%601> のプロパティとしてアクセスします。</span><span class="sxs-lookup"><span data-stu-id="e8970-195">This is done by setting the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class, which is accessed as a property of the generic <xref:System.ServiceModel.ChannelFactory%601> class.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e8970-196">匿名偽装レベルを指定すると、クライアントはサービスに匿名でログオンします。</span><span class="sxs-lookup"><span data-stu-id="e8970-196">Specifying an impersonation level of Anonymous causes the client to log on to the service anonymously.</span></span> <span data-ttu-id="e8970-197">したがって、偽装を実行するかどうかに関係なく、サービスは匿名ログオンを許可する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e8970-197">The service must therefore allow anonymous logons, regardless of whether impersonation is performed.</span></span>  
  
 <span data-ttu-id="e8970-198">クライアントは、偽装レベルとして <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>、 <xref:System.Security.Principal.TokenImpersonationLevel.Identification>、 <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>、または <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>を指定できます。</span><span class="sxs-lookup"><span data-stu-id="e8970-198">The client can specify the impersonation level as <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, or <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="e8970-199">次のコードに示すように、指定したレベルのトークンだけが作成されます。</span><span class="sxs-lookup"><span data-stu-id="e8970-199">Only a token at the specified level is produced, as shown in the following code.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#4)]
 [!code-vb[c_ImpersonationAndDelegation#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#4)]  
  
 <span data-ttu-id="e8970-200">キャッシュされたトークンを使用して偽装するときに、サービスが取得する偽装レベルを次の表に示します。</span><span class="sxs-lookup"><span data-stu-id="e8970-200">The following table specifies the impersonation level the service obtains when impersonating from a cached token.</span></span>  
  
|<span data-ttu-id="e8970-201">`AllowedImpersonationLevel` の値</span><span class="sxs-lookup"><span data-stu-id="e8970-201">`AllowedImpersonationLevel` value</span></span>|<span data-ttu-id="e8970-202">サービスに `SeImpersonatePrivilege`がある</span><span class="sxs-lookup"><span data-stu-id="e8970-202">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="e8970-203">サービスとクライアントに処理を代行する機能がある</span><span class="sxs-lookup"><span data-stu-id="e8970-203">Service and client are capable of delegation</span></span>|<span data-ttu-id="e8970-204">キャッシュされたトークンの `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="e8970-204">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="e8970-205">Anonymous</span><span class="sxs-lookup"><span data-stu-id="e8970-205">Anonymous</span></span>|<span data-ttu-id="e8970-206">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-206">Yes</span></span>|<span data-ttu-id="e8970-207">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-207">n/a</span></span>|<span data-ttu-id="e8970-208">偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-208">Impersonation</span></span>|  
|<span data-ttu-id="e8970-209">Anonymous</span><span class="sxs-lookup"><span data-stu-id="e8970-209">Anonymous</span></span>|<span data-ttu-id="e8970-210">いいえ</span><span class="sxs-lookup"><span data-stu-id="e8970-210">No</span></span>|<span data-ttu-id="e8970-211">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-211">n/a</span></span>|<span data-ttu-id="e8970-212">識別</span><span class="sxs-lookup"><span data-stu-id="e8970-212">Identification</span></span>|  
|<span data-ttu-id="e8970-213">識別</span><span class="sxs-lookup"><span data-stu-id="e8970-213">Identification</span></span>|<span data-ttu-id="e8970-214">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-214">n/a</span></span>|<span data-ttu-id="e8970-215">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-215">n/a</span></span>|<span data-ttu-id="e8970-216">識別</span><span class="sxs-lookup"><span data-stu-id="e8970-216">Identification</span></span>|  
|<span data-ttu-id="e8970-217">偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-217">Impersonation</span></span>|<span data-ttu-id="e8970-218">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-218">Yes</span></span>|<span data-ttu-id="e8970-219">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-219">n/a</span></span>|<span data-ttu-id="e8970-220">偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-220">Impersonation</span></span>|  
|<span data-ttu-id="e8970-221">偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-221">Impersonation</span></span>|<span data-ttu-id="e8970-222">いいえ</span><span class="sxs-lookup"><span data-stu-id="e8970-222">No</span></span>|<span data-ttu-id="e8970-223">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-223">n/a</span></span>|<span data-ttu-id="e8970-224">識別</span><span class="sxs-lookup"><span data-stu-id="e8970-224">Identification</span></span>|  
|<span data-ttu-id="e8970-225">処理の代行</span><span class="sxs-lookup"><span data-stu-id="e8970-225">Delegation</span></span>|<span data-ttu-id="e8970-226">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-226">Yes</span></span>|<span data-ttu-id="e8970-227">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-227">Yes</span></span>|<span data-ttu-id="e8970-228">処理の代行</span><span class="sxs-lookup"><span data-stu-id="e8970-228">Delegation</span></span>|  
|<span data-ttu-id="e8970-229">処理の代行</span><span class="sxs-lookup"><span data-stu-id="e8970-229">Delegation</span></span>|<span data-ttu-id="e8970-230">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-230">Yes</span></span>|<span data-ttu-id="e8970-231">いいえ</span><span class="sxs-lookup"><span data-stu-id="e8970-231">No</span></span>|<span data-ttu-id="e8970-232">偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-232">Impersonation</span></span>|  
|<span data-ttu-id="e8970-233">処理の代行</span><span class="sxs-lookup"><span data-stu-id="e8970-233">Delegation</span></span>|<span data-ttu-id="e8970-234">いいえ</span><span class="sxs-lookup"><span data-stu-id="e8970-234">No</span></span>|<span data-ttu-id="e8970-235">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-235">n/a</span></span>|<span data-ttu-id="e8970-236">識別</span><span class="sxs-lookup"><span data-stu-id="e8970-236">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-user-name-credentials-and-cached-token-impersonation"></a><span data-ttu-id="e8970-237">ユーザー名資格情報とキャッシュされたトークンの偽装から取得する偽装レベル</span><span class="sxs-lookup"><span data-stu-id="e8970-237">Impersonation Level Obtained from User Name Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="e8970-238">そのユーザー名とパスワード、サービスを渡すことによって、クライアントにより、設定と同じですが、そのユーザーとしてログオンするための WCF、`AllowedImpersonationLevel`プロパティを<xref:System.Security.Principal.TokenImpersonationLevel.Delegation>します。</span><span class="sxs-lookup"><span data-stu-id="e8970-238">By passing the service its user name and password, a client enables WCF to log on as that user, which is equivalent to setting the `AllowedImpersonationLevel` property to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="e8970-239">(`AllowedImpersonationLevel` は、<xref:System.ServiceModel.Security.WindowsClientCredential> クラスと <xref:System.ServiceModel.Security.HttpDigestClientCredential> クラスで使用できます)。サービスがユーザー名資格情報を受け取るときに取得する偽装レベルを次の表に示します。</span><span class="sxs-lookup"><span data-stu-id="e8970-239">(The `AllowedImpersonationLevel` is available on the <xref:System.ServiceModel.Security.WindowsClientCredential> and <xref:System.ServiceModel.Security.HttpDigestClientCredential> classes.) The following table provides the impersonation level obtained when the service receives user name credentials.</span></span>  
  
|`AllowedImpersonationLevel`|<span data-ttu-id="e8970-240">サービスに `SeImpersonatePrivilege`がある</span><span class="sxs-lookup"><span data-stu-id="e8970-240">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="e8970-241">サービスとクライアントに処理を代行する機能がある</span><span class="sxs-lookup"><span data-stu-id="e8970-241">Service and client are capable of delegation</span></span>|<span data-ttu-id="e8970-242">キャッシュされたトークンの `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="e8970-242">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="e8970-243">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-243">n/a</span></span>|<span data-ttu-id="e8970-244">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-244">Yes</span></span>|<span data-ttu-id="e8970-245">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-245">Yes</span></span>|<span data-ttu-id="e8970-246">処理の代行</span><span class="sxs-lookup"><span data-stu-id="e8970-246">Delegation</span></span>|  
|<span data-ttu-id="e8970-247">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-247">n/a</span></span>|<span data-ttu-id="e8970-248">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-248">Yes</span></span>|<span data-ttu-id="e8970-249">いいえ</span><span class="sxs-lookup"><span data-stu-id="e8970-249">No</span></span>|<span data-ttu-id="e8970-250">偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-250">Impersonation</span></span>|  
|<span data-ttu-id="e8970-251">適用なし</span><span class="sxs-lookup"><span data-stu-id="e8970-251">n/a</span></span>|<span data-ttu-id="e8970-252">いいえ</span><span class="sxs-lookup"><span data-stu-id="e8970-252">No</span></span>|<span data-ttu-id="e8970-253">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-253">n/a</span></span>|<span data-ttu-id="e8970-254">識別</span><span class="sxs-lookup"><span data-stu-id="e8970-254">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-s4u-based-impersonation"></a><span data-ttu-id="e8970-255">S4U ベースの偽装から取得する偽装レベル</span><span class="sxs-lookup"><span data-stu-id="e8970-255">Impersonation Level Obtained from S4U-Based Impersonation</span></span>  
  
|<span data-ttu-id="e8970-256">サービスに `SeTcbPrivilege`がある</span><span class="sxs-lookup"><span data-stu-id="e8970-256">Service has `SeTcbPrivilege`</span></span>|<span data-ttu-id="e8970-257">サービスに `SeImpersonatePrivilege`がある</span><span class="sxs-lookup"><span data-stu-id="e8970-257">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="e8970-258">サービスとクライアントに処理を代行する機能がある</span><span class="sxs-lookup"><span data-stu-id="e8970-258">Service and client are capable of delegation</span></span>|<span data-ttu-id="e8970-259">キャッシュされたトークンの `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="e8970-259">Cached token `ImpersonationLevel`</span></span>|  
|----------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="e8970-260">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-260">Yes</span></span>|<span data-ttu-id="e8970-261">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-261">Yes</span></span>|<span data-ttu-id="e8970-262">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-262">n/a</span></span>|<span data-ttu-id="e8970-263">偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-263">Impersonation</span></span>|  
|<span data-ttu-id="e8970-264">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-264">Yes</span></span>|<span data-ttu-id="e8970-265">いいえ</span><span class="sxs-lookup"><span data-stu-id="e8970-265">No</span></span>|<span data-ttu-id="e8970-266">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-266">n/a</span></span>|<span data-ttu-id="e8970-267">識別</span><span class="sxs-lookup"><span data-stu-id="e8970-267">Identification</span></span>|  
|<span data-ttu-id="e8970-268">いいえ</span><span class="sxs-lookup"><span data-stu-id="e8970-268">No</span></span>|<span data-ttu-id="e8970-269">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-269">n/a</span></span>|<span data-ttu-id="e8970-270">N/A</span><span class="sxs-lookup"><span data-stu-id="e8970-270">n/a</span></span>|<span data-ttu-id="e8970-271">識別</span><span class="sxs-lookup"><span data-stu-id="e8970-271">Identification</span></span>|  
  
## <a name="mapping-a-client-certificate-to-a-windows-account"></a><span data-ttu-id="e8970-272">クライアント証明書から Windows アカウントへのマッピング</span><span class="sxs-lookup"><span data-stu-id="e8970-272">Mapping a Client Certificate to a Windows Account</span></span>  
 <span data-ttu-id="e8970-273">クライアントは、証明書を使用してサービスに対してクライアント自身を認証し、サービスが Active Directory を使用してクライアントを既存のアカウントにマップするように操作できます。</span><span class="sxs-lookup"><span data-stu-id="e8970-273">It is possible for a client to authenticate itself to a service using a certificate, and to have the service map the client to an existing account through Active Directory.</span></span> <span data-ttu-id="e8970-274">次の XML は、証明書をマップするためにサービスを構成する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="e8970-274">The following XML shows how to configure the service to map the certificate.</span></span>  
  
```xml  
<behaviors>  
  <serviceBehaviors>  
    <behavior name="MapToWindowsAccount">  
      <serviceCredentials>  
        <clientCertificate>  
          <authentication mapClientCertificateToWindowsAccount="true" />  
        </clientCertificate>  
      </serviceCredentials>  
    </behavior>  
  </serviceBehaviors>  
</behaviors>  
```  
  
 <span data-ttu-id="e8970-275">次のコードはサービスを構成する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="e8970-275">The following code shows how to configure the service.</span></span>  
  
```  
// Create a binding that sets a certificate as the client credential type.  
WSHttpBinding b = new WSHttpBinding();  
b.Security.Message.ClientCredentialType = MessageCredentialType.Certificate;  
  
// Create a service host that maps the certificate to a Windows account.  
Uri httpUri = new Uri("http://localhost/Calculator");  
ServiceHost sh = new ServiceHost(typeof(HelloService), httpUri);  
sh.Credentials.ClientCertificate.Authentication.MapClientCertificateToWindowsAccount = true;  
```  
  
## <a name="delegation"></a><span data-ttu-id="e8970-276">処理の代行</span><span class="sxs-lookup"><span data-stu-id="e8970-276">Delegation</span></span>  
 <span data-ttu-id="e8970-277">バックエンド サービスに処理を代行させるには、サービスが Kerberos マルチレッグ (NTLM にフォールバックしない SSPI) を実行するか、クライアントの Windows ID を使用して、バックエンド サービスに対する Kerberos 直接認証を実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e8970-277">To delegate to a back-end service, a service must perform Kerberos multi-leg (SSPI without NTLM fallback) or Kerberos direct authentication to the back-end service using the client’s Windows identity.</span></span> <span data-ttu-id="e8970-278">バックエンド サービスに処理を代行させる場合、 <xref:System.ServiceModel.ChannelFactory%601> とチャネルを作成し、クライアントを偽装している間、このチャネル経由で通信を行います。</span><span class="sxs-lookup"><span data-stu-id="e8970-278">To delegate to a back-end service, create a <xref:System.ServiceModel.ChannelFactory%601> and a channel, and then communicate through the channel while impersonating the client.</span></span> <span data-ttu-id="e8970-279">この形式の委任では、バックエンド サービスとフロントエンド サービス間の距離は、フロントエンド サービスで実現される偽装レベルによって決まります。</span><span class="sxs-lookup"><span data-stu-id="e8970-279">With this form of delegation, the distance at which the back-end service can be located from the front-end service depends on the impersonation level achieved by the front-end service.</span></span> <span data-ttu-id="e8970-280">偽装レベルが <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>の場合、フロントエンド サービスとバックエンド サービスは、同じコンピューター上で実行されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="e8970-280">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, the front-end and back-end services must be running on the same machine.</span></span> <span data-ttu-id="e8970-281">偽装レベルが <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>の場合、フロントエンド サービスとバックエンド サービスは、別々のコンピューター上にあっても、同じコンピューター上にあってもかまいません。</span><span class="sxs-lookup"><span data-stu-id="e8970-281">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, the front-end and back-end services can be on separate machines or on the same machine.</span></span> <span data-ttu-id="e8970-282">Delegation レベルの偽装を有効にする場合、委任を許可するように Windows ドメイン ポリシーを構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e8970-282">Enabling delegation-level impersonation requires that Windows domain policy be configured to permit delegation.</span></span> <span data-ttu-id="e8970-283">委任をサポートできるように Active Directory を構成する方法の詳細については、「 [Enabling Delegated Authentication (委任認証の有効化)](https://go.microsoft.com/fwlink/?LinkId=99690)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="e8970-283">For more information about configuring Active Directory for delegation support, see [Enabling Delegated Authentication](https://go.microsoft.com/fwlink/?LinkId=99690).</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e8970-284">バックエンド サービスで Windows アカウントに対応するユーザー名とパスワードを使用して、フロントエンド サービスに対するクライアント認証を行うと、フロントエンド サービスはこのユーザー名とパスワードを再利用して、バックエンド サービスに対する認証を行うことができます。</span><span class="sxs-lookup"><span data-stu-id="e8970-284">When a client authenticates to the front-end service using a user name and password that correspond to a Windows account on the back-end service, the front-end service can authenticate to the back-end service by reusing the client’s user name and password.</span></span> <span data-ttu-id="e8970-285">ユーザー名とパスワードをバックエンド サービスに渡すことで、バックエンド サービスが偽装を実行できるため、これは ID フローの特に強力な形式と言えますが、Kerberos を使用しないため、委任は構成されません。</span><span class="sxs-lookup"><span data-stu-id="e8970-285">This is a particularly powerful form of identity flow, because passing user name and password to the back-end service enables the back-end service to perform impersonation, but it does not constitute delegation because Kerberos is not used.</span></span> <span data-ttu-id="e8970-286">Active Directory による委任の制御は、ユーザー名/パスワード認証には適用されません。</span><span class="sxs-lookup"><span data-stu-id="e8970-286">Active Directory controls on delegation do not apply to user name and password authentication.</span></span>  
  
### <a name="delegation-ability-as-a-function-of-impersonation-level"></a><span data-ttu-id="e8970-287">偽装レベルの 1 つの機能としての委任機能</span><span class="sxs-lookup"><span data-stu-id="e8970-287">Delegation Ability as a Function of Impersonation Level</span></span>  
  
|<span data-ttu-id="e8970-288">偽装レベル</span><span class="sxs-lookup"><span data-stu-id="e8970-288">Impersonation level</span></span>|<span data-ttu-id="e8970-289">サービスがプロセス間の委任を実行できる</span><span class="sxs-lookup"><span data-stu-id="e8970-289">Service can perform cross-process delegation</span></span>|<span data-ttu-id="e8970-290">サービスがコンピューター間の委任を実行できる</span><span class="sxs-lookup"><span data-stu-id="e8970-290">Service can perform cross-machine delegation</span></span>|  
|-------------------------|---------------------------------------------------|---------------------------------------------------|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Identification>|<span data-ttu-id="e8970-291">いいえ</span><span class="sxs-lookup"><span data-stu-id="e8970-291">No</span></span>|<span data-ttu-id="e8970-292">×</span><span class="sxs-lookup"><span data-stu-id="e8970-292">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>|<span data-ttu-id="e8970-293">はい</span><span class="sxs-lookup"><span data-stu-id="e8970-293">Yes</span></span>|<span data-ttu-id="e8970-294">×</span><span class="sxs-lookup"><span data-stu-id="e8970-294">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Delegation>|<span data-ttu-id="e8970-295">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-295">Yes</span></span>|<span data-ttu-id="e8970-296">[はい]</span><span class="sxs-lookup"><span data-stu-id="e8970-296">Yes</span></span>|  
  
 <span data-ttu-id="e8970-297">委任の使用方法を次のコード例に示します。</span><span class="sxs-lookup"><span data-stu-id="e8970-297">The following code example demonstrates how to use delegation.</span></span>  
  
 [!code-csharp[c_delegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_delegation/cs/source.cs#1)]
 [!code-vb[c_delegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_delegation/vb/source.vb#1)]  
  
### <a name="how-to-configure-an-application-to-use-constrained-delegation"></a><span data-ttu-id="e8970-298">制約された委任を使用するようにアプリケーションを構成する方法</span><span class="sxs-lookup"><span data-stu-id="e8970-298">How to Configure an Application to Use Constrained Delegation</span></span>  
 <span data-ttu-id="e8970-299">制約された委任を使用するには、送信側、受信側、およびドメイン コントローラーを制約された委任を使用するように構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e8970-299">Before you can use constrained delegation, the sender, receiver, and the domain controller must be configured to do so.</span></span> <span data-ttu-id="e8970-300">制約された委任を有効にする手順を以下に示します。</span><span class="sxs-lookup"><span data-stu-id="e8970-300">The following procedure lists the steps that enable constrained delegation.</span></span> <span data-ttu-id="e8970-301">委任と制約された委任の違いの詳細については、「 [Windows Server 2003 Kerberos Extensions (Windows Server 2003 Kerberos 拡張機能)](https://go.microsoft.com/fwlink/?LinkId=100194) 」の制約された委任に関する部分を参照してください。</span><span class="sxs-lookup"><span data-stu-id="e8970-301">For details about the differences between delegation and constrained delegation, see the portion of [Windows Server 2003 Kerberos Extensions](https://go.microsoft.com/fwlink/?LinkId=100194) that discusses constrained discussion.</span></span>  
  
1.  <span data-ttu-id="e8970-302">ドメイン コントローラーで、クライアント アプリケーションを実行しているアカウントの **[アカウントは重要なので委任できない]** チェック ボックスをオフにします。</span><span class="sxs-lookup"><span data-stu-id="e8970-302">On the domain controller, clear the **Account is sensitive and cannot be delegated** check box for the account under which the client application is running.</span></span>  
  
2.  <span data-ttu-id="e8970-303">ドメイン コントローラーで、クライアント アプリケーションを実行しているアカウントの **[アカウントは委任に対して信頼されている]** チェック ボックスをオンにします。</span><span class="sxs-lookup"><span data-stu-id="e8970-303">On the domain controller, select the **Account is trusted for delegation** check box for the account under which the client application is running.</span></span>  
  
3.  <span data-ttu-id="e8970-304">ドメイン コントローラーで、 **[コンピューターを委任に対して信頼する]** をクリックして、委任に対して信頼されるように中間層コンピューターを構成します。</span><span class="sxs-lookup"><span data-stu-id="e8970-304">On the domain controller, configure the middle tier computer so that it is trusted for delegation, by clicking the **Trust computer for delegation** option.</span></span>  
  
4.  <span data-ttu-id="e8970-305">ドメイン コントローラーで、 **[指定されたサービスへの委任でのみこのコンピューターを信頼する]** をクリックして、制約された委任を使用するように中間層コンピューターを構成します。</span><span class="sxs-lookup"><span data-stu-id="e8970-305">On the domain controller, configure the middle tier computer to use constrained delegation, by clicking the **Trust this computer for delegation to specified services only** option.</span></span>  
  
 <span data-ttu-id="e8970-306">制約された委任を構成する手順の詳細については、MSDN の次のトピックを参照してください。</span><span class="sxs-lookup"><span data-stu-id="e8970-306">For more detailed instructions about configuring constrained delegation, see the following topics on MSDN:</span></span>  
  
-   [<span data-ttu-id="e8970-307">Kerberos 委任のトラブルシューティング</span><span class="sxs-lookup"><span data-stu-id="e8970-307">Troubleshooting Kerberos Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36724)  
  
-   [<span data-ttu-id="e8970-308">Kerberos プロトコルの遷移および制約委任</span><span class="sxs-lookup"><span data-stu-id="e8970-308">Kerberos Protocol Transition and Constrained Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36725)  
  
## <a name="see-also"></a><span data-ttu-id="e8970-309">関連項目</span><span class="sxs-lookup"><span data-stu-id="e8970-309">See also</span></span>
- <xref:System.ServiceModel.OperationBehaviorAttribute>
- <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A>
- <xref:System.ServiceModel.ImpersonationOption>
- <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A>
- <xref:System.ServiceModel.ServiceSecurityContext>
- <xref:System.Security.Principal.WindowsIdentity>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A>
- <xref:System.ServiceModel.ServiceHost>
- <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A>
- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.ChannelFactory%601>
- <xref:System.Security.Principal.TokenImpersonationLevel.Identification>
- [<span data-ttu-id="e8970-310">トランスポート セキュリティでの偽装の使用</span><span class="sxs-lookup"><span data-stu-id="e8970-310">Using Impersonation with Transport Security</span></span>](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md)
- [<span data-ttu-id="e8970-311">クライアントの偽装</span><span class="sxs-lookup"><span data-stu-id="e8970-311">Impersonating the Client</span></span>](../../../../docs/framework/wcf/samples/impersonating-the-client.md)
- [<span data-ttu-id="e8970-312">方法: サービスでのクライアントを偽装します。</span><span class="sxs-lookup"><span data-stu-id="e8970-312">How to: Impersonate a Client on a Service</span></span>](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)
- [<span data-ttu-id="e8970-313">ServiceModel メタデータ ユーティリティ ツール (Svcutil.exe)</span><span class="sxs-lookup"><span data-stu-id="e8970-313">ServiceModel Metadata Utility Tool (Svcutil.exe)</span></span>](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)
