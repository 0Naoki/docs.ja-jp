---
title: インターネット インフォメーション サービス ホスティングのベスト プラクティス
ms.date: 03/30/2017
ms.assetid: 0834768e-9665-46bf-86eb-d4b09ab91af5
ms.openlocfilehash: 0ca5e20b846a1b10f5a52748ff06a4af958b2f4c
ms.sourcegitcommit: 76a304c79a32aa13889ebcf4b9789a4542b48e3e
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/14/2018
ms.locfileid: "45588528"
---
# <a name="internet-information-services-hosting-best-practices"></a><span data-ttu-id="cdccc-102">インターネット インフォメーション サービス ホスティングのベスト プラクティス</span><span class="sxs-lookup"><span data-stu-id="cdccc-102">Internet Information Services Hosting Best Practices</span></span>
<span data-ttu-id="cdccc-103">このトピックでは、Windows Communication Foundation (WCF) サービスをホストするためのベスト プラクティスについて説明します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-103">This topic outlines some best practices for hosting Windows Communication Foundation (WCF) services.</span></span>  
  
## <a name="implementing-wcf-services-as-dlls"></a><span data-ttu-id="cdccc-104">WCF サービスの DLL としての実装</span><span class="sxs-lookup"><span data-stu-id="cdccc-104">Implementing WCF Services as DLLs</span></span>  
 <span data-ttu-id="cdccc-105">WCF を実装する Web アプリケーションの \bin ディレクトリに展開されている DLL としてのサービスは再利用する、Web アプリケーションのモデルの外部サービスなど、インターネット インフォメーション サービス (IIS) が展開されているがない可能性があるテスト環境でできます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-105">Implementing a WCF service as a DLL that is deployed to the \bin directory of a Web application allows you reuse the service outside of the Web application model, for example, in a test environment that may not have Internet Information Services (IIS) deployed.</span></span>  
  
## <a name="service-hosts-in-iis-hosted-applications"></a><span data-ttu-id="cdccc-106">IIS でホストされるアプリケーションでのサービス ホスト</span><span class="sxs-lookup"><span data-stu-id="cdccc-106">Service Hosts in IIS-Hosted Applications</span></span>  
 <span data-ttu-id="cdccc-107">IIS ホスト環境によってネイティブにサポートされていないネットワーク トランスポートで待機する新しいサービス ホストを作成する場合は、強制自己ホスト API を使用しないでください (たとえば、TCP サービスをホストする [!INCLUDE[iis601](../../../../includes/iis601-md.md)]。TCP 通信は、[!INCLUDE[iis601](../../../../includes/iis601-md.md)] でネイティブにサポートされていません)。</span><span class="sxs-lookup"><span data-stu-id="cdccc-107">Do not use the imperative self-host APIs to create new service hosts that listen on network transports not natively supported by the IIS hosting environment (For example, [!INCLUDE[iis601](../../../../includes/iis601-md.md)] to host TCP services, because TCP communication is not natively supported on [!INCLUDE[iis601](../../../../includes/iis601-md.md)]).</span></span> <span data-ttu-id="cdccc-108">この方法はお勧めしません。</span><span class="sxs-lookup"><span data-stu-id="cdccc-108">This approach is not recommended.</span></span> <span data-ttu-id="cdccc-109">強制的に作成されたサービス ホストは、IIS ホスト環境内で認識されないからです。</span><span class="sxs-lookup"><span data-stu-id="cdccc-109">Service hosts created imperatively are not known within the IIS hosting environment.</span></span> <span data-ttu-id="cdccc-110">重要な点は、IIS がホスト アプリケーション プールがアイドル状態であるかどうかを判断するときに、強制的に作成されたサービスによって実行される処理が IIS によって考慮されないことです。</span><span class="sxs-lookup"><span data-stu-id="cdccc-110">The critical point is that processing done by imperatively created services is not accounted for by IIS when it determines whether the hosting application pool is idle.</span></span> <span data-ttu-id="cdccc-111">この結果、強制的に作成されたサービス ホストを持つアプリケーションは、IIS ホスト プロセスを積極的に廃棄する IIS ホスト環境を持つことになります。</span><span class="sxs-lookup"><span data-stu-id="cdccc-111">The result is that applications that have such imperatively created service hosts have an IIS hosting environment that aggressively disposes of IIS host processes.</span></span>  
  
## <a name="uris-and-iis-hosted-endpoints"></a><span data-ttu-id="cdccc-112">URI と IIS でホストされるエンドポイント</span><span class="sxs-lookup"><span data-stu-id="cdccc-112">URIs and IIS-Hosted Endpoints</span></span>  
 <span data-ttu-id="cdccc-113">IIS でホストされるサービスのエンドポイントは、絶対アドレスではなく、相対 URI (Uniform Resource Identifier) を使用して構成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="cdccc-113">Endpoints for an IIS-hosted service should be configured using relative Uniform Resource Identifiers (URIs), not absolute addresses.</span></span> <span data-ttu-id="cdccc-114">これにより、エンドポイント アドレスが、ホスト アプリケーションに属する URI アドレスのセット内に確実に含まれ、メッセージに基づくアクティベーションが正常に行われるようになります。</span><span class="sxs-lookup"><span data-stu-id="cdccc-114">This guarantees that the endpoint address falls within the set of URI addresses that belong to the hosting application and ensures that message-based activation happens as expected.</span></span>  
  
## <a name="state-management-and-process-recycling"></a><span data-ttu-id="cdccc-115">状態管理とプロセスのリサイクル</span><span class="sxs-lookup"><span data-stu-id="cdccc-115">State Management and Process Recycling</span></span>  
 <span data-ttu-id="cdccc-116">IIS ホスト環境は、メモリにローカル状態を保持しないサービスに最適化されています。</span><span class="sxs-lookup"><span data-stu-id="cdccc-116">The IIS hosting environment is optimized for services that do not maintain local state in memory.</span></span> <span data-ttu-id="cdccc-117">IIS は、さまざまな外部および内部イベントに応答してホスト プロセスをリサイクルするため、メモリのみに格納される揮発性の状態はすべて失われます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-117">IIS recycles the host process in response to a variety of external and internal events, causing any volatile state stored exclusively in memory to be lost.</span></span> <span data-ttu-id="cdccc-118">IIS でホストされるサービスは、それぞれの状態をプロセスの外部 (データベースなど)、またはアプリケーションのリサイクル イベントが発生した場合に簡単に再作成できるメモリ内キャッシュに格納する必要があります。</span><span class="sxs-lookup"><span data-stu-id="cdccc-118">Services hosted in IIS should store their state external to the process (for example, in a database) or in an in-memory cache that can easily be re-created if an application recycle event occurs.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="cdccc-119">メッセージ レイヤーの信頼性とセキュリティの WCF を使用するプロトコルは、揮発性メモリ内状態を使用します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-119">The protocols WCF uses for message-layer reliability and security make use of the volatile in-memory state.</span></span> <span data-ttu-id="cdccc-120">WCF の信頼できるセッションとセキュリティ セッションは、アプリケーションのリサイクルにより予期せず終了する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="cdccc-120">WCF reliable sessions and security sessions may terminate unexpectedly due to application recycles.</span></span> <span data-ttu-id="cdccc-121">これらのプロトコルを使用して IIS でホストされるアプリケーションをいずれかがアプリケーション層の状態 (アプリケーション レイヤー構造やカスタム相関ヘッダーなど) または無効にする の関連付けの WCF で提供されているセッション キー以外の何かに依存IIS プロセスのリサイクル、ホストされるアプリケーション。</span><span class="sxs-lookup"><span data-stu-id="cdccc-121">IIS-hosted applications that make use of these protocols should either depend on something other than the WCF-provided session key for correlating application-layer state (for example, an application-layer construct or custom correlation header) or disable IIS process recycling for the hosted application.</span></span>  
  
## <a name="optimizing-performance-in-middle-tier-scenarios"></a><span data-ttu-id="cdccc-122">中間層シナリオでのパフォーマンスの最適化</span><span class="sxs-lookup"><span data-stu-id="cdccc-122">Optimizing Performance in Middle-Tier Scenarios</span></span>  
 <span data-ttu-id="cdccc-123">最適なパフォーマンス、*中間層シナリオ*-受信したメッセージに応答の他のサービスを呼び出すサービス-リモート サービスの WCF サービス クライアントを 1 回インスタンス化し、複数の受信の間で再利用要求します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-123">For optimal performance in a *middle-tier scenario*—a service that calls out to other services in response to incoming messages—instantiate the WCF service client to the remote service once and reuse it across multiple incoming requests.</span></span> <span data-ttu-id="cdccc-124">サービスの既存のクライアント インスタンスでの呼び出しに比べて負荷の高い操作は、WCF サービス クライアントをインスタンス化し、中間層シナリオでは、要求間でリモート クライアントをキャッシュすることによって個別のパフォーマンスの向上を生成します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-124">Instantiating WCF service clients is an expensive operation relative to making a service call on a pre-existing client instance, and middle-tier scenarios produce distinct performance gains by caching remote clients across requests.</span></span> <span data-ttu-id="cdccc-125">WCF サービスのクライアントでは、スレッド セーフは複数のスレッド間でクライアントへのアクセスを同期する必要はありませんのでです。</span><span class="sxs-lookup"><span data-stu-id="cdccc-125">WCF service clients are thread-safe, so it is not necessary to synchronize access to a client across multiple threads.</span></span>  
  
 <span data-ttu-id="cdccc-126">また、中間層シナリオでは、`svcutil /a` オプションによって生成された非同期 API を使用してパフォーマンスを向上させます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-126">Middle-tier scenarios also produce performance gains by using the asynchronous APIs generated by the `svcutil /a` option.</span></span> <span data-ttu-id="cdccc-127">`/a`オプションにより、 [ServiceModel メタデータ ユーティリティ ツール (Svcutil.exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)を生成する`BeginXXX/EndXXX`リモート サービスで行われる可能性のある実行の時間の長い呼び出しは、サービス操作ごとにメソッドバック グラウンド スレッドです。</span><span class="sxs-lookup"><span data-stu-id="cdccc-127">The `/a` option causes the [ServiceModel Metadata Utility Tool (Svcutil.exe)](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md) to generate `BeginXXX/EndXXX` methods for each service operation, which allows potentially long-running calls to remote services to be made on background threads.</span></span>  
  
## <a name="wcf-in-multi-homed-or-multi-named-scenarios"></a><span data-ttu-id="cdccc-128">マルチホーム シナリオまたはマルチネーム シナリオでの WCF</span><span class="sxs-lookup"><span data-stu-id="cdccc-128">WCF in Multi-Homed or Multi-named scenarios</span></span>  
 <span data-ttu-id="cdccc-129">一連のコンピューターが共通の外部名を共有する、IIS Web ファーム内の WCF サービスをデプロイすることができます (など http://www.contoso.com)は異なるホスト名によって個別にアドレス指定が、(たとえば、 http://www.contoso.com 2 台のコンピューターにトラフィックを送る可能性があります名前付き http://machine1.internal.contoso.comと http://machine2.internal.contoso.com)します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-129">You can deploy WCF services inside of an IIS Web farm, where a set of computers share a common external name (such as http://www.contoso.com) but are individually addressed by different hostnames (for example, http://www.contoso.com might direct traffic to two different machines named http://machine1.internal.contoso.com and http://machine2.internal.contoso.com).</span></span> <span data-ttu-id="cdccc-130">この展開シナリオは、WCF によって完全にサポートされますが、サービスのメタデータ (Web Services Description Language) に正しい (外部) ホスト名を表示する WCF サービスをホストする IIS Web サイトの特別な構成が必要です。</span><span class="sxs-lookup"><span data-stu-id="cdccc-130">This deployment scenario is fully supported by WCF, but requires special configuration of the IIS Web site hosting WCF services to display the correct (external) hostname in the service's metadata (Web Services Description Language).</span></span>  
  
 <span data-ttu-id="cdccc-131">生成 WCF サービス メタデータに正しいホスト名が表示されていることを確認するのには、明示的なホスト名を使用する WCF サービスをホストする IIS Web サイトの既定の id を構成します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-131">To ensure that the correct hostname appears in the service metadata WCF generates, configure the default identity for the IIS Web site that hosts WCF services to use an explicit hostname.</span></span> <span data-ttu-id="cdccc-132">Www.contoso.com ファームの内部に存在するコンピューターでの IIS サイト バインディングを使用して、\* http:80:www.contoso.com と\*: https 443:www.contoso.com します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-132">For example, computers that reside inside of the www.contoso.com farm should use an IIS site binding of \*:80:www.contoso.com for HTTP and \*:443:www.contoso.com for HTTPS.</span></span>  
  
 <span data-ttu-id="cdccc-133">Microsoft 管理コンソール (MMC) スナップインを使用して、IIS Web サイト バインディングを構成できます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-133">You can configure IIS Web site bindings by using the IIS Microsoft Management Console (MMC) snap-in.</span></span>  
  
## <a name="application-pools-running-in-different-user-contexts-overwrite-assemblies-from-other-accounts-in-the-temporary-folder"></a><span data-ttu-id="cdccc-134">異なるユーザー コンテキストで実行されるアプリケーション プールが、一時フォルダー内の他のアカウントのアセンブリを上書きする</span><span class="sxs-lookup"><span data-stu-id="cdccc-134">Application Pools Running in Different User Contexts Overwrite Assemblies from Other Accounts in the Temporary Folder</span></span>  
 <span data-ttu-id="cdccc-135">異なるユーザー コンテキストで実行されているアプリケーション プールが、一時的な [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] ファイル フォルダー内の他のアカウントのアセンブリを上書きできないようにするには、アプリケーションごとに個別の ID と一時フォルダーを使用します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-135">To ensure that application pools running in different user contexts cannot overwrite assemblies from other accounts in the temporary [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] files folder, use different identities and temporary folders for different applications.</span></span> <span data-ttu-id="cdccc-136">たとえば、/Application1 と /Application2 という 2 つの仮想アプリケーションがある場合は、2 つの異なる ID を使用して、A と B の 2 つのアプリケーション プールを作成できます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-136">For example, if you have two virtual applications /Application1 and / Application2, you can create two Application pools, A and B, with two different identities.</span></span> <span data-ttu-id="cdccc-137">アプリケーション プール A は、一方のユーザー ID (user1) の下で、アプリケーション プール B は、もう一方のユーザー ID (user2) の下で実行でき、/Application1 が A を、/Application2 が B を使用するように構成します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-137">Application pool A can run under one user identity (user1) while application pool B can run under another user identity (user2), and configure /Application1 to use A and /Application2 to use B.</span></span>  
  
 <span data-ttu-id="cdccc-138">Web.config を使用して、一時フォルダーを構成できます\< system.web/compilation/@tempFolder>。</span><span class="sxs-lookup"><span data-stu-id="cdccc-138">In Web.config, you can configure the temporary folder using \<system.web/compilation/@tempFolder>.</span></span> <span data-ttu-id="cdccc-139">、/Application1 の"c:\tempForUser1"であることができ、アプリケーション 2 の"c:\tempForUser2"であることができます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-139">For /Application1, it can be "c:\tempForUser1" and for application2 it can be "c:\tempForUser2".</span></span> <span data-ttu-id="cdccc-140">これらのフォルダーに対応する書き込みアクセス許可を 2 つの ID に与えます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-140">Grant corresponding write permission to these folders for the two identities.</span></span>  
  
 <span data-ttu-id="cdccc-141">これで、user2 は、(c:\tempForUser1 の下にある) /Application2 のコード生成フォルダーを変更できなくなります。</span><span class="sxs-lookup"><span data-stu-id="cdccc-141">Then user2 cannot change the code-generation folder for /application2 (under c:\tempForUser1).</span></span>  
  
## <a name="enabling-asynchronous-processing"></a><span data-ttu-id="cdccc-142">非同期処理の有効化</span><span class="sxs-lookup"><span data-stu-id="cdccc-142">Enabling asynchronous processing</span></span>  
 <span data-ttu-id="cdccc-143">既定では、IIS 6.0 であること、およびそれ以前にホストされる WCF サービスに送信されるメッセージは同期的に処理されます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-143">By default messages sent to a WCF service hosted under IIS 6.0 and earlier are processed in a synchronous manner.</span></span> <span data-ttu-id="cdccc-144">ASP.NET が、独自のスレッド (ASP.NET のワーカー スレッド) での WCF を呼び出すし、WCF では、別のスレッドを使用して、要求を処理します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-144">ASP.NET calls into WCF on its own thread (the ASP.NET worker thread) and WCF uses another thread to process the request.</span></span> <span data-ttu-id="cdccc-145">WCF は、その処理が完了するまで ASP.NET のワーカー スレッドに保持されます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-145">WCF holds onto the ASP.NET worker thread until it completes its processing.</span></span> <span data-ttu-id="cdccc-146">このため、要求は同期的に処理されます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-146">This leads to synchronous processing of requests.</span></span> <span data-ttu-id="cdccc-147">– WCF は保持されません ASP.NET のスレッド、要求の処理中に要求を処理するために必要なスレッドの数が減るためより高い拡張性を要求を非同期的に処理できます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-147">Processing requests asynchronously enables greater scalability because it reduces the number of threads required to process a request –WCF does not hold on to the ASP.NET thread while processing the request.</span></span> <span data-ttu-id="cdccc-148">サーバーが受信要求を抑制する方法がないために、IIS 6.0 を実行しているマシンの非同期動作の使用は推奨されません*サービスの拒否*(DOS) 攻撃を受ける。</span><span class="sxs-lookup"><span data-stu-id="cdccc-148">Use of asynchronous behavior is not recommended for machines running IIS 6.0 because there is no way to throttle incoming requests that open up the server to *Denial Of Service* (DOS) attacks.</span></span> <span data-ttu-id="cdccc-149">IIS 7.0 以降では、同時要求スロットルが導入されています`[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ASP.NET\2.0.50727.0]"MaxConcurrentRequestsPerCpu`。</span><span class="sxs-lookup"><span data-stu-id="cdccc-149">Starting with IIS 7.0, a concurrent request throttle has been introduced: `[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\ASP.NET\2.0.50727.0]"MaxConcurrentRequestsPerCpu`.</span></span> <span data-ttu-id="cdccc-150">この新しいスロットルにより、非同期処理を安全に使用することができます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-150">With this new throttle it is safe to use the asynchronous processing.</span></span>  <span data-ttu-id="cdccc-151">IIS 7.0 の既定では、非同期のハンドラーとモジュールが登録されます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-151">By default in IIS 7.0, the asynchronous handler and module are registered.</span></span> <span data-ttu-id="cdccc-152">この機能が無効になっている場合は、アプリケーションの Web.config ファイルで要求の非同期処理を手動で有効にすることができます。</span><span class="sxs-lookup"><span data-stu-id="cdccc-152">If this has been turned off, you can manually enable asynchronous processing of requests in your application's Web.config file.</span></span> <span data-ttu-id="cdccc-153">使用する設定は、`aspNetCompatibilityEnabled` 設定によって異なります。</span><span class="sxs-lookup"><span data-stu-id="cdccc-153">The settings you use depend on your `aspNetCompatibilityEnabled` setting.</span></span> <span data-ttu-id="cdccc-154">`aspNetCompatibilityEnabled` を `false` に設定している場合は、次の構成スニペットに示すように、`System.ServiceModel.Activation.ServiceHttpModule` を構成します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-154">If you have `aspNetCompatibilityEnabled` set to `false`, configure the `System.ServiceModel.Activation.ServiceHttpModule` as shown in the following configuration snippet.</span></span>  
  
```xml  
<system.serviceModel>  
    <serviceHostingEnvironment aspNetCompatibilityEnabled="false" />      
  </system.serviceModel>  
  <system.webServer>  
    <modules>  
      <remove name="ServiceModel"/>  
      <add name="ServiceModel"   
           preCondition="integratedMode,runtimeVersionv2.0"   
           type="System.ServiceModel.Activation.ServiceHttpModule, System.ServiceModel,Version=3.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"/>  
    </modules>  
    </system.webServer>  
```  
  
 <span data-ttu-id="cdccc-155">`aspNetCompatibilityEnabled` を `true` に設定している場合は、次の構成スニペットに示すように、`System.ServiceModel.Activation.ServiceHttpHandlerFactory` を構成します。</span><span class="sxs-lookup"><span data-stu-id="cdccc-155">If you have `aspNetCompatibilityEnabled` set to `true`, configure the `System.ServiceModel.Activation.ServiceHttpHandlerFactory` as shown in the following config snippet.</span></span>  
  
```xml  
<system.serviceModel>  
    <serviceHostingEnvironment aspNetCompatibilityEnabled="true" />      
  </system.serviceModel>  
  <system.webServer>  
    <handlers>  
          <clear/>  
          <add name="TestAsyncHttpHandler"   
               path="*.svc"   
               verb="*"   
               type="System.ServiceModel.Activation.ServiceHttpHandlerFactory, System.ServiceModel, Version=3.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"           
               />  
    </handlers>      
  </system.webServer>  
```  
  
## <a name="see-also"></a><span data-ttu-id="cdccc-156">関連項目</span><span class="sxs-lookup"><span data-stu-id="cdccc-156">See Also</span></span>  
 [<span data-ttu-id="cdccc-157">サービス ホスト サンプルします。</span><span class="sxs-lookup"><span data-stu-id="cdccc-157">Service Hosting Samples</span></span>](https://msdn.microsoft.com/library/f703a3f6-0fba-418a-a92f-7ce75ccfa47e)  
 [<span data-ttu-id="cdccc-158">Windows Server App Fabric のホスティング機能</span><span class="sxs-lookup"><span data-stu-id="cdccc-158">Windows Server App Fabric Hosting Features</span></span>](https://go.microsoft.com/fwlink/?LinkId=201276)
