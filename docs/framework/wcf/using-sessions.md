---
title: セッションの使用
ms.custom: ''
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: ''
ms.suite: ''
ms.technology:
- dotnet-clr
ms.tgt_pltfrm: ''
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- sessions [WCF]
ms.assetid: 864ba12f-3331-4359-a359-6d6d387f1035
caps.latest.revision: 32
author: dotnet-bot
ms.author: dotnetcontent
manager: wpickett
ms.workload:
- dotnet
ms.openlocfilehash: 172ef71bd3ae09e3c9f15cb0bdb48728a587605e
ms.sourcegitcommit: 94d33cadc5ff81d2ac389bf5f26422c227832052
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/30/2018
---
# <a name="using-sessions"></a><span data-ttu-id="7458f-102">セッションの使用</span><span class="sxs-lookup"><span data-stu-id="7458f-102">Using Sessions</span></span>
<span data-ttu-id="7458f-103">[!INCLUDE[indigo1](../../../includes/indigo1-md.md)] アプリケーションでは、 *"セッション"* がメッセージのグループを相互に関連付けて通信を行います。</span><span class="sxs-lookup"><span data-stu-id="7458f-103">In [!INCLUDE[indigo1](../../../includes/indigo1-md.md)] applications, a *session* correlates a group of messages into a conversation.</span></span> [!INCLUDE[indigo2](../../../includes/indigo2-md.md)]<span data-ttu-id="7458f-104"> セッションは、 [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] アプリケーションで使用できるセッション オブジェクトとは異なるものであり、サポートされる動作と制御する方法が異なります。</span><span class="sxs-lookup"><span data-stu-id="7458f-104"> sessions are different than the session object available in [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] applications, support different behaviors, and are controlled in different ways.</span></span> <span data-ttu-id="7458f-105">ここでは、 [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] アプリケーションのセッションで有効になる諸機能とそれらの使用方法について説明します。</span><span class="sxs-lookup"><span data-stu-id="7458f-105">This topic describes the features that sessions enable in [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] applications and how to use them.</span></span>  
  
## <a name="sessions-in-windows-communication-foundation-applications"></a><span data-ttu-id="7458f-106">Windows Communication Foundation アプリケーションのセッション</span><span class="sxs-lookup"><span data-stu-id="7458f-106">Sessions in Windows Communication Foundation Applications</span></span>  
 <span data-ttu-id="7458f-107">サービス コントラクトでセッションが必要であると指定されている場合、すべての呼び出し (つまり、呼び出しをサポートする基本的なメッセージ交換) を同じメッセージ交換の一部にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="7458f-107">When a service contract specifies that it requires a session, that contract is specifying that all calls (that is, the underlying message exchanges that support the calls) must be part of the same conversation.</span></span> <span data-ttu-id="7458f-108">セッションが許可されるが必須ではないコントラクトの場合、クライアントは、接続した後にセッションを確立できます。また、セッションを確立しないままにしておくこともできます。</span><span class="sxs-lookup"><span data-stu-id="7458f-108">If a contract specifies that it allows sessions but does not require one, clients can connect and either establish a session or not establish a session.</span></span> <span data-ttu-id="7458f-109">セッションが終了したのに、同じチャネルでメッセージが送信されると、例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="7458f-109">If the session ends and a message is sent through the same channel an exception is thrown.</span></span>  
  
 [!INCLUDE[indigo2](../../../includes/indigo2-md.md)]<span data-ttu-id="7458f-110"> セッションには、主に次のような概念的特徴があります。</span><span class="sxs-lookup"><span data-stu-id="7458f-110"> sessions have the following main conceptual features:</span></span>  
  
-   <span data-ttu-id="7458f-111">呼び出し側アプリケーション (WCF クライアント) によって明示的に開始および終了される。</span><span class="sxs-lookup"><span data-stu-id="7458f-111">They are explicitly initiated and terminated by the calling application (the WCF client).</span></span>  
  
-   <span data-ttu-id="7458f-112">セッション中に配信されたメッセージは、受信された順に処理される。</span><span class="sxs-lookup"><span data-stu-id="7458f-112">Messages delivered during a session are processed in the order in which they are received.</span></span>  
  
-   <span data-ttu-id="7458f-113">セッションはメッセージのグループを相互に関連付けて通信を行う。</span><span class="sxs-lookup"><span data-stu-id="7458f-113">Sessions correlate a group of messages into a conversation.</span></span> <span data-ttu-id="7458f-114">関連付けにはさまざまな種類があります。</span><span class="sxs-lookup"><span data-stu-id="7458f-114">Different types of correlation are possible.</span></span> <span data-ttu-id="7458f-115">たとえば、あるセッション ベースのチャネルでは、共有ネットワーク接続に基づいてメッセージが相互に関連付けられる一方、別のセッション ベースのチャネルでは、メッセージ本文にある共有タグに基づいてメッセージが相互に関連付けられます。</span><span class="sxs-lookup"><span data-stu-id="7458f-115">For instance, one session-based channel may correlate messages based on a shared network connection while another session-based channel may correlate messages based on a shared tag in the message body.</span></span> <span data-ttu-id="7458f-116">セッションから派生可能な機能は、相互関連付けの性質によって異なります。</span><span class="sxs-lookup"><span data-stu-id="7458f-116">The features that can be derived from the session depend on the nature of the correlation.</span></span>  
  
-   <span data-ttu-id="7458f-117">[!INCLUDE[indigo2](../../../includes/indigo2-md.md)] セッションに関連付けられた一般的なデータ ストアはありません。</span><span class="sxs-lookup"><span data-stu-id="7458f-117">There is no general data store associated with a [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] session.</span></span>  
  
 <span data-ttu-id="7458f-118"><xref:System.Web.SessionState.HttpSessionState?displayProperty=nameWithType> アプリケーションの [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] クラスに精通している場合は、この種のセッションと [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] セッションの間に次のような相違があることがわかります。</span><span class="sxs-lookup"><span data-stu-id="7458f-118">If you are familiar with the <xref:System.Web.SessionState.HttpSessionState?displayProperty=nameWithType> class in [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] applications and the functionality it provides, you might notice the following differences between that kind of session and [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] sessions:</span></span>  
  
-   [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)]<span data-ttu-id="7458f-119"> セッションは、常にサーバーによって開始される。</span><span class="sxs-lookup"><span data-stu-id="7458f-119"> sessions are always server-initiated.</span></span>  
  
-   [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)]<span data-ttu-id="7458f-120"> セッションは、暗黙的に順序付けされない。</span><span class="sxs-lookup"><span data-stu-id="7458f-120"> sessions are implicitly unordered.</span></span>  
  
-   [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)]<span data-ttu-id="7458f-121"> セッションは、要求全体について一般的なデータ ストレージ機構を提供する。</span><span class="sxs-lookup"><span data-stu-id="7458f-121"> sessions provide a general data storage mechanism across requests.</span></span>  
  
 <span data-ttu-id="7458f-122">このトピックでは、次の項目について説明します。</span><span class="sxs-lookup"><span data-stu-id="7458f-122">This topic describes:</span></span>  
  
-   <span data-ttu-id="7458f-123">サービス モデル レイヤーにおいてセッション ベースのバインディングを使用する場合の既定の実行動作。</span><span class="sxs-lookup"><span data-stu-id="7458f-123">The default execution behavior when using session-based bindings in the service model layer.</span></span>  
  
-   <span data-ttu-id="7458f-124">[!INCLUDE[indigo2](../../../includes/indigo2-md.md)] のセッション ベースのシステム提供バインディングが提供する機能の種類。</span><span class="sxs-lookup"><span data-stu-id="7458f-124">The types of features that the [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] session-based, system-provided bindings provide.</span></span>  
  
-   <span data-ttu-id="7458f-125">セッションの要件を宣言するコントラクトの作成方法。</span><span class="sxs-lookup"><span data-stu-id="7458f-125">How to create a contract that declares a session requirement.</span></span>  
  
-   <span data-ttu-id="7458f-126">セッションの作成と終了、およびセッションとサービス インスタンスの関係を理解し、制御する方法。</span><span class="sxs-lookup"><span data-stu-id="7458f-126">How to understand and control the creation and termination of the session and the relationship of the session to the service instance.</span></span>  
  
## <a name="default-execution-behavior-using-sessions"></a><span data-ttu-id="7458f-127">セッションを使用した既定の実行動作</span><span class="sxs-lookup"><span data-stu-id="7458f-127">Default Execution Behavior Using Sessions</span></span>  
 <span data-ttu-id="7458f-128">セッションの開始を試みるバインディングは、 *セッション ベース* のバインディングと呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="7458f-128">A binding that attempts to initiate a session is called a *session-based* binding.</span></span> <span data-ttu-id="7458f-129">サービス コントラクトで、セッション ベースのバインディングを要求、許可、または拒否するように指定するときは、サービス コントラクト インターフェイス (またはクラス) の <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A?displayProperty=nameWithType> プロパティを <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> 列挙値に設定します。</span><span class="sxs-lookup"><span data-stu-id="7458f-129">Service contracts specify that they require, permit, or refuse session-based bindings by setting the <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A?displayProperty=nameWithType> property on the service contract interface (or class) to one of the <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> enumeration values.</span></span> <span data-ttu-id="7458f-130">このプロパティの既定値は <xref:System.ServiceModel.SessionMode.Allowed>であり、その場合、クライアントが [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] サービス実装でセッション ベースのバインディングを使用すると、サービスは、提供されるセッションを確立して使用します。</span><span class="sxs-lookup"><span data-stu-id="7458f-130">By default, the value of this property is <xref:System.ServiceModel.SessionMode.Allowed>, which means that if a client uses a session-based binding with a [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] service implementation, the service establishes and uses the session provided.</span></span>  
  
 <span data-ttu-id="7458f-131">[!INCLUDE[indigo2](../../../includes/indigo2-md.md)] サービスがクライアント セッションを受け入れると、既定で次の機能が有効になります。</span><span class="sxs-lookup"><span data-stu-id="7458f-131">When a [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] service accepts a client session, the following features are enabled by default:</span></span>  
  
1.  <span data-ttu-id="7458f-132">[!INCLUDE[indigo2](../../../includes/indigo2-md.md)] クライアント オブジェクト間のすべての呼び出しは、同一のサービス インスタンスによって処理されます。</span><span class="sxs-lookup"><span data-stu-id="7458f-132">All calls between a [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client object are handled by the same service instance.</span></span>  
  
2.  <span data-ttu-id="7458f-133">さまざまなセッション ベースのバインディングによって追加機能が提供されます。</span><span class="sxs-lookup"><span data-stu-id="7458f-133">Different session-based bindings provide additional features.</span></span>  
  
## <a name="system-provided-session-types"></a><span data-ttu-id="7458f-134">システム指定のセッションの種類</span><span class="sxs-lookup"><span data-stu-id="7458f-134">System-Provided Session Types</span></span>  
 <span data-ttu-id="7458f-135">セッション ベースのバインディングは、サービス インスタンスと特定のセッションとの既定の関連付けをサポートします。</span><span class="sxs-lookup"><span data-stu-id="7458f-135">A session-based binding supports the default association of a service instance with a particular session.</span></span> <span data-ttu-id="7458f-136">ただし、前のセッション ベースのインスタンス化制御を有効にすることに加えて、セッション ベースのバインディングごとにサポートされる機能も異なります。</span><span class="sxs-lookup"><span data-stu-id="7458f-136">However, different session-based bindings support different features in addition to enabling the session-based instancing control previously described.</span></span>  
  
 [!INCLUDE[indigo2](../../../includes/indigo2-md.md)]<span data-ttu-id="7458f-137"> には、次の種類のセッション ベースのアプリケーション動作が用意されています。</span><span class="sxs-lookup"><span data-stu-id="7458f-137"> provides the following types of session-based application behavior:</span></span>  
  
-   <span data-ttu-id="7458f-138">2 者間の通信で特定のセキュリティ保護されたメッセージ交換について両者の合意が成立している場合、<xref:System.ServiceModel.Channels.SecurityBindingElement?displayProperty=nameWithType> は、セキュリティ ベースのセッションをサポートします。</span><span class="sxs-lookup"><span data-stu-id="7458f-138">The <xref:System.ServiceModel.Channels.SecurityBindingElement?displayProperty=nameWithType> supports security-based sessions, in which both ends of communication have agreed upon a specific secure conversation.</span></span> <span data-ttu-id="7458f-139">詳細については、次を参照してください。 [Services のセキュリティ保護](../../../docs/framework/wcf/securing-services.md)です。</span><span class="sxs-lookup"><span data-stu-id="7458f-139">For more information, see [Securing Services](../../../docs/framework/wcf/securing-services.md).</span></span> <span data-ttu-id="7458f-140">たとえば、セキュリティ セッションと信頼できるセッションの両方のサポートを含む <xref:System.ServiceModel.WSHttpBinding?displayProperty=nameWithType> バインディングは、既定では、メッセージを暗号化してデジタル署名を行うセキュリティで保護されたセッションのみを使用します。</span><span class="sxs-lookup"><span data-stu-id="7458f-140">For example, the <xref:System.ServiceModel.WSHttpBinding?displayProperty=nameWithType> binding, which contains support for both security sessions and reliable sessions, by default uses only a secure session that encrypts and digitally signs messages.</span></span>  
  
-   <span data-ttu-id="7458f-141"><xref:System.ServiceModel.NetTcpBinding?displayProperty=nameWithType> バインディングは、TCP/IP ベースのセッションをサポートしており、すべてのメッセージがソケット レベルの接続によって関連付けられます。</span><span class="sxs-lookup"><span data-stu-id="7458f-141">The <xref:System.ServiceModel.NetTcpBinding?displayProperty=nameWithType> binding supports TCP/IP-based sessions to ensure that all messages are correlated by the connection at the socket level.</span></span>  
  
-   <span data-ttu-id="7458f-142">WS-ReliableMessaging 仕様を実装する <xref:System.ServiceModel.Channels.ReliableSessionBindingElement?displayProperty=nameWithType> 要素は、メッセージを順番に 1 回だけ配信するように構成できる、信頼できるセッションをサポートします。これにより、メッセージ交換時にメッセージが複数のノードを通過する場合でもメッセージが受信されます。</span><span class="sxs-lookup"><span data-stu-id="7458f-142">The <xref:System.ServiceModel.Channels.ReliableSessionBindingElement?displayProperty=nameWithType> element, which implements the WS-ReliableMessaging specification, provides support for reliable sessions in which messages can be configured to be delivered in order and exactly once, ensuring messages are received even when messages travel across multiple nodes during the conversation.</span></span> <span data-ttu-id="7458f-143">詳細については、次を参照してください。[信頼できるセッション](../../../docs/framework/wcf/feature-details/reliable-sessions.md)です。</span><span class="sxs-lookup"><span data-stu-id="7458f-143">For more information, see [Reliable Sessions](../../../docs/framework/wcf/feature-details/reliable-sessions.md).</span></span>  
  
-   <span data-ttu-id="7458f-144"><xref:System.ServiceModel.NetMsmqBinding?displayProperty=nameWithType> バインディングは、MSMQ データグラム セッションを提供します。</span><span class="sxs-lookup"><span data-stu-id="7458f-144">The <xref:System.ServiceModel.NetMsmqBinding?displayProperty=nameWithType> binding provides MSMQ datagram sessions.</span></span> <span data-ttu-id="7458f-145">詳細については、次を参照してください。 [WCF のキュー](../../../docs/framework/wcf/feature-details/queues-in-wcf.md)です。</span><span class="sxs-lookup"><span data-stu-id="7458f-145">For more information, see [Queues in WCF](../../../docs/framework/wcf/feature-details/queues-in-wcf.md).</span></span>  
  
 <span data-ttu-id="7458f-146"><xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A> プロパティを設定しても、コントラクトが必要とするセッションの種類は指定されず、コントラクトがセッションを必要とすることだけが指定されます。</span><span class="sxs-lookup"><span data-stu-id="7458f-146">Setting the <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A> property does not specify the type of session the contract requires, only that it requires one.</span></span>  
  
## <a name="creating-a-contract-that-requires-a-session"></a><span data-ttu-id="7458f-147">セッションを必要とするコントラクトの作成</span><span class="sxs-lookup"><span data-stu-id="7458f-147">Creating a Contract That Requires a Session</span></span>  
 <span data-ttu-id="7458f-148">セッションを必要とするコントラクトを作成するのは、サービス コントラクトで宣言する操作のグループをすべて同じセッション内で実行し、メッセージを順番に配信する必要がある場合です。</span><span class="sxs-lookup"><span data-stu-id="7458f-148">Creating a contract that requires a session states that the group of operations that the service contract declares must all be executed within the same session and that messages must be delivered in order.</span></span> <span data-ttu-id="7458f-149">サービス コントラクトが必要とするセッションのサポート レベルをアサートするには、サービス コントラクト インターフェイスまたはクラスの <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A?displayProperty=nameWithType> プロパティを <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> 列挙値に設定して以下を指定します。</span><span class="sxs-lookup"><span data-stu-id="7458f-149">To assert the level of session support that a service contract requires, set the <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A?displayProperty=nameWithType> property on your service contract interface or class to the value of the <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> enumeration to specify whether the contract:</span></span>  
  
-   <span data-ttu-id="7458f-150">コントラクトがセッションを必要とするかどうか。</span><span class="sxs-lookup"><span data-stu-id="7458f-150">Requires a session.</span></span>  
  
-   <span data-ttu-id="7458f-151">コントラクトで、クライアントによるセッションの確立を許可するかどうか。</span><span class="sxs-lookup"><span data-stu-id="7458f-151">Allows a client to establish a session.</span></span>  
  
-   <span data-ttu-id="7458f-152">コントラクトでセッションを禁止するかどうか。</span><span class="sxs-lookup"><span data-stu-id="7458f-152">Prohibits a session.</span></span>  
  
 <span data-ttu-id="7458f-153">ただし、 <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A> プロパティを設定しても、コントラクトが必要とするセッション ベースの動作の種類は指定されません。</span><span class="sxs-lookup"><span data-stu-id="7458f-153">Setting the <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A> property does not, however, specify the type of session-based behavior the contract requires.</span></span> <span data-ttu-id="7458f-154">このプロパティは、サービスの (通信チャネルを作成する) 構成済みバインディングが、サービスの実装時にセッションを確立する、確立しない、または確立できるかを実行時に確認するよう [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] に指示します。</span><span class="sxs-lookup"><span data-stu-id="7458f-154">It instructs [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] to confirm at runtime that the configured binding (which creates the communication channel) for the service does, does not, or can establish a session when implementing a service.</span></span> <span data-ttu-id="7458f-155">ここでもバインディングは、選択する任意の種類のセッション ベースの動作 (セキュリティ セッション、トランスポート セッション、信頼できるセッション、またはこれらの一定の組み合わせ) によってこの要件を満たすことができます。</span><span class="sxs-lookup"><span data-stu-id="7458f-155">Again, the binding can satisfy that requirement with any type of session-based behavior it chooses—security, transport, reliable, or some combination.</span></span> <span data-ttu-id="7458f-156">正確な動作は、選択した <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> 値によって決まります。</span><span class="sxs-lookup"><span data-stu-id="7458f-156">The exact behavior depends on the <xref:System.ServiceModel.SessionMode?displayProperty=nameWithType> value selected.</span></span> <span data-ttu-id="7458f-157">サービスの構成済みバインディングが <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A>の値に一致しない場合は、例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="7458f-157">If the configured binding of the service does not conform to the value of <xref:System.ServiceModel.ServiceContractAttribute.SessionMode%2A>, an exception is thrown.</span></span> <span data-ttu-id="7458f-158">セッションをサポートするバインディングと、それが作成するチャネルは、セッション ベースのバインディングまたはチャネルと呼ばれます。</span><span class="sxs-lookup"><span data-stu-id="7458f-158">Bindings and the channels they create that support sessions are said to be session-based.</span></span>  
  
 <span data-ttu-id="7458f-159">次のサービス コントラクトは、 `ICalculatorSession` のすべての操作をセッション内で交換する必要があることを指定しています。</span><span class="sxs-lookup"><span data-stu-id="7458f-159">The following service contract specifies that all operations in the `ICalculatorSession` must be exchanged within a session.</span></span> <span data-ttu-id="7458f-160">`Equals` メソッドを除き、どの操作も呼び出し元に値を返しません。</span><span class="sxs-lookup"><span data-stu-id="7458f-160">None of the operations returns a value to the caller except the `Equals` method.</span></span> <span data-ttu-id="7458f-161">ただし、 `Equals` メソッドはパラメーターを受け取らないため、データが既に他の操作に渡されているセッション内では、ゼロ以外の値しか返すことができません。</span><span class="sxs-lookup"><span data-stu-id="7458f-161">However, the `Equals` method takes no parameters and, therefore, can only return a non-zero value inside a session in which data has already been passed to the other operations.</span></span> <span data-ttu-id="7458f-162">このコントラクトでは、セッションが正常に機能する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7458f-162">This contract requires a session to function properly.</span></span> <span data-ttu-id="7458f-163">特定のクライアントに関連付けられているセッションがないと、サービス インスタンスは、そのクライアントが以前に送信したデータを知ることができません。</span><span class="sxs-lookup"><span data-stu-id="7458f-163">Without a session associated with a specific client, the service instance has no way of knowing what previous data this client has sent.</span></span>  
  
 [!code-csharp[S_Service_Session#1](../../../samples/snippets/csharp/VS_Snippets_CFX/s_service_session/cs/service.cs#1)]
 [!code-vb[S_Service_Session#1](../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_service_session/vb/service.vb#1)]  
  
 <span data-ttu-id="7458f-164">サービスがセッションを許可した場合は、クライアントがセッションを開始するとセッションが確立され、使用されますが、許可しない場合は、セッションが確立されません。</span><span class="sxs-lookup"><span data-stu-id="7458f-164">If a service allows a session, then a session is established and used if the client initiates one; otherwise, no session is established.</span></span>  
  
## <a name="sessions-and-service-instances"></a><span data-ttu-id="7458f-165">セッションとサービス インスタンス</span><span class="sxs-lookup"><span data-stu-id="7458f-165">Sessions and Service Instances</span></span>  
 <span data-ttu-id="7458f-166">[!INCLUDE[indigo2](../../../includes/indigo2-md.md)]で既定のインスタンス化動作を使用した場合は、 [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] クライアント オブジェクト間のすべての呼び出しが同じサービス インスタンスによって処理されます。</span><span class="sxs-lookup"><span data-stu-id="7458f-166">If you use the default instancing behavior in [!INCLUDE[indigo2](../../../includes/indigo2-md.md)], all calls between a [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client object are handled by the same service instance.</span></span> <span data-ttu-id="7458f-167">そのため、アプリケーション レベルでは、セッションは、ローカル呼び出し動作と同様のアプリケーション動作を有効にすると考えることができます。</span><span class="sxs-lookup"><span data-stu-id="7458f-167">Therefore, at the application level, you can think of a session as enabling application behavior similar to local call behavior.</span></span> <span data-ttu-id="7458f-168">たとえば、ローカル オブジェクトを作成するときは、次のような流れになります。</span><span class="sxs-lookup"><span data-stu-id="7458f-168">For example, when you create a local object:</span></span>  
  
-   <span data-ttu-id="7458f-169">コンストラクターが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="7458f-169">A constructor is called.</span></span>  
  
-   <span data-ttu-id="7458f-170">この後に、 [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] クライアント オブジェクト参照に対して行われる呼び出しは、すべて同じオブジェクト インスタンスによって処理されます。</span><span class="sxs-lookup"><span data-stu-id="7458f-170">All subsequent calls made to the [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client object reference are processed by the same object instance.</span></span>  
  
-   <span data-ttu-id="7458f-171">オブジェクト参照が破棄されると、デストラクターが呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="7458f-171">A destructor is called when the object reference is destroyed.</span></span>  
  
 <span data-ttu-id="7458f-172">既定のサービス インスタンス動作を使用している限り、セッションでは、クライアントとサービス間で同様の動作が有効になります。</span><span class="sxs-lookup"><span data-stu-id="7458f-172">Sessions enable a similar behavior between clients and services as long as the default service instance behavior is used.</span></span> <span data-ttu-id="7458f-173">サービス コントラクトがセッションを必要としたり、サポートしたりする場合は、 <xref:System.ServiceModel.OperationContractAttribute.IsInitiating%2A> プロパティと <xref:System.ServiceModel.OperationContractAttribute.IsTerminating%2A> プロパティを設定することで、1 つ以上のコントラクト操作をセッションの開始または終了としてマークできます。</span><span class="sxs-lookup"><span data-stu-id="7458f-173">If a service contract requires or supports sessions, one or more contract operations can be marked as initiating or terminating a session by setting the <xref:System.ServiceModel.OperationContractAttribute.IsInitiating%2A> and <xref:System.ServiceModel.OperationContractAttribute.IsTerminating%2A> properties.</span></span>  
  
 <span data-ttu-id="7458f-174">*開始操作* は、新しいセッションの最初の操作として呼び出す必要がある操作です。</span><span class="sxs-lookup"><span data-stu-id="7458f-174">*Initiating operations* are those that must be called as the first operation of a new session.</span></span> <span data-ttu-id="7458f-175">開始操作以外の操作は、少なくとも 1 つの開始操作が呼び出された後にしか呼び出すことはできません。</span><span class="sxs-lookup"><span data-stu-id="7458f-175">Non-initiating operations can be called only after at least one initiating operation has been called.</span></span> <span data-ttu-id="7458f-176">そのため、サービス インスタンスの開始に適した入力をクライアントから取得するように設計された開始操作を宣言することで、サービスに対する一種のセッション コンストラクターを作成できます</span><span class="sxs-lookup"><span data-stu-id="7458f-176">You can therefore create a kind of session constructor for your service by declaring initiating operations designed to take input from clients appropriate to the beginning of the service instance.</span></span> <span data-ttu-id="7458f-177">(ただし、状態はセッションに関連付けられ、サービス オブジェクトに関連付けられません)。</span><span class="sxs-lookup"><span data-stu-id="7458f-177">(The state is associated with the session, however, and not the service object.)</span></span>  
  
 <span data-ttu-id="7458f-178">*終了操作*は、開始操作とは逆に、既存のセッションの最終メッセージとして呼び出す必要がある操作です。</span><span class="sxs-lookup"><span data-stu-id="7458f-178">*Terminating operations*, conversely, are those that must be called as the last message in an existing session.</span></span> <span data-ttu-id="7458f-179">既定では、 [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] は、サービスが関連付けられているセッションが閉じられた後に、サービス オブジェクトとそのコンテキストを再利用します。</span><span class="sxs-lookup"><span data-stu-id="7458f-179">In the default case, [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] recycles the service object and its context after the session with which the service was associated is closed.</span></span> <span data-ttu-id="7458f-180">そのため、サービス インスタンスの終了に適した関数を実行するように設計された終了操作を宣言することで、一種のデストラクターを作成できます。</span><span class="sxs-lookup"><span data-stu-id="7458f-180">You can, therefore, create a kind of destructor by declaring terminating operations designed to perform a function appropriate to the end of the service instance.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="7458f-181">既定の動作は、ローカルのコンストラクターとデストラクターに似ていますが、あくまで似ているだけです。</span><span class="sxs-lookup"><span data-stu-id="7458f-181">Although the default behavior bears a resemblance to local constructors and destructors, it is only a resemblance.</span></span> <span data-ttu-id="7458f-182">任意の [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] サービス操作を開始操作または終了操作として使用できます。また、両方を同時に兼ねることもできます。</span><span class="sxs-lookup"><span data-stu-id="7458f-182">Any [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] service operation can be an initiating or terminating operation, or both at the same time.</span></span> <span data-ttu-id="7458f-183">さらに既定では、開始操作は、任意の順序で何回でも呼び出すことができます。そのため、<xref:System.ServiceModel.InstanceContext?displayProperty=nameWithType> オブジェクトを操作することでサービス インスタンスの有効期間を明示的に制御しない限り、セッションが確立されインスタンスに関連付けられた後に、追加セッションは作成されません。</span><span class="sxs-lookup"><span data-stu-id="7458f-183">In addition, in the default case, initiating operations can be called any number of times in any order; no additional sessions are created once the session is established and associated with an instance unless you explicitly control the lifetime of the service instance (by manipulating the <xref:System.ServiceModel.InstanceContext?displayProperty=nameWithType> object).</span></span> <span data-ttu-id="7458f-184">また、状態はセッションに関連付けられ、サービス オブジェクトには関連付けられません。</span><span class="sxs-lookup"><span data-stu-id="7458f-184">Finally, the state is associated with the session and not the service object.</span></span>  
  
 <span data-ttu-id="7458f-185">たとえば、前の例で使用した `ICalculatorSession` コントラクトで、 [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] クライアント オブジェクトが、他の操作に先立って最初に `Clear` 操作を呼び出す必要があり、さらにこの [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] クライアント オブジェクトとのセッションが、 `Equals` 操作を呼び出したときに終了する必要があるとします。</span><span class="sxs-lookup"><span data-stu-id="7458f-185">For example, the `ICalculatorSession` contract used in the preceding example requires that the [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client object first call the `Clear` operation prior to any other operation and that the session with this [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client object should terminate when it calls the `Equals` operation.</span></span> <span data-ttu-id="7458f-186">次のコード例は、この要件を強制的に適用するコントラクトを示しています。</span><span class="sxs-lookup"><span data-stu-id="7458f-186">The following code example shows a contract that enforces these requirements.</span></span> <span data-ttu-id="7458f-187">セッションを開始するにはまず`Clear` を呼び出す必要があります。 `Equals` を呼び出すとセッションが終了します。</span><span class="sxs-lookup"><span data-stu-id="7458f-187">`Clear` must be called first to initiate a session, and that session ends when `Equals` is called.</span></span>  
  
 [!code-csharp[SCA.IsInitiatingIsTerminating#1](../../../samples/snippets/csharp/VS_Snippets_CFX/sca.isinitiatingisterminating/cs/service.cs#1)]
 [!code-vb[SCA.IsInitiatingIsTerminating#1](../../../samples/snippets/visualbasic/VS_Snippets_CFX/sca.isinitiatingisterminating/vb/service.vb#1)]  
  
 <span data-ttu-id="7458f-188">サービスは、クライアントとのセッションを開始しません。</span><span class="sxs-lookup"><span data-stu-id="7458f-188">Services do not start sessions with clients.</span></span> <span data-ttu-id="7458f-189">[!INCLUDE[indigo2](../../../includes/indigo2-md.md)] クライアント アプリケーションでは、セッション ベースのチャネルの有効期間とセッション自体の有効期間の間には直接的な関係があります。</span><span class="sxs-lookup"><span data-stu-id="7458f-189">In [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client applications, a direct relationship exists between the lifetime of the session-based channel and the lifetime of the session itself.</span></span> <span data-ttu-id="7458f-190">そのため、クライアントは、新しいセッション ベースのチャネルを作成することによって新しいセッションを作成し、セッション ベースのチャネルを正常に閉じることによって、既存のセッションを破棄します。</span><span class="sxs-lookup"><span data-stu-id="7458f-190">As such, clients create new sessions by creating new session-based channels and tear down existing sessions by closing session-based channels gracefully.</span></span> <span data-ttu-id="7458f-191">クライアントは、次のいずれかを呼び出してサービス エンドポイントとのセッションを開始します。</span><span class="sxs-lookup"><span data-stu-id="7458f-191">A client starts a session with a service endpoint by calling one of the following:</span></span>  
  
-   <span data-ttu-id="7458f-192"><xref:System.ServiceModel.ICommunicationObject.Open%2A?displayProperty=nameWithType> の呼び出しによって返されるチャネルの <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A?displayProperty=nameWithType>。</span><span class="sxs-lookup"><span data-stu-id="7458f-192"><xref:System.ServiceModel.ICommunicationObject.Open%2A?displayProperty=nameWithType> on the channel returned by a call to <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A?displayProperty=nameWithType>.</span></span>  
  
-   <span data-ttu-id="7458f-193"><xref:System.ServiceModel.ClientBase%601.Open%2A?displayProperty=nameWithType> [!INCLUDE[indigo2](../../../includes/indigo2-md.md)]によって生成されたクライアント オブジェクト、 [ServiceModel メタデータ ユーティリティ ツール (Svcutil.exe)](../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)です。</span><span class="sxs-lookup"><span data-stu-id="7458f-193"><xref:System.ServiceModel.ClientBase%601.Open%2A?displayProperty=nameWithType> on the [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client object generated by the [ServiceModel Metadata Utility Tool (Svcutil.exe)](../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md).</span></span>  
  
-   <span data-ttu-id="7458f-194">いずれかの型の [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] クライアント オブジェクトの開始操作 (既定では、すべての操作が開始操作です)。</span><span class="sxs-lookup"><span data-stu-id="7458f-194">An initiating operation on either type of [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client object (by default, all operations are initiating).</span></span> <span data-ttu-id="7458f-195">最初の操作が呼び出されると、 [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] クライアント オブジェクトが自動的にチャネルを開き、セッションを開始します。</span><span class="sxs-lookup"><span data-stu-id="7458f-195">When the first operation is called, the [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client object automatically opens the channel and initiates a session.</span></span>  
  
 <span data-ttu-id="7458f-196">通常は、クライアントが次のいずれかを呼び出して、サービス エンドポイントとのセッションを終了します。</span><span class="sxs-lookup"><span data-stu-id="7458f-196">Typically a client ends a session with a service endpoint by calling one of the following:</span></span>  
  
-   <span data-ttu-id="7458f-197"><xref:System.ServiceModel.ICommunicationObject.Close%2A?displayProperty=nameWithType> の呼び出しによって返されるチャネルの <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A?displayProperty=nameWithType>。</span><span class="sxs-lookup"><span data-stu-id="7458f-197"><xref:System.ServiceModel.ICommunicationObject.Close%2A?displayProperty=nameWithType> on the channel returned by a call to <xref:System.ServiceModel.ChannelFactory%601.CreateChannel%2A?displayProperty=nameWithType>.</span></span>  
  
-   <span data-ttu-id="7458f-198">Svcutil.exe によって生成された <xref:System.ServiceModel.ClientBase%601.Close%2A?displayProperty=nameWithType> クライアント オブジェクトの [!INCLUDE[indigo2](../../../includes/indigo2-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="7458f-198"><xref:System.ServiceModel.ClientBase%601.Close%2A?displayProperty=nameWithType> on the [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client object generated by Svcutil.exe.</span></span>  
  
-   <span data-ttu-id="7458f-199">いずれかの型の [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] クライアント オブジェクトの終了操作 (既定では、終了操作はありません。コントラクトで終了操作を明示的に指定する必要があります)。</span><span class="sxs-lookup"><span data-stu-id="7458f-199">A terminating operation on either type of [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client object (by default, no operations are terminating; the contract must explicitly specify a terminating operation).</span></span> <span data-ttu-id="7458f-200">最初の操作が呼び出されると、 [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] クライアント オブジェクトが自動的にチャネルを開き、セッションを開始します。</span><span class="sxs-lookup"><span data-stu-id="7458f-200">When the first operation is called, the [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] client object automatically opens the channel and initiates a session.</span></span>  
  
 <span data-ttu-id="7458f-201">例については、「 [How to: Create a Service That Requires Sessions](../../../docs/framework/wcf/feature-details/how-to-create-a-service-that-requires-sessions.md) 」、および「 [Default Service Behavior](../../../docs/framework/wcf/samples/default-service-behavior.md) 」や「 [Instancing](../../../docs/framework/wcf/samples/instancing.md) 」のサンプルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="7458f-201">For examples, see [How to: Create a Service That Requires Sessions](../../../docs/framework/wcf/feature-details/how-to-create-a-service-that-requires-sessions.md) as well as the [Default Service Behavior](../../../docs/framework/wcf/samples/default-service-behavior.md) and [Instancing](../../../docs/framework/wcf/samples/instancing.md) samples.</span></span>  
  
 <span data-ttu-id="7458f-202">クライアントとセッションに関する詳細については、次を参照してください。[にアクセスするサービスの WCF クライアントを使用して](../../../docs/framework/wcf/feature-details/accessing-services-using-a-client.md)です。</span><span class="sxs-lookup"><span data-stu-id="7458f-202">For more information about clients and sessions, see [Accessing Services Using a WCF Client](../../../docs/framework/wcf/feature-details/accessing-services-using-a-client.md).</span></span>  
  
## <a name="sessions-interact-with-instancecontext-settings"></a><span data-ttu-id="7458f-203">InstanceContext 設定と対話するセッション</span><span class="sxs-lookup"><span data-stu-id="7458f-203">Sessions Interact with InstanceContext Settings</span></span>  
 <span data-ttu-id="7458f-204">コントラクト内の <xref:System.ServiceModel.SessionMode> 列挙と、チャネルと特定のサービス オブジェクト間の関連付けを制御する <xref:System.ServiceModel.ServiceBehaviorAttribute.InstanceContextMode%2A?displayProperty=nameWithType> プロパティの間には相互作用があります。</span><span class="sxs-lookup"><span data-stu-id="7458f-204">There is an interaction between the <xref:System.ServiceModel.SessionMode> enumeration in a contract and the <xref:System.ServiceModel.ServiceBehaviorAttribute.InstanceContextMode%2A?displayProperty=nameWithType> property, which controls the association between channels and specific service objects.</span></span> <span data-ttu-id="7458f-205">詳細については、次を参照してください。[セッション、インスタンス化、および同時実行](../../../docs/framework/wcf/feature-details/sessions-instancing-and-concurrency.md)です。</span><span class="sxs-lookup"><span data-stu-id="7458f-205">For more information, see [Sessions, Instancing, and Concurrency](../../../docs/framework/wcf/feature-details/sessions-instancing-and-concurrency.md).</span></span>  
  
### <a name="sharing-instancecontext-objects"></a><span data-ttu-id="7458f-206">InstanceContext オブジェクトの共有</span><span class="sxs-lookup"><span data-stu-id="7458f-206">Sharing InstanceContext Objects</span></span>  
 <span data-ttu-id="7458f-207">ユーザーが自ら関連付けを行うことにより、どの <xref:System.ServiceModel.InstanceContext> オブジェクトに、どのセッション ベースのチャネルまたは呼び出しを関連付けるかを制御することもできます。</span><span class="sxs-lookup"><span data-stu-id="7458f-207">You can also control which session-based channel or call is associated with which <xref:System.ServiceModel.InstanceContext> object by performing that association yourself.</span></span> <span data-ttu-id="7458f-208">完全な例では、次を参照してください。 [InstanceContextSharing](http://msdn.microsoft.com/library/4a6a46d7-b7d7-4bb5-a0dd-03ffa3cbc230)です。</span><span class="sxs-lookup"><span data-stu-id="7458f-208">For a complete example, see [InstanceContextSharing](http://msdn.microsoft.com/library/4a6a46d7-b7d7-4bb5-a0dd-03ffa3cbc230).</span></span>  
  
## <a name="sessions-and-streaming"></a><span data-ttu-id="7458f-209">セッションとストリーミング</span><span class="sxs-lookup"><span data-stu-id="7458f-209">Sessions and Streaming</span></span>  
 <span data-ttu-id="7458f-210">大量のデータを転送する場合、メッセージ全体をメモリ内でバッファー化および処理するという既定動作の代わりに、 [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] のストリーミング転送モードを使用することができます。</span><span class="sxs-lookup"><span data-stu-id="7458f-210">When you have a large amount of data to transfer, the streaming transfer mode in [!INCLUDE[indigo2](../../../includes/indigo2-md.md)] is a feasible alternative to the default behavior of buffering and processing messages in memory in their entirety.</span></span> <span data-ttu-id="7458f-211">セッション ベースのバインディングでストリーミングを呼び出すと、予期しない動作を引き起こすことがあります。</span><span class="sxs-lookup"><span data-stu-id="7458f-211">You may get unexpected behavior when streaming calls with a session-based binding.</span></span> <span data-ttu-id="7458f-212">すべてのストリーミング呼び出しは単一のチャネル (データグラム チャネル) を通じて行われますが、このチャネルは使用されるバインディングがセッションを使用するように構成されている場合であっても、セッションをサポートしません。</span><span class="sxs-lookup"><span data-stu-id="7458f-212">All streaming calls are made through a single channel (the datagram channel) that does not support sessions even if the binding being used is configured to use sessions.</span></span> <span data-ttu-id="7458f-213">セッション ベースのバインディングによって複数のクライアントが同一のサービス オブジェクトに対してストリーミング呼び出しを行う場合、このサービス オブジェクトの同時実行モードが単一に設定され、インスタンス コンテキスト モードが `PerSession`に設定されていると、すべての呼び出しがこのデータグラム チャネルを通過する必要があるため、同時に処理される呼び出しは 1 つに限られることになります。</span><span class="sxs-lookup"><span data-stu-id="7458f-213">If multiple clients make streaming calls to the same service object over a session-based binding, and the service object's concurrency mode is set to single and its instance context mode is set to `PerSession`, all calls must go through the datagram channel and so only one call is processed at a time.</span></span> <span data-ttu-id="7458f-214">そのため、1 つ以上のクライアントがタイムアウトとなる可能性があります。サービス オブジェクトの `InstanceContextMode` を `PerCall` に設定するか、または同時実行モードを複数に設定することで、この問題を回避できます。</span><span class="sxs-lookup"><span data-stu-id="7458f-214">One or more clients may then time out. You can work around this issue by either setting the service object's `InstanceContextMode` to `PerCall` or Concurrency to multiple.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="7458f-215">この場合、利用可能になる "セッション" は 1 つしかないため、MaxConcurrentSessions は効力を失います。</span><span class="sxs-lookup"><span data-stu-id="7458f-215">MaxConcurrentSessions have no effect in this case because there is only one "session" available.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="7458f-216">関連項目</span><span class="sxs-lookup"><span data-stu-id="7458f-216">See Also</span></span>  
 <xref:System.ServiceModel.OperationContractAttribute.IsInitiating%2A>  
 <xref:System.ServiceModel.OperationContractAttribute.IsTerminating%2A>
