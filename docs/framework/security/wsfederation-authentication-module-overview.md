---
title: "WSFederation 認証モジュールの概要"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 02c4d5e8-f0a7-49ee-9cf5-3647578510ad
caps.latest.revision: "6"
author: BrucePerlerMS
ms.author: bruceper
manager: mbaldwin
ms.workload: dotnet
ms.openlocfilehash: b9e76cbfc0afc682f6a7cd0bc95c254d25f77954
ms.sourcegitcommit: 16186c34a957fdd52e5db7294f291f7530ac9d24
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/22/2017
---
# <a name="wsfederation-authentication-module-overview"></a><span data-ttu-id="19880-102">WSFederation 認証モジュールの概要</span><span class="sxs-lookup"><span data-stu-id="19880-102">WSFederation Authentication Module Overview</span></span>
<span data-ttu-id="19880-103">Windows Identity Foundation (WIF) は、WS-Federated Authentication Module (WS-FAM) を通じて ASP.NET アプリケーションでのフェデレーション認証をサポートします。</span><span class="sxs-lookup"><span data-stu-id="19880-103">Windows Identity Foundation (WIF) includes support for federated authentication in ASP.NET applications through the WS-Federated Authentication Module (WS-FAM).</span></span> <span data-ttu-id="19880-104">このトピックは、フェデレーション認証の動作とその使用方法の理解に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="19880-104">This topic will help you understand how federated authentication works and how to use it.</span></span>  
  
### <a name="overview-of-federated-authentication"></a><span data-ttu-id="19880-105">フェデレーション認証の概要</span><span class="sxs-lookup"><span data-stu-id="19880-105">Overview of Federated Authentication</span></span>  
 <span data-ttu-id="19880-106">2 つのドメイン間に信頼関係がある場合、フェデレーション認証により、一方の信頼するドメイン内のセキュリティ トークン サービス (STS) から、他方の信頼するドメイン内の STS へ認証情報を提供できます。</span><span class="sxs-lookup"><span data-stu-id="19880-106">Federated authentication allows a Security Token Service (STS) in one trust domain to provide authentication information to an STS in another trust domain when there is a trust relationship between the two domains.</span></span> <span data-ttu-id="19880-107">この例を次の図に示します。</span><span class="sxs-lookup"><span data-stu-id="19880-107">An example of this is shown in the following illustration.</span></span>  
  
 <span data-ttu-id="19880-108">![フェデレーション認証](../../../docs/framework/security/media/federatedauthentication.gif "FederatedAuthentication")</span><span class="sxs-lookup"><span data-stu-id="19880-108">![Federation Authentication Scenario](../../../docs/framework/security/media/federatedauthentication.gif "FederatedAuthentication")</span></span>  
  
1.  <span data-ttu-id="19880-109">Fabrikam 信頼ドメインのクライアントが、Contoso 信頼ドメインの証明書利用者 (RP) アプリケーションに要求を送信します。</span><span class="sxs-lookup"><span data-stu-id="19880-109">A client in the Fabrikam trust domain sends a request to a Relying Party (RP) application in the Contoso trust domain.</span></span>  
  
2.  <span data-ttu-id="19880-110">RP は Contoso 信頼ドメインの STS にクライアントをリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="19880-110">The RP redirects the client to an STS in the Contoso trust domain.</span></span> <span data-ttu-id="19880-111">この STS はクライアントについては関知しません。</span><span class="sxs-lookup"><span data-stu-id="19880-111">This STS has no knowledge of the client.</span></span>  
  
3.  <span data-ttu-id="19880-112">Contoso STS は Contoso 信頼ドメインと信頼関係がある Fabrikam 信頼ドメインの STS にクライアントをリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="19880-112">The Contoso STS redirects the client to an STS in the Fabrikam trust domain, with which the Contoso trust domain has a trust relationship.</span></span>  
  
4.  <span data-ttu-id="19880-113">Fabrikam STS がクライアント ID を確認し、Contoso STS にセキュリティ トークンを発行します。</span><span class="sxs-lookup"><span data-stu-id="19880-113">The Fabrikam STS verifies the client’s identity and issues a security token to the Contoso STS.</span></span>  
  
5.  <span data-ttu-id="19880-114">Contoso STS は、Fabrikam トークンを使用して RP が使用できる独自のトークンを作成したり、作成されたトークンを RP へ送信します。</span><span class="sxs-lookup"><span data-stu-id="19880-114">The Contoso STS uses the Fabrikam token to create its own token that can be used by the RP and sends it to the RP.</span></span>  
  
6.  <span data-ttu-id="19880-115">RP はセキュリティ トークンからクライアントのクレームを抽出し、承認決定を実行します。</span><span class="sxs-lookup"><span data-stu-id="19880-115">The RP extracts the client’s claims from the security token and makes an authorization decision.</span></span>  
  
### <a name="using-the-federated-authentication-module-with-aspnet"></a><span data-ttu-id="19880-116">ASP.NET を使用したフェデレーション認証モジュールの使用</span><span class="sxs-lookup"><span data-stu-id="19880-116">Using the Federated Authentication Module with ASP.NET</span></span>  
 <span data-ttu-id="19880-117"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule> (WS-FAM) は [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] アプリケーションにフェデレーション認証を追加可能にする HTTP モジュールです。</span><span class="sxs-lookup"><span data-stu-id="19880-117"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule> (WS-FAM) is an HTTP module that lets you add federated authentication to an [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] application.</span></span> <span data-ttu-id="19880-118">フェデレーション認証により、認証ロジックが STS によって処理されるので、ビジネス ロジックの作成に集中できます。</span><span class="sxs-lookup"><span data-stu-id="19880-118">Federated authentication lets authentication logic be handled by the STS and lets you focus on writing business logic.</span></span>  
  
 <span data-ttu-id="19880-119">WS-FAM を構成して、未認証の要求のリダイレクト先に対して STS を指定します。</span><span class="sxs-lookup"><span data-stu-id="19880-119">You configure the WS-FAM to specify the STS to which non-authenticated requests should be redirected.</span></span> <span data-ttu-id="19880-120">WIF では次の 2 つの方法でユーザーを認証できます。</span><span class="sxs-lookup"><span data-stu-id="19880-120">WIF lets you authenticate a user in two ways:</span></span>  
  
1.  <span data-ttu-id="19880-121">受動リダイレクト: 未認証ユーザーが保護されたリソースにアクセスしようとした場合、ログイン ページを必要とすることなく STS にリダイレクトできます。これは適切な方法です。</span><span class="sxs-lookup"><span data-stu-id="19880-121">Passive redirect: When an unauthenticated user tries to access a protected resource, and you want to simply redirect them to an STS without requiring a login page, then this is the right approach.</span></span> <span data-ttu-id="19880-122">STS はユーザーの ID を検証し、そのユーザーの適切なクレームを含むセキュリティ トークンを発行します。</span><span class="sxs-lookup"><span data-stu-id="19880-122">The STS verifies the user’s identity, and issues a security token that contains the appropriate claims for that user.</span></span> <span data-ttu-id="19880-123">このオプションでは WS-FAM を HTTP モジュールのパイプラインに追加する必要があります。</span><span class="sxs-lookup"><span data-stu-id="19880-123">This option requires the WS-FAM to be added in the HTTP Modules pipeline.</span></span> <span data-ttu-id="19880-124">Identity and Access Tool for Visual Studio 2012 を使用することで、WS-FAM を使用して STS でフェデレーションを実行するようアプリケーションの構成ファイルを変更できます。</span><span class="sxs-lookup"><span data-stu-id="19880-124">You can use the Identity and Access Tool for Visual Studio 2012 to modify your application’s configuration file to use the WS-FAM and to federate with an STS.</span></span> <span data-ttu-id="19880-125">詳細については、「[Visual Studio 2012 の ID およびアクセス ツール](../../../docs/framework/security/identity-and-access-tool-for-vs.md)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="19880-125">For more information, see [Identity and Access Tool for Visual Studio 2012](../../../docs/framework/security/identity-and-access-tool-for-vs.md).</span></span>  
  
2.  <span data-ttu-id="19880-126">RP アプリケーションのサインイン ページ用の分離コードから <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignIn%2A?displayProperty=nameWithType> メソッドまたは <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectToIdentityProvider%2A> メソッドを呼び出すことができます。</span><span class="sxs-lookup"><span data-stu-id="19880-126">You can call the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignIn%2A?displayProperty=nameWithType> method or the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectToIdentityProvider%2A> method from the code-behind for a sign-in page in your RP application.</span></span>  
  
 <span data-ttu-id="19880-127">受動リダイレクトでは、すべての通信は、クライアント (通常はブラウザー) からの応答/リダイレクトによって実行されます。</span><span class="sxs-lookup"><span data-stu-id="19880-127">In passive redirect, all communication is performed through response/redirect from the client (typically a browser).</span></span> <span data-ttu-id="19880-128">アプリケーションの HTTP パイプラインに WS-FAM を追加できます。ここで WS-FAM は未認証のユーザー要求を監視し、指定した STS にユーザーをリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="19880-128">You can add the WS-FAM to your application’s HTTP pipeline, where it watches for unauthenticated user requests and redirects users to the STS you specify.</span></span>  
  
 <span data-ttu-id="19880-129">また WS-FAM は、[!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] アプリケーションで機能をカスタマイズするための複数のイベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="19880-129">The WS-FAM also raises several events that let you customize its functionality in an [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] application.</span></span>  
  
### <a name="how-the-ws-fam-works"></a><span data-ttu-id="19880-130">WS-FAM の動作</span><span class="sxs-lookup"><span data-stu-id="19880-130">How the WS-FAM Works</span></span>  
 <span data-ttu-id="19880-131">WS-FAM は <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> クラスに実装されます。</span><span class="sxs-lookup"><span data-stu-id="19880-131">The WS-FAM is implemented in the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> class.</span></span> <span data-ttu-id="19880-132">通常、[!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] RP アプリケーションの HTTP パイプラインに WS-FAM を追加します。</span><span class="sxs-lookup"><span data-stu-id="19880-132">Typically, you add the WS-FAM to the HTTP pipeline of your [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] RP application.</span></span> <span data-ttu-id="19880-133">未認証のユーザーが保護されたリソースにアクセスしようとすると、RP は "401 authorization denied" (401 承認が拒否されました) という HTTP 応答を返します。</span><span class="sxs-lookup"><span data-stu-id="19880-133">When an unauthenticated user tries to access a protected resource, the RP returns a "401 authorization denied" HTTP response.</span></span> <span data-ttu-id="19880-134">WS-FAM は、クライアントがこれを受け取ることを許可する代わりにこの応答を先に取得し、指定されている STS にユーザーをリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="19880-134">The WS-FAM intercepts this response instead of allowing the client to receive it, then it redirects the user to the specified STS.</span></span> <span data-ttu-id="19880-135">STS はセキュリティ トークンを発行し、WS-FAM がそれを再び受け取ります。</span><span class="sxs-lookup"><span data-stu-id="19880-135">The STS issues a security token, which the WS-FAM again intercepts.</span></span> <span data-ttu-id="19880-136">WS-FAM はトークンを使用して、認証ユーザー向けに <xref:System.Security.Claims.ClaimsPrincipal> のインスタンスを作成します。これにより、通常の [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] の承認機能が機能します。</span><span class="sxs-lookup"><span data-stu-id="19880-136">The WS-FAM uses the token to create an instance of <xref:System.Security.Claims.ClaimsPrincipal> for the authenticated user, which enables regular [!INCLUDE[dnprdnshort](../../../includes/dnprdnshort-md.md)] authorization mechanisms to function.</span></span>  
  
 <span data-ttu-id="19880-137">HTTP はステートレスであるため、保護されている別のリソースにユーザーがアクセスしようとするたびに、このプロセス全体が繰り返し行われないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="19880-137">Because HTTP is stateless, we need a way to avoid repeating this whole process every time that the user tries to access another protected resource.</span></span> <span data-ttu-id="19880-138">このような場合に <xref:System.IdentityModel.Services.SessionAuthenticationModule> が役に立ちます。</span><span class="sxs-lookup"><span data-stu-id="19880-138">This is where the <xref:System.IdentityModel.Services.SessionAuthenticationModule> comes in.</span></span> <span data-ttu-id="19880-139">STS がユーザーにセキュリティ トークンを発行すると、<xref:System.IdentityModel.Services.SessionAuthenticationModule> もユーザーにセッションのセキュリティ トークンを作成して、クッキーにします。</span><span class="sxs-lookup"><span data-stu-id="19880-139">When the STS issues a security token for the user, <xref:System.IdentityModel.Services.SessionAuthenticationModule> also creates a session security token for the user and puts it in a cookie.</span></span> <span data-ttu-id="19880-140">以降の要求では、<xref:System.IdentityModel.Services.SessionAuthenticationModule> はこのクッキーを受け取り、これを使用してユーザーの <xref:System.Security.Claims.ClaimsPrincipal> を構築します。</span><span class="sxs-lookup"><span data-stu-id="19880-140">On subsequent requests, the <xref:System.IdentityModel.Services.SessionAuthenticationModule> intercepts this cookie and uses it to reconstruct the user’s <xref:System.Security.Claims.ClaimsPrincipal>.</span></span>  
  
 <span data-ttu-id="19880-141">次の図に、受動リダイレクトのケースの全体的な情報のフローを示します。</span><span class="sxs-lookup"><span data-stu-id="19880-141">The following diagram shows the overall flow of information in the passive redirect case.</span></span> <span data-ttu-id="19880-142">要求は STS を通じて自動的にリダイレクトされ、ログイン ページなしで資格情報が作成されます。</span><span class="sxs-lookup"><span data-stu-id="19880-142">The request is automatically redirected via the STS to establish credentials without a login page:</span></span>  
  
 <span data-ttu-id="19880-143">![パッシブ リダイレクトを使用するサインインのタイミング図](../../../docs/framework/security/media/signinusingpassiveredirect.gif "SignInUsingPassiveRedirect")</span><span class="sxs-lookup"><span data-stu-id="19880-143">![Timing diagram for sign&#45;in with passive redirect](../../../docs/framework/security/media/signinusingpassiveredirect.gif "SignInUsingPassiveRedirect")</span></span>  
  
 <span data-ttu-id="19880-144">次の図は、ユーザーが STS に認証されており、セキュリティ トークンが <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> によって処理されるときに発生する状況を詳細に示します。</span><span class="sxs-lookup"><span data-stu-id="19880-144">The following diagram shows more detail on what happens when the user has authenticated to the STS and their security tokens are processed by the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule>:</span></span>  
  
 <span data-ttu-id="19880-145">![パッシブ リダイレクトを使用するトークン処理のタイミング](../../../docs/framework/security/media/signinusingpassiveredirect-tokenprocessing.gif "SignInUsingPassiveRedirect_TokenProcessing")</span><span class="sxs-lookup"><span data-stu-id="19880-145">![Timing for token processing with passive redirect](../../../docs/framework/security/media/signinusingpassiveredirect-tokenprocessing.gif "SignInUsingPassiveRedirect_TokenProcessing")</span></span>  
  
 <span data-ttu-id="19880-146">次の図は、ユーザーのセキュリティ トークンがクッキーにシリアル化されていて <xref:System.IdentityModel.Services.SessionAuthenticationModule> 先に取得されている場合に発生する状況を詳細に示します。</span><span class="sxs-lookup"><span data-stu-id="19880-146">The following diagram shows more detail on what happens when the user’s security tokens have been serialized into cookies and are intercepted by the <xref:System.IdentityModel.Services.SessionAuthenticationModule>:</span></span>  
  
 <span data-ttu-id="19880-147">![コントロールを使用するサインインを示す SAM タイミング図](../../../docs/framework/security/media/signinusingconrols-sam.gif "SignInUsingConrols_SAM")</span><span class="sxs-lookup"><span data-stu-id="19880-147">![SAM timing diagram showing sign&#45;in using controls](../../../docs/framework/security/media/signinusingconrols-sam.gif "SignInUsingConrols_SAM")</span></span>  
  
### <a name="events"></a><span data-ttu-id="19880-148">イベント</span><span class="sxs-lookup"><span data-stu-id="19880-148">Events</span></span>  
 <span data-ttu-id="19880-149"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule>、<xref:System.IdentityModel.Services.SessionAuthenticationModule>、および親クラス <xref:System.IdentityModel.Services.HttpModuleBase> は、HTTP 要求処理のさまざまな段階でイベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="19880-149"><xref:System.IdentityModel.Services.WSFederationAuthenticationModule>, <xref:System.IdentityModel.Services.SessionAuthenticationModule>, and their parent class, <xref:System.IdentityModel.Services.HttpModuleBase>, raise events at various stages of processing of an HTTP request.</span></span> <span data-ttu-id="19880-150">`global.asax` アプリケーションの [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] ファイルでこれらのイベントを処理できます。</span><span class="sxs-lookup"><span data-stu-id="19880-150">You can handle these events in the `global.asax` file of your [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] application.</span></span>  
  
-   <span data-ttu-id="19880-151">ASP.NET のインフラストラクチャは、モジュールを初期化するためにモジュールの <xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> メソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="19880-151">The ASP.NET infrastructure invokes the module’s <xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> method to initialize the module.</span></span>  
  
-   <span data-ttu-id="19880-152"><xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfigurationCreated?displayProperty=nameWithType> イベントは、<xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> から派生するアプリケーションのモジュールのいずれか 1 つで ASP.NET インフラストラクチャが <xref:System.IdentityModel.Services.HttpModuleBase> メソッドを初めて呼び出す場合に発生します。</span><span class="sxs-lookup"><span data-stu-id="19880-152">The <xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfigurationCreated?displayProperty=nameWithType> event is raised when the ASP.NET infrastructure invokes the <xref:System.IdentityModel.Services.HttpModuleBase.Init%2A> method for the first time on one of the application’s modules that derive from <xref:System.IdentityModel.Services.HttpModuleBase>.</span></span> <span data-ttu-id="19880-153">このメソッドは静的な <xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfiguration%2A?displayProperty=nameWithType> のプロパティにアクセスし、これにより構成が Web.config ファイルから読み込まれます。</span><span class="sxs-lookup"><span data-stu-id="19880-153">This method accesses the static <xref:System.IdentityModel.Services.FederatedAuthentication.FederationConfiguration%2A?displayProperty=nameWithType> property, which causes configuration to be loaded from the Web.config file.</span></span> <span data-ttu-id="19880-154">このイベントが発生するのは、このプロパティに初めてアクセスした場合だけです。</span><span class="sxs-lookup"><span data-stu-id="19880-154">This event is only raised the first time this property is accessed.</span></span> <span data-ttu-id="19880-155">構成から初期化される <xref:System.IdentityModel.Services.Configuration.FederationConfiguration> オブジェクトは、イベント ハンドラーの <xref:System.IdentityModel.Services.Configuration.FederationConfigurationCreatedEventArgs.FederationConfiguration%2A?displayProperty=nameWithType> のプロパティを通じてアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="19880-155">The <xref:System.IdentityModel.Services.Configuration.FederationConfiguration> object that is initialized from configuration can be accessed through the <xref:System.IdentityModel.Services.Configuration.FederationConfigurationCreatedEventArgs.FederationConfiguration%2A?displayProperty=nameWithType> property in an event handler.</span></span> <span data-ttu-id="19880-156">構成がモジュールに適用される前に、このイベントを使用して構成を変更できます。</span><span class="sxs-lookup"><span data-stu-id="19880-156">You can use this event to modify the configuration before it is applied to any modules.</span></span> <span data-ttu-id="19880-157">Application_Start イベントでこのイベントのハンドラーを追加できます。</span><span class="sxs-lookup"><span data-stu-id="19880-157">You can add a handler for this event in the Application_Start method:</span></span>  
  
    ```  
    void Application_Start(object sender, EventArgs e)  
    {  
        FederatedAuthentication.FederationConfigurationCreated += new EventHandler<FederationConfigurationCreatedEventArgs>(FederatedAuthentication_FederationConfigurationCreated);  
    }  
    ```  
  
     <span data-ttu-id="19880-158">各モジュールが <xref:System.IdentityModel.Services.HttpModuleBase.InitializeModule%2A?displayProperty=nameWithType> と <xref:System.IdentityModel.Services.HttpModuleBase.InitializePropertiesFromConfiguration%2A?displayProperty=nameWithType> 抽象メソッドをオーバーライドします。</span><span class="sxs-lookup"><span data-stu-id="19880-158">Each module overrides the <xref:System.IdentityModel.Services.HttpModuleBase.InitializeModule%2A?displayProperty=nameWithType> and <xref:System.IdentityModel.Services.HttpModuleBase.InitializePropertiesFromConfiguration%2A?displayProperty=nameWithType> abstract methods.</span></span> <span data-ttu-id="19880-159">これらのメソッドの 1 番目は、モジュールにとって重要な ASP.NET パイプライン イベントのハンドラーを追加します。</span><span class="sxs-lookup"><span data-stu-id="19880-159">The first of these methods adds handlers for ASP.NET pipeline events that are of interest to the module.</span></span> <span data-ttu-id="19880-160">ほとんどの場合、モジュールの既定の実装で十分です。</span><span class="sxs-lookup"><span data-stu-id="19880-160">In most cases the module’s default implementation will suffice.</span></span> <span data-ttu-id="19880-161">これらのメソッドの 2 番目は、<xref:System.IdentityModel.Services.HttpModuleBase.FederationConfiguration%2A?displayProperty=nameWithType> プロパティからモジュールのプロパティを初期化します</span><span class="sxs-lookup"><span data-stu-id="19880-161">The second of these methods initializes the module’s properties from its <xref:System.IdentityModel.Services.HttpModuleBase.FederationConfiguration%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="19880-162">(これは、以前に読み込まれた構成のコピーです)。<xref:System.IdentityModel.Services.WSFederationAuthenticationModule> または <xref:System.IdentityModel.Services.SessionAuthenticationModule> から派生するクラスの構成から新しいプロパティの初期化をサポートするには、2 番目のメソッドをオーバーライドすることが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="19880-162">(This is a copy of the configuration that was loaded previously.) You may need to override this second method if you want to support the initialization of new properties from configuration in classes that you derive from <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> or <xref:System.IdentityModel.Services.SessionAuthenticationModule>.</span></span> <span data-ttu-id="19880-163">このような場合、追加された構成プロパティをサポートするために、<xref:System.IdentityModel.Configuration.IdentityConfiguration>、<xref:System.IdentityModel.Services.Configuration.WsFederationConfiguration>、または <xref:System.IdentityModel.Services.Configuration.FederationConfiguration> などの適切な構成オブジェクトから派生することが必要になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="19880-163">In such cases you would also need to derive from the appropriate configuration objects to support the added configuration properties; for example, from <xref:System.IdentityModel.Configuration.IdentityConfiguration>, <xref:System.IdentityModel.Services.Configuration.WsFederationConfiguration>, or <xref:System.IdentityModel.Services.Configuration.FederationConfiguration>.</span></span>  
  
-   <span data-ttu-id="19880-164">WS-FAM は STS によって発行されたセキュリティ トークンを受け取る場合、<xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenReceived> イベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="19880-164">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenReceived> event when it intercepts a security token that has been issued by the STS.</span></span>  
  
-   <span data-ttu-id="19880-165">WS-FAM はトークンを検証した後 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenValidated> イベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="19880-165">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SecurityTokenValidated> event after it has validated the token.</span></span>  
  
-   <span data-ttu-id="19880-166"><xref:System.IdentityModel.Services.SessionAuthenticationModule> はユーザーのセッションのセキュリティ トークンを作成するとき <xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenCreated> イベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="19880-166">The <xref:System.IdentityModel.Services.SessionAuthenticationModule> raises the <xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenCreated> event when it creates a session security token for the user.</span></span>  
  
-   <span data-ttu-id="19880-167"><xref:System.IdentityModel.Services.SessionAuthenticationModule> は、セッションのセキュリティ トークンを含むクッキーを使用してそれ以降の要求を受け取る場合、<xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenReceived> イベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="19880-167">The <xref:System.IdentityModel.Services.SessionAuthenticationModule> raises the <xref:System.IdentityModel.Services.SessionAuthenticationModule.SessionSecurityTokenReceived> event when it intercepts subsequent requests with the cookie that contains the session security token.</span></span>  
  
-   <span data-ttu-id="19880-168">WS-FAM はユーザーを発行者にリダイレクトする前に、<xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider> イベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="19880-168">Before the WS-FAM redirects the user to the issuer, it raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider> event.</span></span> <span data-ttu-id="19880-169">WS-Federation のサインイン要求は、イベントに渡される <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs.SignInRequestMessage%2A> の <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs> のプロパティを通じて利用できます。</span><span class="sxs-lookup"><span data-stu-id="19880-169">The WS-Federation sign-in request is available through the <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs.SignInRequestMessage%2A> property of the <xref:System.IdentityModel.Services.RedirectingToIdentityProviderEventArgs> passed in the event.</span></span> <span data-ttu-id="19880-170">この要求は、発行者に送信する前に変更できます。</span><span class="sxs-lookup"><span data-stu-id="19880-170">You may choose to modify the request before sending this out to the issuer.</span></span>  
  
-   <span data-ttu-id="19880-171">WS-FAM は、クッキーが正常に作成され、ユーザーがサインインしている場合に、<xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignedIn> イベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="19880-171">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SignedIn> event when the cookie is successfully written and the user is signed in.</span></span>  
  
-   <span data-ttu-id="19880-172">WS-FAM は、各ユーザーのセッションが閉じられる際に各セッションにつき 1 回 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SigningOut> イベントを発生させます。</span><span class="sxs-lookup"><span data-stu-id="19880-172">The WS-FAM raises the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SigningOut> event one time per session as the session is being closed down for each user.</span></span> <span data-ttu-id="19880-173">セッションがクライアント側で閉じられた場合、このイベントは発生しません (たとえば、セッション クッキーを削除するなど)。</span><span class="sxs-lookup"><span data-stu-id="19880-173">It is not raised if the session is closed down on the client-side (for example, by deleting the session cookie).</span></span> <span data-ttu-id="19880-174">SSO 環境では、IP-STS は各 RP にサインアウトするよう要求することもできます。</span><span class="sxs-lookup"><span data-stu-id="19880-174">In an SSO environment, the IP-STS can request each RP to sign out, too.</span></span> <span data-ttu-id="19880-175">また、これによりこのイベントが発生し、<xref:System.IdentityModel.Services.SigningOutEventArgs.IsIPInitiated%2A> は `true` に設定されます。</span><span class="sxs-lookup"><span data-stu-id="19880-175">This will also raise this event, with <xref:System.IdentityModel.Services.SigningOutEventArgs.IsIPInitiated%2A> set to `true`.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="19880-176"><xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> または <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> により発生したイベント中は、<xref:System.IdentityModel.Services.SessionAuthenticationModule> プロパティを使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="19880-176">You should not use the <xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> property during any event raised by <xref:System.IdentityModel.Services.WSFederationAuthenticationModule> or <xref:System.IdentityModel.Services.SessionAuthenticationModule>.</span></span> <span data-ttu-id="19880-177">これは、イベントは認証プロセス中に発生するが、<xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> は認証プロセスの後に設定されるためです。</span><span class="sxs-lookup"><span data-stu-id="19880-177">This is because <xref:System.Threading.Thread.CurrentPrincipal%2A?displayProperty=nameWithType> is set after the authentication process, while events are raised during the authentication process.</span></span>  
  
### <a name="configuration-of-federated-authentication"></a><span data-ttu-id="19880-178">フェデレーション認証の構成</span><span class="sxs-lookup"><span data-stu-id="19880-178">Configuration of Federated Authentication</span></span>  
 <span data-ttu-id="19880-179">WS-FAM と SAM は [\<federationConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/federationconfiguration.md) 要素で構成されます。</span><span class="sxs-lookup"><span data-stu-id="19880-179">The WS-FAM and SAM are configured through the [\<federationConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/federationconfiguration.md) element.</span></span> <span data-ttu-id="19880-180">[\<wsFederation>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/wsfederation.md) の子要素は、WS-FAM プロパティの既定値 (<xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Issuer%2A> プロパティや <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Realm%2A> プロパティなど) を構成します</span><span class="sxs-lookup"><span data-stu-id="19880-180">The [\<wsFederation>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/wsfederation.md) child element configures default values for the WS-FAM properties; such as the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Issuer%2A> property and the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.Realm%2A> property.</span></span> <span data-ttu-id="19880-181">(これらの値は、一部の WS-FAM イベントのハンドラーを用意することにより要求ごとに変更できます (<xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider> など))。SAM で使用される cookie ハンドラーは [\<cookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/cookiehandler.md) 子要素によって構成されます。</span><span class="sxs-lookup"><span data-stu-id="19880-181">(These values can be changed on a per request basis by providing handlers for some of the WS-FAM events; for example, <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.RedirectingToIdentityProvider>.) The cookie handler that is used by the SAM is configured through the [\<cookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/cookiehandler.md) child element.</span></span> <span data-ttu-id="19880-182">WIF には <xref:System.IdentityModel.Services.ChunkedCookieHandler> クラスに実装されている既定の cookie ハンドラーが用意されており、チャンク サイズは [\<chunkedCookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/chunkedcookiehandler.md) 要素で設定できます。</span><span class="sxs-lookup"><span data-stu-id="19880-182">WIF provides a default cookie handler implemented in the <xref:System.IdentityModel.Services.ChunkedCookieHandler> class that can have its chunk size set through the [\<chunkedCookieHandler>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/chunkedcookiehandler.md) element.</span></span> <span data-ttu-id="19880-183">`<federationConfiguration>` 要素は <xref:System.IdentityModel.Configuration.IdentityConfiguration> を参照し、この要素にはアプリケーションで使用される他の WIF コンポーネント (<xref:System.Security.Claims.ClaimsAuthenticationManager>、<xref:System.Security.Claims.ClaimsAuthorizationManager> など) の構成が用意されています。</span><span class="sxs-lookup"><span data-stu-id="19880-183">The `<federationConfiguration>` element references an <xref:System.IdentityModel.Configuration.IdentityConfiguration>, which provides configuration for other WIF components used in the application, such as the <xref:System.Security.Claims.ClaimsAuthenticationManager> and the <xref:System.Security.Claims.ClaimsAuthorizationManager>.</span></span> <span data-ttu-id="19880-184">ID の構成は、`<federationConfiguration>` 要素の `identityConfigurationName` 属性で [\<identityConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/identityconfiguration.md) 名前付き要素を指定することで明示的に参照できます。</span><span class="sxs-lookup"><span data-stu-id="19880-184">The identity configuration may be referenced explicitly by specifying a named [\<identityConfiguration>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/identityconfiguration.md) element in the `identityConfigurationName` attribute of the `<federationConfiguration>` element.</span></span> <span data-ttu-id="19880-185">ID 構成を明示的に参照しない場合、既定の ID 構成が使用されます。</span><span class="sxs-lookup"><span data-stu-id="19880-185">If the identity configuration is not referenced explicitly, the default identity configuration will be used.</span></span>  
  
 <span data-ttu-id="19880-186">次の XML は、ASP.NET の証明書利用者 (RP) アプリケーションの構成を示します。</span><span class="sxs-lookup"><span data-stu-id="19880-186">The following XML shows a configuration of an ASP.NET relying party (RP) application.</span></span> <span data-ttu-id="19880-187"><xref:System.IdentityModel.Configuration.SystemIdentityModelSection> および <xref:System.IdentityModel.Services.Configuration.SystemIdentityModelServicesSection> 構成セクションは `<configSections>` 要素の下に追加されます。</span><span class="sxs-lookup"><span data-stu-id="19880-187">The <xref:System.IdentityModel.Configuration.SystemIdentityModelSection> and <xref:System.IdentityModel.Services.Configuration.SystemIdentityModelServicesSection> configuration sections are added under the `<configSections>` element.</span></span> <span data-ttu-id="19880-188">SAM および WS-FAM は、`<system.webServer>`/`<modules>` 要素の下にある HTTP モジュールに追加されます。</span><span class="sxs-lookup"><span data-stu-id="19880-188">The SAM and WS-FAM are added to the HTTP Modules under the `<system.webServer>`/`<modules>` element.</span></span> <span data-ttu-id="19880-189">最後に、WIF コンポーネントは `<system.identityModel>`/`<identityConfiguration>` および `<system.identityModel.services>`/`<federationConfiguration>` 要素の下に構成されます。</span><span class="sxs-lookup"><span data-stu-id="19880-189">Finally the WIF components are configured under the `<system.identityModel>`/`<identityConfiguration>` and `<system.identityModel.services>`/`<federationConfiguration>` elements.</span></span> <span data-ttu-id="19880-190">この構成では、既定のクッキー ハンドラーであり、`<cookieHandler>` 要素で指定されたクッキー ハンドラー型ではない、チャンクされたクッキー ハンドラーを指定します。</span><span class="sxs-lookup"><span data-stu-id="19880-190">This configuration specifies the chunked cookie handler as it is the default cookie handler and there is not a cookie handler type specified in the `<cookieHandler>` element.</span></span>  
  
> [!WARNING]
>  <span data-ttu-id="19880-191">次の例では、`requireHttps` 要素の `<wsFederation>` 属性と `requireSsl` 要素の `<cookieHandler>` 属性は `false` です。</span><span class="sxs-lookup"><span data-stu-id="19880-191">In the following example, both the `requireHttps` attribute of the `<wsFederation>` element and the `requireSsl` attribute of the `<cookieHandler>` element are `false`.</span></span> <span data-ttu-id="19880-192">これは、セキュリティ上の脅威になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="19880-192">This presents a potential security threat.</span></span> <span data-ttu-id="19880-193">稼働環境では、これらの値は両方とも `true` に設定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="19880-193">In production, both these values should be set `true`.</span></span>  
  
```xml  
<configuration>  
  <configSections>  
    <section name="system.identityModel" type="System.IdentityModel.Configuration.SystemIdentityModelSection, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089" />  
    <section name="system.identityModel.services" type="System.IdentityModel.Services.Configuration.SystemIdentityModelServicesSection, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089" />  
  </configSections>  
  
  ...  
  
  <system.webServer>  
    <modules>  
      <add name="WSFederationAuthenticationModule" type="System.IdentityModel.Services.WSFederationAuthenticationModule, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="managedHandler" />  
      <add name="SessionAuthenticationModule" type="System.IdentityModel.Services.SessionAuthenticationModule, System.IdentityModel.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" preCondition="managedHandler" />  
    </modules>  
  </system.webServer>  
  
  <system.identityModel>  
    <identityConfiguration>  
      <audienceUris>  
        <add value="http://localhost:50969/" />  
      </audienceUris>  
      <certificateValidation certificateValidationMode="None" />  
      <issuerNameRegistry type="System.IdentityModel.Tokens.ConfigurationBasedIssuerNameRegistry, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089">  
        <trustedIssuers>  
          <add thumbprint="9B74CB2F320F7AAFC156E1252270B1DC01EF40D0" name="LocalSTS" />  
        </trustedIssuers>  
      </issuerNameRegistry>  
    </identityConfiguration>  
  </system.identityModel>  
  <system.identityModel.services>  
    <federationConfiguration>  
      <wsFederation passiveRedirectEnabled="true" issuer="http://localhost:15839/wsFederationSTS/Issue" realm="http://localhost:50969/" reply="http://localhost:50969/" requireHttps="false" />  
      <cookieHandler requireSsl="false" />  
    </federationConfiguration>  
  </system.identityModel.services>  
</configuration>  
```  
  
## <a name="see-also"></a><span data-ttu-id="19880-194">参照</span><span class="sxs-lookup"><span data-stu-id="19880-194">See Also</span></span>  
 <xref:System.IdentityModel.Services.SessionAuthenticationModule>  
 <xref:System.IdentityModel.Services.WSFederationAuthenticationModule>  
 [<span data-ttu-id="19880-195">\<federationConfiguration></span><span class="sxs-lookup"><span data-stu-id="19880-195">\<federationConfiguration></span></span>](../../../docs/framework/configure-apps/file-schema/windows-identity-foundation/federationconfiguration.md)
