---
title: "アンマネージ コードの安全なコーディングのガイドライン"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- code security, unmanaged code
- unmanaged code, securing
- security [.NET Framework], unmanaged code
- secure coding, unmanaged code
ms.assetid: a8d15139-d368-4c9c-a747-ba757781117c
caps.latest.revision: "13"
author: mairaw
ms.author: mairaw
manager: wpickett
ms.workload: dotnet
ms.openlocfilehash: adbdd005bba9e7276a77f2e78c53be43fdceffae
ms.sourcegitcommit: 16186c34a957fdd52e5db7294f291f7530ac9d24
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/22/2017
---
# <a name="secure-coding-guidelines-for-unmanaged-code"></a><span data-ttu-id="e6e1e-102">アンマネージ コードの安全なコーディングのガイドライン</span><span class="sxs-lookup"><span data-stu-id="e6e1e-102">Secure Coding Guidelines for Unmanaged Code</span></span>
<span data-ttu-id="e6e1e-103">一部のライブラリ コードは、アンマネージ コードを呼び出す必要があります (たとえば、Win32 などのネイティブ コード API)。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-103">Some library code needs to call into unmanaged code (for example, native code APIs, such as Win32).</span></span> <span data-ttu-id="e6e1e-104">これは、マネージ コード用のセキュリティの境界の外部に出ることなので、注意が必要です。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-104">Because this means going outside the security perimeter for managed code, due caution is required.</span></span> <span data-ttu-id="e6e1e-105">セキュリティ的に中立なコードである場合、コードとそのコードを呼び出すコードは、アンマネージ コードのアクセス許可 (<xref:System.Security.Permissions.SecurityPermission> フラグを指定した <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> ) を持つ必要があります。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-105">If your code is security-neutral, both your code and any code that calls it must have unmanaged code permission (<xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> flag specified).</span></span>  
  
 <span data-ttu-id="e6e1e-106">しかし、呼び出し元がこのような強力なアクセス許可を持つことが不適切な場合もあります。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-106">However, it is often unreasonable for your caller to have such powerful permissions.</span></span> <span data-ttu-id="e6e1e-107">このようなケースでは、信頼されるコードが、「 [ラッパー コードの保護](../../../docs/framework/misc/securing-wrapper-code.md)」で説明したマネージ ラッパーまたはライブラリ コードのように、仲介役になってしまう可能性があります。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-107">In such cases, your trusted code can be the go-between, similar to the managed wrapper or library code described in [Securing Wrapper Code](../../../docs/framework/misc/securing-wrapper-code.md).</span></span> <span data-ttu-id="e6e1e-108">基になるアンマネージ コードの機能が総合的に安全な場合は、それを直接公開できます。それ以外の場合は、最初に適切なアクセス許可のチェック (確認要求: demand) が必要です。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-108">If the underlying unmanaged code functionality is totally safe, it can be directly exposed; otherwise, a suitable permission check (demand) is required first.</span></span>  
  
 <span data-ttu-id="e6e1e-109">コードがアンマネージ コードを呼び出すとき、呼び出し元にアンマネージ コードへのアクセス許可を与えたくない場合は、その権限をアサートする必要があります。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-109">When your code calls into unmanaged code but you do not want to require your callers to have permission to access unmanaged code, you must assert that right.</span></span> <span data-ttu-id="e6e1e-110">アサーションは、フレーム内でのスタック ウォークをブロックします。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-110">An assertion blocks the stack walk at your frame.</span></span> <span data-ttu-id="e6e1e-111">このプロセスで、セキュリティ ホールを作らないように注意が必要です。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-111">You must be careful that you do not create a security hole in this process.</span></span> <span data-ttu-id="e6e1e-112">通常、これは、呼び出し元の適切なアクセス許可を確認要求し、アンマネージ コードを使用して、アクセス許可で認められていることだけを実行し、それ以上のことは実行しないことを意味します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-112">Usually, this means that you must demand a suitable permission of your callers and then use unmanaged code to perform only what that permission allows and no more.</span></span> <span data-ttu-id="e6e1e-113">日付関数の時刻の取得など、いくつかのケースでは、セキュリティ チェックを一切行わずにアンマネージ コードを呼び出し元に直接公開することがあります。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-113">In some cases (for example, a get time-of-day function), unmanaged code can be directly exposed to callers without any security checks.</span></span> <span data-ttu-id="e6e1e-114">どのようなケースでも、アサートを行うコードはセキュリティ対策を実施することが必要です。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-114">In any case, any code that asserts must take responsibility for security.</span></span>  
  
 <span data-ttu-id="e6e1e-115">ネイティブ コードへのコード パスを提供するどのようなマネージ コードも、悪意のあるコードのターゲットになる可能性があります。このため、安全に使用できるアンマネージ コードやその使用方法を決めるには、十分な注意が必要です。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-115">Because any managed code that provides a code path into native code is a potential target for malicious code, determining which unmanaged code can be safely used and how it must be used requires extreme care.</span></span> <span data-ttu-id="e6e1e-116">一般に、どのアンマネージ コードも、部分的な信頼の呼び出し元に直接公開するべきではありません。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-116">Generally, unmanaged code should never be directly exposed to partially trusted callers.</span></span> <span data-ttu-id="e6e1e-117">部分的な信頼のコードから呼び出せるアンマネージ コードをライブラリで使用することの安全性を評価するには、主に次の 2 つの点について考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-117">There are two primary considerations in evaluating the safety of unmanaged code use in libraries that are callable by partially trusted code:</span></span>  
  
-   <span data-ttu-id="e6e1e-118">**機能**。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-118">**Functionality**.</span></span> <span data-ttu-id="e6e1e-119">呼び出し元が危険性のある操作を実行できないようにする機能がアンマネージ API によって提供されているかどうかを考慮します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-119">Does the unmanaged API provide functionality that does not allow callers to perform potentially dangerous operations?</span></span> <span data-ttu-id="e6e1e-120">コード アクセス セキュリティはアクセス許可を使用してリソースへのアクセスを強制するため、API がファイル、ユーザー インターフェイス、またはスレッドを使用するかどうか、あるいは、保護されている情報を公開するかどうかを考慮します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-120">Code access security uses permissions to enforce access to resources, so consider whether the API uses files, a user interface, or threading, or whether it exposes protected information.</span></span> <span data-ttu-id="e6e1e-121">API がこれを行うときは、それをラップするマネージ コードが、実行前に必要なアクセス許可を確認要求する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-121">If it does, the managed code wrapping it must demand the necessary permissions before allowing it to be entered.</span></span> <span data-ttu-id="e6e1e-122">また、アクセス許可で保護されていない場合は、メモリへのアクセスを厳密なタイプ セーフに制限する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-122">Additionally, while not protected by a permission, memory access must be confined to strict type safety.</span></span>  
  
-   <span data-ttu-id="e6e1e-123">**パラメーターのチェック**。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-123">**Parameter checking**.</span></span> <span data-ttu-id="e6e1e-124">一般的な攻撃は、公開されているアンマネージ コードの API メソッドに予期しないパラメーターを渡し、仕様とは異なる動作をさせようと試みます。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-124">A common attack passes unexpected parameters to exposed unmanaged code API methods in an attempt to cause them to operate out of specification.</span></span> <span data-ttu-id="e6e1e-125">範囲外のインデックス値やオフセット値を使用するバッファー オーバーラン攻撃は、この種の攻撃の一例であり、パラメーターの基のコードのバグを攻略します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-125">Buffer overruns using out-of-range index or offset values are one common example of this type of attack, as are any parameters that might exploit a bug in the underlying code.</span></span> <span data-ttu-id="e6e1e-126">このため、アンマネージ コード API が部分的な信頼の呼び出し元に対して安全に機能している場合でも (必要な確認要求の後)、マネージ コードもパラメーターの正当性を二重にチェックし、悪意のあるコードが、マネージ コードのラッパー レイヤーを使用して予期しない呼び出しを行うのを不可能にすることが必要です。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-126">Thus, even if the unmanaged code API is functionally safe (after necessary demands) for partially trusted callers, managed code must also check parameter validity exhaustively to ensure that no unintended calls are possible from malicious code using the managed code wrapper layer.</span></span>  
  
## <a name="using-suppressunmanagedcodesecurityattribute"></a><span data-ttu-id="e6e1e-127">SuppressUnmanagedCodeSecurityAttribute の使用</span><span class="sxs-lookup"><span data-stu-id="e6e1e-127">Using SuppressUnmanagedCodeSecurityAttribute</span></span>  
 <span data-ttu-id="e6e1e-128">アサートの後でアンマネージ コードを呼び出すのは、パフォーマンスの面で問題があります。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-128">There is a performance aspect to asserting and then calling unmanaged code.</span></span> <span data-ttu-id="e6e1e-129">このような呼び出しのたびに、セキュリティ システムはアンマネージ コードのアクセス許可を自動的に確認要求し、結果として毎回スタック ウォークが発生します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-129">For every such call, the security system automatically demands unmanaged code permission, resulting in a stack walk each time.</span></span> <span data-ttu-id="e6e1e-130">アサート直後にアンマネージ コードを呼び出すと、スタック ウォークは意味がなくなります。それは、アサートとアンマネージ コードの呼び出しで構成されるからです。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-130">If you assert and immediately call unmanaged code, the stack walk can be meaningless: it consists of your assert and your unmanaged code call.</span></span>  
  
 <span data-ttu-id="e6e1e-131"><xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> というカスタム属性をアンマネージ コードのエントリ ポイントに適用して、 <xref:System.Security.Permissions.SecurityPermission> アクセス許可を指定した <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> を確認要求する通常のセキュリティ チェックを無効にできます。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-131">A custom attribute called <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> can be applied to unmanaged code entry points to disable the normal security check that demands <xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> permission specified.</span></span> <span data-ttu-id="e6e1e-132">このアクションは、実行時のセキュリティ チェックがない状態で、アンマネージ コードに通じるドアを開くことになるため、これを実行するときは大きな注意が必要です。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-132">Extreme caution must always be taken when doing this, because this action creates an open door into unmanaged code with no runtime security checks.</span></span> <span data-ttu-id="e6e1e-133">**SuppressUnmanagedCodeSecurityAttribute** を適用した場合でも、Just-In-Time (JIT) コンパイル時に 1 回だけセキュリティ チェックが発生し、直前の呼び出し元がアンマネージ コードを呼び出すアクセス許可を持っていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-133">It should be noted that even with **SuppressUnmanagedCodeSecurityAttribute** applied, there is a one-time security check that happens at just-in-time (JIT) compilation to ensure that the immediate caller has permission to call unmanaged code.</span></span>  
  
 <span data-ttu-id="e6e1e-134">**SuppressUnmanagedCodeSecurityAttribute**を使用する場合は、次の点をチェックしてください。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-134">If you use the **SuppressUnmanagedCodeSecurityAttribute**, check the following points:</span></span>  
  
-   <span data-ttu-id="e6e1e-135">アンマネージ コードのエントリ ポイントを内部にするか、またはコード外からはアクセスできないようにします。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-135">Make the unmanaged code entry point internal or otherwise inaccessible outside your code.</span></span>  
  
-   <span data-ttu-id="e6e1e-136">アンマネージ コードを呼び出すと、セキュリティ ホールになる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-136">Any call into unmanaged code is a potential security hole.</span></span> <span data-ttu-id="e6e1e-137">悪意のあるコードが間接的にアンマネージ コードを呼び出し、セキュリティ チェックを回避するポータルとして、自分のコードが使用されていないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-137">Make sure your code is not a portal for malicious code to indirectly call into unmanaged code and avoid a security check.</span></span> <span data-ttu-id="e6e1e-138">必要な場合は、アクセス許可を確認要求します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-138">Demand permissions, if appropriate.</span></span>  
  
-   <span data-ttu-id="e6e1e-139">以下のセクションで説明されているように、アンマネージ コードへの危険なパスを作成するときは、名前付け規則を使用して明示的に識別します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-139">Use a naming convention to explicitly identify when you are creating a dangerous path into unmanaged code, as described in the section below..</span></span>  
  
## <a name="naming-convention-for-unmanaged-code-methods"></a><span data-ttu-id="e6e1e-140">アンマネージ コード メソッド用の名前付け規則</span><span class="sxs-lookup"><span data-stu-id="e6e1e-140">Naming convention for unmanaged code methods</span></span>  
 <span data-ttu-id="e6e1e-141">有用な名前付け規則がアンマネージ コード メソッド用に確立されているので、使用されることを強くお勧めします。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-141">A useful and highly recommended convention has been established for naming unmanaged code methods.</span></span> <span data-ttu-id="e6e1e-142">すべてのアンマネージ コード メソッドは、 **safe**、 **native**、 **unsafe**の 3 つのカテゴリに分類されます。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-142">All unmanaged code methods are separated into three categories: **safe**, **native**, and **unsafe**.</span></span> <span data-ttu-id="e6e1e-143">これらのキーワードは、内部にさまざまな種類のアンマネージ コード エントリ ポイントを定義するクラス名として使用できます。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-143">These keywords can be used as class names within which the various kinds of unmanaged code entry points are defined.</span></span> <span data-ttu-id="e6e1e-144">ソース コードでは、これらのキーワードをクラス名に追加する必要があります。たとえば、 `Safe.GetTimeOfDay`、 `Native.Xyz`、または `Unsafe.DangerousAPI`のように表記します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-144">In source code, these keywords should be added to the class name, as in `Safe.GetTimeOfDay`, `Native.Xyz`, or `Unsafe.DangerousAPI`, for example.</span></span> <span data-ttu-id="e6e1e-145">次の表に示すように、各キーワードはそのクラスを使用する開発者に有用なセキュリティ情報を提供します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-145">Each of these keywords provides useful security information for developers using that class, as described in the following table.</span></span>  
  
|<span data-ttu-id="e6e1e-146">キーワード</span><span class="sxs-lookup"><span data-stu-id="e6e1e-146">Keyword</span></span>|<span data-ttu-id="e6e1e-147">セキュリティの考慮事項</span><span class="sxs-lookup"><span data-stu-id="e6e1e-147">Security considerations</span></span>|  
|-------------|-----------------------------|  
|<span data-ttu-id="e6e1e-148">**safe**</span><span class="sxs-lookup"><span data-stu-id="e6e1e-148">**safe**</span></span>|<span data-ttu-id="e6e1e-149">任意のコードにとって (悪意のあるコードにも)、呼び出すことがまったく安全です。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-149">Completely harmless for any code, even malicious code, to call.</span></span> <span data-ttu-id="e6e1e-150">他のマネージ コードと同じように使用できます。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-150">Can be used just like other managed code.</span></span> <span data-ttu-id="e6e1e-151">たとえば、1 日の時刻を取得する関数は典型的に安全です。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-151">For example, a function that gets the time of day is typically safe.</span></span>|  
|<span data-ttu-id="e6e1e-152">**native**</span><span class="sxs-lookup"><span data-stu-id="e6e1e-152">**native**</span></span>|<span data-ttu-id="e6e1e-153">セキュリティに中立的。つまり、呼び出すためにアンマネージ コードのアクセス許可を必要とするアンマネージ コードです。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-153">Security-neutral; that is, unmanaged code that requires unmanaged code permission to call.</span></span> <span data-ttu-id="e6e1e-154">セキュリティがチェックされ、承認のない呼び出し元は停止されます。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-154">Security is checked, which stops an unauthorized caller.</span></span>|  
|<span data-ttu-id="e6e1e-155">**unsafe**</span><span class="sxs-lookup"><span data-stu-id="e6e1e-155">**unsafe**</span></span>|<span data-ttu-id="e6e1e-156">セキュリティが抑止された、危険性のあるアンマネージ コード エントリ ポイントです。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-156">Potentially dangerous unmanaged code entry point with security suppressed.</span></span> <span data-ttu-id="e6e1e-157">このようなアンマネージ コードを使用するとき、開発者は最大限の注意を払う必要があり、セキュリティ脆弱性を避けるための別の手段の保護機能が設定されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-157">Developers should use the greatest caution when using such unmanaged code, making sure that other protections are in place to prevent a security vulnerability.</span></span> <span data-ttu-id="e6e1e-158">このキーワードはセキュリティ システムをオーバーライドするため、開発者がセキュリティ対策を行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="e6e1e-158">Developers must be responsible, as this keyword overrides the security system.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="e6e1e-159">参照</span><span class="sxs-lookup"><span data-stu-id="e6e1e-159">See Also</span></span>  
 [<span data-ttu-id="e6e1e-160">安全なコーディングのガイドライン</span><span class="sxs-lookup"><span data-stu-id="e6e1e-160">Secure Coding Guidelines</span></span>](../../../docs/standard/security/secure-coding-guidelines.md)
