---
title: トランザクションとバルク コピー操作
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: bf40d0963c29209d4e8f7e4850f0c99b6702a6bb
ms.sourcegitcommit: 155012a8a826ee8ab6aa49b1b3a3b532e7b7d9bd
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/04/2019
ms.locfileid: "66487625"
---
# <a name="transaction-and-bulk-copy-operations"></a><span data-ttu-id="e896a-102">トランザクションとバルク コピー操作</span><span class="sxs-lookup"><span data-stu-id="e896a-102">Transaction and Bulk Copy Operations</span></span>
<span data-ttu-id="e896a-103">バルク コピー操作は、単独の操作として、または、手順が複数あるトランザクションの 1 手順として実行されます。</span><span class="sxs-lookup"><span data-stu-id="e896a-103">Bulk copy operations can be performed as isolated operations or as part of a multiple step transaction.</span></span> <span data-ttu-id="e896a-104">手順が複数あるトランザクションの 1 手順として実行する場合、同一トランザクション内でバルク コピー操作を複数回実行することができます。また、挿入、更新、削除などの他のデータベース操作を実行していても、トランザクション全体をコミットまたはロールバックできます。</span><span class="sxs-lookup"><span data-stu-id="e896a-104">This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.</span></span>  
  
 <span data-ttu-id="e896a-105">既定では、バルク コピー操作は単独の操作として実行されます。</span><span class="sxs-lookup"><span data-stu-id="e896a-105">By default, a bulk copy operation is performed as an isolated operation.</span></span> <span data-ttu-id="e896a-106">このバルク コピー操作は非トランザクション方式で処理され、ロールバックできません。</span><span class="sxs-lookup"><span data-stu-id="e896a-106">The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back.</span></span> <span data-ttu-id="e896a-107">使用することができますをロールバックする一括コピーの一部またはすべてエラーが発生する必要がある場合、 <xref:System.Data.SqlClient.SqlBulkCopy>-トランザクションの管理、既存のトランザクション内でバルク コピー操作を実行またはに参加させる、 **System.Transactions** <xref:System.Transactions.Transaction>.</span><span class="sxs-lookup"><span data-stu-id="e896a-107">If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>.</span></span>  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a><span data-ttu-id="e896a-108">非トランザクション処理のバルク コピー操作の実行</span><span class="sxs-lookup"><span data-stu-id="e896a-108">Performing a Non-transacted Bulk Copy Operation</span></span>  
 <span data-ttu-id="e896a-109">次のコンソール アプリケーションでは、非トランザクション処理のバルク コピー操作で処理中にエラーが検出されたときに、そのエラーの内容を表示します。</span><span class="sxs-lookup"><span data-stu-id="e896a-109">The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.</span></span>  
  
 <span data-ttu-id="e896a-110">例では、ソース テーブルと変換先テーブルが含まれて、`Identity`という名前の列**ProductID**します。</span><span class="sxs-lookup"><span data-stu-id="e896a-110">In the example, the source table and destination table each include an `Identity` column named **ProductID**.</span></span> <span data-ttu-id="e896a-111">コードは、すべての行を削除することによって、変換先テーブルを準備する最初といる行を 1 つを挿入する**ProductID**ソース テーブルに存在しています。</span><span class="sxs-lookup"><span data-stu-id="e896a-111">The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table.</span></span> <span data-ttu-id="e896a-112">既定では、`Identity` 列の新しい値は追加した各行のコピー先のテーブル内で生成されます。</span><span class="sxs-lookup"><span data-stu-id="e896a-112">By default, a new value for the `Identity` column is generated in the destination table for each row added.</span></span> <span data-ttu-id="e896a-113">この例では、代わりに、コピー元のテーブルからの `Identity` 値を使用するバルク ロード処理を強制的に行う接続が開かれている場合、オプションが設定されます。</span><span class="sxs-lookup"><span data-stu-id="e896a-113">In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead.</span></span>  
  
 <span data-ttu-id="e896a-114">このバルク コピー操作は、<xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> プロパティを 10 に設定して実行されます。</span><span class="sxs-lookup"><span data-stu-id="e896a-114">The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10.</span></span> <span data-ttu-id="e896a-115">処理中に無効な行が検出されると、例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="e896a-115">When the operation encounters the invalid row, an exception is thrown.</span></span> <span data-ttu-id="e896a-116">この最初の例では、バルク コピー操作はトランザクション処理ではありません。</span><span class="sxs-lookup"><span data-stu-id="e896a-116">In this first example, the bulk copy operation is non-transacted.</span></span> <span data-ttu-id="e896a-117">エラー発生ポイントまでにコピーされたバッチはすべてコミットされ、重複キーが含まれるバッチはロールバックされます。また、バルク コピー操作は、他のバッチを処理する前に中止されます。</span><span class="sxs-lookup"><span data-stu-id="e896a-117">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e896a-118">このサンプルでは」の説明に従って、作業テーブルを作成していない限りは実行されません[バルク コピー サンプルのセットアップ](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)します。</span><span class="sxs-lookup"><span data-stu-id="e896a-118">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="e896a-119">使用する構文を示すためにこのコードが提供される**SqlBulkCopy**のみです。</span><span class="sxs-lookup"><span data-stu-id="e896a-119">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="e896a-120">簡単かつ迅速に、TRANSACT-SQL を使用して、同じ SQL Server インスタンスには、ソースとレプリケーション先のテーブルが存在する場合は`INSERT … SELECT`ステートメント、データをコピーします。</span><span class="sxs-lookup"><span data-stu-id="e896a-120">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a><span data-ttu-id="e896a-121">トランザクションでの専用のバルク コピー操作の実行</span><span class="sxs-lookup"><span data-stu-id="e896a-121">Performing a Dedicated Bulk Copy Operation in a Transaction</span></span>  
 <span data-ttu-id="e896a-122">既定では、バルク コピー操作は専用のトランザクションで実行されます。</span><span class="sxs-lookup"><span data-stu-id="e896a-122">By default, a bulk copy operation is its own transaction.</span></span> <span data-ttu-id="e896a-123">専用のバルク コピー操作を実行する場合は、接続文字列を使用して <xref:System.Data.SqlClient.SqlBulkCopy> のインスタンスを新しく作成するか、またはアクティブなトランザクションは使用せずに既存の <xref:System.Data.SqlClient.SqlConnection> オブジェクトを使用します。</span><span class="sxs-lookup"><span data-stu-id="e896a-123">When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction.</span></span> <span data-ttu-id="e896a-124">いずれの場合も、バルク コピー操作によってトランザクションを作成し、コミットするかまたはロールバックします。</span><span class="sxs-lookup"><span data-stu-id="e896a-124">In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.</span></span>  
  
 <span data-ttu-id="e896a-125"><xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> クラス コンストラクターの <xref:System.Data.SqlClient.SqlBulkCopy> オプションを明示的に指定することで、バルク コピー操作を専用のトランザクションで実行でき、バルク コピー操作の各バッチを別々のトランザクション内で実行できます。</span><span class="sxs-lookup"><span data-stu-id="e896a-125">You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e896a-126">異なるバッチは別々のトランザクション内で実行されます。このため、バルク コピー操作中にエラーが発生した場合、現在処理中のバッチの行はすべてロールバックされますが、エラーの発生前にバッチでコピーされた行はデータベースに残ります。</span><span class="sxs-lookup"><span data-stu-id="e896a-126">Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.</span></span>  
  
 <span data-ttu-id="e896a-127">次のコンソール アプリケーションは、前の例の 1 つの例外と同様です。この例では、一括コピー操作は、独自のトランザクションを管理します。</span><span class="sxs-lookup"><span data-stu-id="e896a-127">The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions.</span></span> <span data-ttu-id="e896a-128">エラー発生ポイントまでにコピーされたバッチはすべてコミットされ、重複キーが含まれるバッチはロールバックされます。また、バルク コピー操作は、他のバッチを処理する前に中止されます。</span><span class="sxs-lookup"><span data-stu-id="e896a-128">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="e896a-129">このサンプルでは」の説明に従って、作業テーブルを作成していない限りは実行されません[バルク コピー サンプルのセットアップ](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)します。</span><span class="sxs-lookup"><span data-stu-id="e896a-129">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="e896a-130">使用する構文を示すためにこのコードが提供される**SqlBulkCopy**のみです。</span><span class="sxs-lookup"><span data-stu-id="e896a-130">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="e896a-131">簡単かつ迅速に、TRANSACT-SQL を使用して、同じ SQL Server インスタンスには、ソースとレプリケーション先のテーブルが存在する場合は`INSERT … SELECT`ステートメント、データをコピーします。</span><span class="sxs-lookup"><span data-stu-id="e896a-131">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a><span data-ttu-id="e896a-132">既存のトランザクションの使用</span><span class="sxs-lookup"><span data-stu-id="e896a-132">Using Existing Transactions</span></span>  
 <span data-ttu-id="e896a-133">既存の <xref:System.Data.SqlClient.SqlTransaction> コンストラクターの <xref:System.Data.SqlClient.SqlBulkCopy> オブジェクトをパラメーターとして指定できます。</span><span class="sxs-lookup"><span data-stu-id="e896a-133">You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span> <span data-ttu-id="e896a-134">この場合、バルク コピー操作は既存のトランザクションで実行されます。このトランザクションの状態は変更されません (つまり、コミットも中止もされません)。</span><span class="sxs-lookup"><span data-stu-id="e896a-134">In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted).</span></span> <span data-ttu-id="e896a-135">これにより、アプリケーションは他のデータベース操作を行うトランザクションでバルク コピー操作を行うことができます。</span><span class="sxs-lookup"><span data-stu-id="e896a-135">This allows an application to include the bulk copy operation in a transaction with other database operations.</span></span> <span data-ttu-id="e896a-136">ただし、<xref:System.Data.SqlClient.SqlTransaction> オブジェクトを指定しない場合、null 参照を渡した場合、接続にアクティブなトランザクションがある場合は、例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="e896a-136">However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown.</span></span>  
  
 <span data-ttu-id="e896a-137">エラーが発生したためすべてのバルク コピー操作をロールバックする必要がある場合、または、ロールバック可能な大きな処理の一部としてバルク コピー処理を実行する場合、<xref:System.Data.SqlClient.SqlTransaction> オブジェクトを <xref:System.Data.SqlClient.SqlBulkCopy> コンストラクターに指定することができます。</span><span class="sxs-lookup"><span data-stu-id="e896a-137">If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span>  
  
 <span data-ttu-id="e896a-138">次のコンソール アプリケーションは最初の (トランザクションのない) 例とほぼ同じですが、バルク コピー操作がより大きな外部トランザクションに含まれている点が異なります。</span><span class="sxs-lookup"><span data-stu-id="e896a-138">The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction.</span></span> <span data-ttu-id="e896a-139">主キーの違反エラーが発生した場合、トランザクションはすべてロールバックされ、コピー先のテーブルに行は追加されません。</span><span class="sxs-lookup"><span data-stu-id="e896a-139">When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="e896a-140">このサンプルでは」の説明に従って、作業テーブルを作成していない限りは実行されません[バルク コピー サンプルのセットアップ](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)します。</span><span class="sxs-lookup"><span data-stu-id="e896a-140">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="e896a-141">使用する構文を示すためにこのコードが提供される**SqlBulkCopy**のみです。</span><span class="sxs-lookup"><span data-stu-id="e896a-141">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="e896a-142">簡単かつ迅速に、TRANSACT-SQL を使用して、同じ SQL Server インスタンスには、ソースとレプリケーション先のテーブルが存在する場合は`INSERT … SELECT`ステートメント、データをコピーします。</span><span class="sxs-lookup"><span data-stu-id="e896a-142">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a><span data-ttu-id="e896a-143">関連項目</span><span class="sxs-lookup"><span data-stu-id="e896a-143">See also</span></span>

- [<span data-ttu-id="e896a-144">SQL Server でのバルク コピー操作</span><span class="sxs-lookup"><span data-stu-id="e896a-144">Bulk Copy Operations in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/bulk-copy-operations-in-sql-server.md)
- [<span data-ttu-id="e896a-145">ADO.NET のマネージド プロバイダーと DataSet デベロッパー センター</span><span class="sxs-lookup"><span data-stu-id="e896a-145">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
