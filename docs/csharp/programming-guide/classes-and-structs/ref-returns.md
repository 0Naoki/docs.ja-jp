---
title: "ref 戻り値と ref ローカル変数 (C# ガイド)"
description: "ref 戻り値と ref ローカル変数を定義して使用する方法について説明します。"
author: rpetrusha
ms.author: ronpet
ms.date: 05/30/2017
ms.topic: article
ms.prod: .net
ms.technology: devlang-csharp
ms.devlang: csharp
ms.assetid: 18cf7a4b-29f0-4b14-85b8-80af754aabd8
ms.translationtype: HT
ms.sourcegitcommit: 4582cb0ee091526423cce3fc1d8243029f34f59c
ms.openlocfilehash: 3f2ee35db5b77efcce629b6315060a723429b19c
ms.contentlocale: ja-jp
ms.lasthandoff: 08/16/2017

---
# <a name="ref-returns-and-ref-locals"></a>ref 戻り値と ref ローカル変数

C# 7 以降の C# は参照戻り値 (ref 戻り値) に対応しています。 参照戻り値を使用すると、メソッドから呼び出し元に、値ではなく、オブジェクトへの参照を返すことができます。 呼び出し元は、返されたオブジェクトを値渡しとして処理するか、参照渡しとして処理するかを選択できます。 呼び出し元が値ではなく参照として処理する、参照渡しで返された値が ref ローカル変数です。

## <a name="what-is-a-reference-return-value"></a>参照戻り値とは

呼び出されたメソッドに参照によって引数を渡す*参照渡し*は、ほとんどの開発者によく知られています。 呼び出されたメソッドの引数リストに参照によって渡された値が含まれており、呼び出されたメソッドが値に加えた変更が、呼び出し元に返されます。 *参照戻り値*は、その逆です。

- 呼び出されたメソッドに渡された引数ではなく、メソッドの戻り値が参照です。

- 呼び出されたメソッドではなく呼び出し元が、メソッドによって返された値を変更できます。

- 引数への変更が呼び出し元のオブジェクトの状態に反映されるのはなく、呼び出し元がメソッドの戻り値に加えた変更が、メソッドが呼び出されたオブジェクトの状態に反映されます。

参照戻り値を使用すると、コードがよりコンパクトになり、オブジェクトは、呼び出し元が関心のある配列要素のような個々のデータ項目のみを公開できるようになります。 これにより、呼び出し元が誤ってオブジェクトの状態を変更する可能性が低くなります。

メソッドが参照戻り値として返すことができる値には、いくつかの制限があります。 以下に例を示します。

- 戻り値は `void` にできません。 `void` 参照戻り値によるメソッドを定義しようとすると、コンパイラ エラー CS1547 "キーワード void はこのコンテキストで使用できません" が生成されます。
 
- 戻り値は、その戻り値を返すメソッドのローカル変数にすることはできません。戻り値を返すメソッドの外部にスコープが必要です。 クラスのインスタンスまたは静的フィールドを戻り値にすることができます。または、メソッドに渡される引数を戻り値にすることもできます。 ローカル変数を返そうとすると、コンパイラ エラー CS8168 "ローカル変数 'obj' は ref ローカル変数ではないため、参照渡しで返すことはできません" が生成されます。

- 戻り値は `null` にできません。 `null` を返そうとすると、コンパイラ エラー CS8156 "参照渡しで返すことができないため、このコンテキストで使用できない式があります" が生成されます。

   ref 戻り値を持つメソッドで null 値を返す必要がある場合は、参照型の null (インスタンス化されていない) 値を返すか、値型の [null 許容型](../nullable-types/index.md)を返すことができます。
 
- 戻り値は、定数または列挙型のメンバーにすることも、`class` または `struct` のプロパティにすることもできません。 それらのいずれかを返そうとすると、コンパイラ エラー CS8156 "参照渡しで返すことができないため、このコンテキストで使用できない式があります" が生成されます。

さらに、非同期メソッドは、実行が完了する前にまだ戻り値が判明していないときに返される可能性があるため、非同期メソッドでは参照戻り値を使用できません。
 
## <a name="defining-a-ref-return-value"></a>ref 戻り値の定義

戻り値を定義するには、メソッド シグネチャの戻り値の型に [ref](../../language-reference/keywords/ref.md) キーワードを追加します。 たとえば、次のシグネチャは、`GetContactInformation` プロパティが `Person` オブジェクトへの参照を呼び出し元に返すことを示しています。

```csharp
public ref Person GetContactInformation(string fname, string lname);
```

さらに、メソッド本文の各 [return](../../language-reference/keywords/return.md) ステートメントによって返されるオブジェクトの名前の前に、[ref](../../language-reference/keywords/ref.md) キーワードが必要です。 たとえば、次の `return` ステートメントは、`p` という名前の `Person` オブジェクトを参照渡しで返します。

```csharp
return ref p;
```

## <a name="consuming-a-ref-return-value"></a>ref 戻り値の使用

呼び出し元は、2 つの方法のいずれかで ref 戻り値を処理できます。

- メソッドから値渡しで返される通常の値として処理します。 呼び出し元は、戻り値が参照の戻り値であることを無視する選択ができます。 この場合、メソッドの呼び出しによって返される値に加えられた変更は、呼び出された型の状態に反映されません。 戻り値が値型の場合、メソッドの呼び出しによって返される値に加えられた変更は、呼び出された型の状態に反映されません。

- 参照戻り値として処理します。 呼び出し元は、参照戻り値が代入される変数を [ref ローカル変数](#ref-local)として定義する必要があります。それにより、メソッドの呼び出しによって返される値への変更が、呼び出された型の状態に反映されます。 

## <a name="ref-locals"></a>ref ローカル変数

参照戻り値を参照として処理するには、呼び出し元は `ref` キーワードを使用して値を *ref ローカル変数*として宣言する必要があります。 たとえば、`Person.GetContactInfomation` メソッドによって返される値を値ではなく参照として使用する場合、メソッドの呼び出しは次のようになります。

```csharp
ref Person p = ref contacts.GetContactInformation("Brandie", "Best");
```

なお、`ref` キーワードは、ローカル変数宣言の前*および*メソッド呼び出しの前の両方で使用します。 変数宣言と代入の両方の `ref` キーワードを含めないと、コンパイラ エラー CS8172 "値を使用して参照渡し変数を初期化することはできません" が生成されます。 
 
メソッドによって返される `Person` オブジェクトに対する以降の変更は、`contacts` オブジェクトに反映されます。

`p` が `ref` キーワードを使用して ref ローカル変数として定義されていない場合、呼び出し元によって `p` に加えられた変更は、`contacts` オブジェクトに反映されません。
 
## <a name="ref-returns-and-ref-locals-an-example"></a>ref 戻り値と ref ローカル変数: 使用例

次の例では、整数値の配列を格納する `NumberStore` クラスを定義しています。 `FindNumber` メソッドは、引数として渡された数値に等しいかそれより大きい最初の数値を参照渡しで返します。 引数に等しいかそれより大きい数値がない場合、メソッドはインデックス 0 の数値を返します。 

[!CODE-cs[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/ref-returns1.cs#1)]

次の例では、`NumberStore.FindNumber` メソッドを呼び出して、16 に等しいかそれより大きい最初の値を取得します。 呼び出し元は、メソッドによって返された値を 2 倍にします。 この変更は、次の例の出力に示されているように、`NumberStore` インスタンスの配列要素の値に反映されます。

[!CODE-cs[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/ref-returns1.cs#2)]

参照戻り値がサポートされていない場合、このような操作は通常、配列要素のインデックスと値を返すことによって実行されます。 呼び出し元はこのインデックスを使用して、別のメソッド呼び出しで値を変更できます。 一方、インデックスを変更して配列の他の値にアクセスし、変更することも可能です。  
 
## <a name="see-also"></a>関連項目

[ref キーワード](../../language-reference/keywords/ref.md)

