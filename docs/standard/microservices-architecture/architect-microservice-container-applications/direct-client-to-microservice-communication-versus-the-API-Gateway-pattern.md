---
title: クライアントからマイクロサービスへの直接通信に対する API ゲートウェイ パターン
description: コンテナー化された .NET アプリケーションの .NET マイクロサービス アーキテクチャ | クライアントからマイクロサービスへの直接通信に対する API ゲートウェイ パターン
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 10/18/2017
ms.openlocfilehash: 40accd8e881c9667f69a61c98da1d013d28e7da6
ms.sourcegitcommit: 3d5d33f384eeba41b2dff79d096f47ccc8d8f03d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/04/2018
---
# <a name="direct-client-to-microservice-communication-versus-the-api-gateway-pattern"></a>クライアントからマイクロサービスへの直接通信に対する API ゲートウェイ パターン

マイクロサービス アーキテクチャでは、各マイクロサービスは (通常) 細かいエンドポイントのセットを公開します。 このセクションの説明のとおり、このことがクライアントからマイクロサービスへの通信に影響する場合があります。

## <a name="direct-client-to-microservice-communication"></a>クライアントからマイクロサービスへの直接通信

クライアントからマイクロサービスへの直接通信アーキテクチャを使用する方法が考えられます。 この方法では、図 4-12 に示すように、クライアント アプリは一部のマイクロサービスに直接要求することができます。

![](./media/image12.png)

**図 4-12**.  クライアントからマイクロサービスへの直接通信アーキテクチャの使用

この方法では、 各マイクロサービスにパブリック エンドポイントがあり、マイクロサービスごとに異なる TCP ポートがある場合があります。 特定のサービスの URL の例として、Azure での URL を以下に示します。

<http://eshoponcontainers.westus.cloudapp.azure.com:88/>

クラスターに基づく運用環境では、その URL がクラスターで使用されるロード バランサーにマップされ、その後、マイクロサービス全体に要求が分散されます。 運用環境では、マイクロサービスとインターネット間で [Azure Application Gateway](https://docs.microsoft.com/azure/application-gateway/application-gateway-introduction) などのアプリケーション配信コントローラー (ADC) を使用できます。 これは、負荷分散を実行するだけでなく、SSL 終了を提供することにより、サービスをセキュリティで保護する透過層として機能します。 CPU 負荷の高い SSL 終了と他のルーティング作業を Azure Application Gateway にオフロードすることで、ホストの負荷が改善されます。 いずれの場合も、論理アプリケーション アーキテクチャの観点からロード バランサーと ADC は透過的となります。

マイクロサービス ベースの小さなアプリケーションの場合、特にクライアント アプリが ASP.NET MVC アプリなどのサーバー側の Web アプリケーションである場合はクライアントからマイクロサービスへの直接通信アーキテクチャで十分です。 ただし、マイクロサービス ベースの大きい複雑なアプリケーションをビルドする場合 (たとえば、多数の種類のマイクロサービスを処理する場合) と、特にクライアント アプリがリモート モバイル アプリまたは SPA Web アプリケーションである場合、この方法ではいくつかの問題に直面します。

マイクロサービスに基づいて大きなアプリケーションを開発する際には、以下の点を考慮してください。

-   *クライアント アプリではバックエンドへの要求数をどのように最小化し、複数のマイクロサービスへの多数の通信をどのように減らすことができるか*

単一の UI 画面をビルドするために複数のマイクロサービスと対話すると、インターネット経由のラウンドトリップ数が増加します。 これにより、UI 側の待機時間と複雑さが増します。 応答をサーバー側で効率的に集約するのが理想的です。そうすれば、データの複数の部分が並列で返され、一部の UI では準備ができしだいデータを表示できるため、待機時間が短くなります。

-   *承認、データ変換、動的な要求のディスパッチなど、横断的な問題をどのように処理できるか*

すべてのマイクロサービスでのセキュリティと承認などのセキュリティと横断的な問題の実装には、開発作業がかなり必要になる場合があります。 外部からのサービスへの直接アクセスを制限する場合や、API ゲートウェイなどの一元化された場所で横断的な問題を実装する場合に、Docker ホストまたは内部クラスター内にサービスを配置する方法が考えられます。

-   *クライアント アプリは非インターネット対応プロトコルを使用するサービスとどのように通信できるのか*

サーバー側で使用されるプロトコル (AMQP やバイナリ プロトコルなど) は、通常、クライアント アプリではサポートされません。 そのため、要求は HTTP/HTTPS などのプロトコル経由で実行し、その後、他のプロトコルに変換する必要があります。 このような状況では*中間者* 方法が役立つ場合があります。

-   *モバイル アプリ専用のファサードはどのように形成できるのか*

複数のマイクロサービスの API は、さまざまなクライアント アプリケーションのニーズに合わせて適切に設計されていない場合があります。 たとえば、モバイル アプリのニーズは、Web アプリのニーズとは異なる場合があります。 モバイル アプリでは、データ応答をより効率的にできるようにさらに最適化する必要がある場合があります。 この操作は、複数のマイクロサービスからデータを集約し、単一のデータ セットを返し、場合によってはモバイル アプリには必要のない応答内のデータを排除することで行うことがあります。 また、当然ながら、そのデータを圧縮する場合があります。 モバイル アプリとマイクロサービス間の API またはファサードはこのシナリオでも便利な場合があります。

## <a name="using-an-api-gateway"></a>API ゲートウェイの使用

複数のクライアント アプリを持つマイクロサービス ベースの大きく複雑なアプリケーションを設計してビルドする場合、[API ゲートウェイ](https://microservices.io/patterns/apigateway.html)の使用を検討することをお勧めします。 これは、特定のマイクロサービス グループに対して単一のエントリ ポイントを提供するサービスです。 オブジェクト指向設計の[ファサード パターン](https://en.wikipedia.org/wiki/Facade_pattern)に似ていますが、この場合、これは分散システムの一部となります。 API ゲートウェイ パターンは、クライアント アプリのニーズを考えながらビルドするため、"backend for frontend" [(BFF)](https://samnewman.io/patterns/architectural/bff/) と呼ばれることもあります。

図 4-13 には、マイクロサービス ベースのアーキテクチャにカスタム API ゲートウェイをどのように収めるかが示されています。
この図では、複数の異なるクライアント アプリに接続されている単一のカスタム API ゲートウェイ サービスを使用していることに注意してください。 クライアント アプリからの多くのさまざまな要件に基づいて API ゲートウェイ サービスが拡大し、進化するため、このことが重要なリスクになる可能性があります。 最終的に、これらのさまざまなニーズにより肥大化し、実際はモノシリック アプリケーションまたはモノシリック サービスにとてもよく似たものになる可能性があります。 そのため、API ゲートウェイを複数のサービスまたは複数のより小さい API ゲートウェイに分割する (たとえば、フォーム ファクター タイプごとに 1 つずつ) ことを強くお勧めします。

![](./media/image13.png)

**図 4-13**.  カスタム Web API サービスとして実装された API ゲートウェイの使用

この例では、API ゲートウェイは、コンテナーとして実行されるカスタム Web API サービスとして実装されます。

前述のとおり、各クライアント アプリのニーズに合わせて異なるファサードを使用できるように、いくつかの API ゲートウェイを実装する必要があります。 各 API ゲートウェイは、複数の内部マイクロサービスを呼び出す特定のアダプター コードを実装することで場合によってはクライアント フォーム ファクターにも基づいて、クライアント アプリごとに調整された異なる API を提供できます。

カスタム API ゲートウェイは通常、データ アグリゲーターであるため、注意が必要です。 通常は、単一の API ゲートウェイでアプリケーションの内部マイクロサービスをすべて集約することはお勧めできません。 これを行うと、モノシリック アグリゲーターまたはオーケストレーターとして機能し、すべてのマイクロサービスを結合することでマイクロサービスの自律性を侵害することになります。 したがって、API ゲートウェイはビジネス境界に基づいて分離し、アプリケーション全体のアグリゲーターとして機能しないようにする必要があります。

細分化された API ゲートウェイはそれ自体がマイクロサービスである場合があり、ドメインまたはビジネス名と関連データを含む場合もあります。 ビジネスまたはドメインで API ゲートウェイの境界を示すことは、より優れた設計にするのに役立ちます。

API ゲートウェイ層を細分化することは、マイクロサービスに基づくより高度な複合 UI アプリケーションで特に役立つ場合があります。これは、細かい API ゲートウェイの概念が UI コンポジション サービスと似ているためです。 これについては、後述の「[マイクロサービスを基にしている複合 UI を作成する](#creating-composite-ui-based-on-microservices-including-visual-ui-shape-and-layout-generated-by-multiple-microservices)」で説明します。

したがって、多くの中規模および大規模なアプリケーションの場合、通常はカスタム ビルドの API ゲートウェイを使用することをお勧めします。ただし、単一のモノシリック アグリゲーターや一意の中央カスタム API ゲートウェイとしてではありません。

図 4-14 に示すように、[Azure API Management](https://azure.microsoft.com/services/api-management/) などの製品を使用する方法もあります。 この方法は、API ゲートウェイのニーズを解決するだけでなく、API からの洞察を収集するなどの機能を提供します。 API 管理ソリューションを使用している場合、API ゲートウェイはその完全な API 管理ソリューション内の単なるコンポーネントです。

![](./media/image14.png)

**図 4-14**.  API ゲートウェイでの Azure API Management の使用

この場合、Azure API Management などの製品を使用する際に単一の API ゲートウェイを使用することはそれほど危険ではありません。この種の API ゲートウェイは "細かい" ためです。つまり、モノシリック コンポーネントに進化する可能性のあるカスタム C# コードを実装することはありません。 

この種の製品はむしろイングレス通信のリバース プロキシに近い動作をします。この場合、内部マイクロサービスから API をフィルター処理し、さらにこの単一層で公開された API に承認を適用することもできます。

API Management システムから得られる洞察は、API の使用方法と実行方法を理解するのに役立ちます。 これは、ほぼリアルタイムに分析レポートを表示し、ビジネスに影響する可能性のある傾向を識別することで行います。 さらに、オンラインとオフラインの分析のために要求と応答のアクティビティに関するログを使用できます。

Azure API Management では、キー、トークン、および IP フィルタリングを使用して API をセキュリティで保護することができます。 これらの機能では、柔軟な細かいクォータと転送率の制限を適用し、ポリシーを使用して API の形状と動作を変更し、応答キャッシュによりパフォーマンスを向上させることができます。

このガイドと参照用のサンプル アプリケーション (eShopOnContainers) では、Azure API Management などの PaaS 製品を使用せずにプレーン コンテナーに重点を置くため、アーキテクチャをより単純なカスタムのコンテナー化されたアーキテクチャに制限します。 ただし、Microsoft Azure にデプロイされるマイクロサービス ベースの大きなアプリケーションの場合は、API ゲートウェイのベースとして Azure API Management を確認して採用することをお勧めします。

## <a name="drawbacks-of-the-api-gateway-pattern"></a>API ゲートウェイ パターンの欠点

-   最も重要な欠点は、API ゲートウェイを実装する際に、その層を内部マイクロサービスと結合することです。 このような結合は、アプリケーションの重大な問題を発生させる可能性があります。 Clemens Vaster (Azure Service Bus チームのアーキテクト) は、GOTO 2016 の "[Messaging and Microservices](https://www.youtube.com/watch?v=rXi5CLjIQ9k)" (メッセージングとマイクロサービス) セッションでこの潜在的な問題を "新しい ESB" と呼んでいます。

-   マイクロサービス API ゲートウェイを使用すると、単一障害点が増える可能性があります。

-   API ゲートウェイでは、追加のネットワーク呼び出しにより応答時間が増加する可能性があります。 ただし、この追加呼び出しは通常、内部マイクロサービスを直接呼び出す、やり取りが多すぎるクライアント インターフェイスの場合より影響は少なくなります。

-   正しくスケールアウトされていない場合、API ゲートウェイがボトルネックになる可能性があります。

-   API ゲートウェイでは、カスタム ロジックとデータ集計が含まれる場合、追加の開発費と将来のメンテナンスが必要になります。 開発者は、各マイクロ サービスのエンドポイントを公開するために、API ゲートウェイを更新する必要があります。 さらに、内部マイクロサービスでの実装変更により、API ゲートウェイ レベルでのコード変更が発生する可能性があります。 ただし、API ゲートウェイがセキュリティの適用、ログ記録、バージョン管理を行うだけの場合、この追加の開発費は適用されない可能性があります。

-   API ゲートウェイが単一チームによって開発される場合、開発のボトルネックが存在する可能性があります。 これが、さまざまなクライアントのニーズに対応する細かい API ゲートウェイをいくつか使用することをお勧めする理由です。 内部マイクロサービスに取り組むさまざまなチームによって所有されている複数の領域またはレイヤーに API ゲートウェイを内部的に分離することもできます。

## <a name="additional-resources"></a>その他の技術情報

-   **Charles Richardson。パターン: API ゲートウェイ/フロントエンドのバックエンド**
    [*https://microservices.io/patterns/apigateway.html*](https://microservices.io/patterns/apigateway.html)

-   **Azure API Management**
    [*https://azure.microsoft.com/services/api-management/*](https://azure.microsoft.com/services/api-management/)

-   **Udi Dahan。サービス指向のコンポジション**\
    [*http://udidahan.com/2014/07/30/service-oriented-composition-with-video/*](http://udidahan.com/2014/07/30/service-oriented-composition-with-video/)

-   **Clemens Vasters。GOTO 2016 でのメッセージングとマイクロサービス** (ビデオ) [*https://www.youtube.com/watch?v=rXi5CLjIQ9k*](https://www.youtube.com/watch?v=rXi5CLjIQ9k)


>[!div class="step-by-step"]
[前へ] (identify-microservice-domain-model-boundaries.md) [次へ] (communication-in-microservice-architecture.md)
